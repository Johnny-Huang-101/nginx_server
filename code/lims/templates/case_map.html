{% extends "base.html" %}
{% block content %}

<style>
    .bootstrap-select {
        width: 300px !important;
    }
</style>
<head>
    <title>{{config['SYSTEM_NAME']}}/Case Map</title>
</head>
 <div style="margin-top:6px">
    <a href="{{url_for('dashboard.get_dashboard')}}"><i class="fa-solid fa-house"></i></a>
    > PM Case Map
</div>
<hr style="border-width:5px; margin-top:6px">
<h1><i class="fa-solid fa-map-location-dot"></i> PM Case Map</h1>
<hr style="border-width:5px">
 <div class="alert alert-danger mt-3" role="alert">
   <b>NOTE</b>: PM data is only up until <b>{{last_case.date_of_incident.strftime("%m/%d/%Y")}}</b>. Not all cases may be shown due to the listed death address.
 </div>

    <div class="form-group" >
        <form  method="POST">
            <div class="form-group" style="display:inline-block">
                {{form.start_date.label(class='form-group')}}
            </div>
            <div class="form-group" style="display:inline-block">
                {{form.start_date(class='form-control', type='date')}}
            </div>
             <div class="form-group ml-3" style="display:inline-block">
                {{form.end_date.label(class='form-group')}}
            </div>
            <div class="form-group" style="display:inline-block">
                {{form.end_date(class='form-control', type='date')}}
            </div>
            <div class="form-group ml-3" style="display:inline-block">
                {{form.mod.label(class='form-group')}}
            </div>
            <div class="form-group" style="display:inline-block">
                {{form.mod(class='form-control ')}}
            </div>
            <div class="form-group ml-3" style="display:inline-block">
                {{form.component.label(class='form-group')}}
            </div>
            <div class="form-group mr-3" style="display:inline-block">
                <select class="form-control selectpicker" name="component" id="component" filter="true" data-live-search="true" value={{form.component.data}}>
                   {% for option in form.component %}
                        {{ option }}
                    {% endfor %}
                </select>
            </div>
            <strong>-OR-</strong>
             <div class="form-group ml-3" style="display:inline-block">
                {{form.case_number.label(class='form-group')}}
            </div>
            <div class="form-group" style="display:inline-block">
                {{form.case_number(class='form-control')}}
            </div>
            <div class="form-group" style="display:inline-block">
                {{form.submit(class='btn btn-primary')}}
            </div>
        </form>
    </div>
    <p style="color:red">{{error}}</p>
    <div style="text-align: center">
        {{ map|safe }}
    </div>
    <hr style="border-width:5px">
    {% if n_cases != 0 %}
        {% if mod == "" %}
            {% set mod = 'All' %}
        {% endif %}
        {% if case_number != "" %}
            <p><strong>{{case_number}}</strong></p>
        {% elif component_name == 'Any' %}
            <p>{{mod}} cases involving any component between {{start_date}}-{{end_date}}: <strong>{{n_cases}}</strong></p>
        {% else %}
            <p>{{mod}} cases involving {{component_name}} between {{start_date}}-{{end_date}}: <strong>{{n_cases}}</strong></p>
        {% endif %}
    {% endif %}
    <div class="row">
        <div class="table-responsive col">
            <table class="display table-hover table-striped small display nowrap" style="width:100%">
                <thead>
                    <tr>
                        <th>MOD</th>
                        <th>Cases</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mod, counts in counts.items() %}
                        <tr>
                           {% if not mod  %}
                               <td>Not Listed</td>
                           {% else %}
                                 <td>{{mod}}</td>
                           {% endif%}
                            <td>{{counts}}</td>
                        </tr>
                    {% endfor %}
                        <tr>
                            <th>Total</th>
                            <th>{{n_cases}}</th>
                        </tr>
                </tbody>
            </table>
        </div>
         <div class="table-responsive col">
            <table class="display table-hover table-striped small display nowrap" style="width:100%">
                <thead>
                    <tr>
                        <th>Death Premises</th>
                        <th>Cases</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in premises.items() %}
                        <tr>
                           {% if item[0] == "" %}
                               <td>Not Listed</td>
                           {% else %}
                                 <td>{{item[0]}}</td>
                           {% endif%}
                            <td>{{item[1]}}</td>
                        </tr>
                    {% endfor %}
                        <tr>
                            <th>Total</th>
                            <th>{{n_cases}}</th>
                        </tr>
                </tbody>
            </table>
        </div>
</div>
<br>
<div class="row">
        <div class="table-responsive col">
           <h3>Components Detected</h3>
            <table class="display table-hover table-striped small display nowrap" style="width:100%" id="components">
                <thead>
                    <th>Component</th>
                    <th>Cases</th>
                </thead>
                <tbody>
                    {% for item in component_counts.items() %}
                        <tr>
                            <td>{{item[0]}}</td>
                            <td>{{item[1]}}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
</div>
<br>
<br>
<div class="row">
        <div class="table-responsive col">
           <h3>Cases</h3>
            <table class="display table-hover table-striped small display nowrap" style="width:100%" id="cases">
                <thead>
                    <th>Case</th>
                    <th>Case Status</th>
                    <th>Manner of Death</th>
                    <th>COD</th>
                    <th>Case Comments</th>
                </thead>
                <tbody>
                    {% for case in cases %}
                        <tr>
                            <td>
                                <a href="{{url_for('cases.view', item_id=case.id) }}">
                                    {{case.case_number}}
                                </a>
                            </td>
                            <td>{{case.case_status}}</td>
                            <td>{{case.manner_of_death}}</td>
                            <td>{{case.cod_a}}</td>
                            <td>{{case.fa_case_comments}}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
</div>
<br>

<script>
   $(document).ready(function () {

        $('#components thead tr')
            .clone(true)
            .addClass('filters')
            .appendTo('#components thead');

        let table = $('#components').DataTable({
            dom: 'lrtip',
            orderCellsTop: true,
            fixedHeader: true,
            pageLength: 25,
            "aaSorting": [[ 1, "desc" ]],
            initComplete: function () {
                var api = this.api();

                // For each column
                api
                    .columns()
                    .eq(0)
                    .each(function (colIdx) {
                        // Set the header cell to contain the input element
                        let cell = $('.filters th').eq(
                            $(api.column(colIdx).header()).index()
                        );
                        let title = $(cell).text();
                        $(cell).html('<input type="text" placeholder="' + title + '" style="width: 105%; border: 1px solid lightgray; border-radius: 5px;  "/>');

                        // On every keypress in this input
                        $(
                            'input',
                            $('.filters th').eq($(api.column(colIdx).header()).index())
                        )
                            .off('keyup change')
                            .on('change', function (e) {
                                // Get the search value
                                $(this).attr('title', $(this).val());
                                var regexr = '({search})'; //$(this).parents('th').find('select').val();

                                var cursorPosition = this.selectionStart;
                                // Search the column for that value
                                api
                                    .column(colIdx)
                                    .search(
                                        this.value != ''
                                            ? regexr.replace('{search}', '(((' + this.value + ')))')
                                            : '',
                                        this.value != '',
                                        this.value == ''
                                    )
                                    .draw();

                            })
                            .on('keyup', function (e) {
                                e.stopPropagation();

                                $(this).trigger('change');
                                $(this)
                                    .focus()[0]
                                    .setSelectionRange(cursorPosition, cursorPosition);
                            });
                    });
            },
        });
   });
</script>

<script>
   $(document).ready(function () {

        $('#cases thead tr')
            .clone(true)
            .addClass('filters_cases')
            .appendTo('#cases thead');

        let table_cases = $('#cases').DataTable({
            dom: 'lrtip',
            orderCellsTop: true,
            fixedHeader: true,
            pageLength: 100,
            "aaSorting": [[ 0, "desc" ]],
            initComplete: function () {
                let api_cases = this.api();

                // For each column
                api_cases
                    .columns()
                    .eq(0)
                    .each(function (colIdx) {
                        // Set the header cell to contain the input element
                        let cell_cases = $('.filters_cases th').eq(
                            $(api_cases.column(colIdx).header()).index()
                        );
                        let title_cases = $(cell_cases).text();
                        $(cell_cases).html('<input type="text" placeholder="' + title_cases + '" style="width: 105%; border: 1px solid lightgray; border-radius: 5px;  "/>');

                        // On every keypress in this input
                        $(
                            'input',
                            $('.filters_cases th').eq($(api_cases.column(colIdx).header()).index())
                        )
                            .off('keyup change')
                            .on('change', function (e) {
                                // Get the search value
                                $(this).attr('title_cases', $(this).val());
                                var regexr_cases = '({search})'; //$(this).parents('th').find('select').val();

                                var cursorPosition = this.selectionStart;
                                // Search the column for that value
                                api_cases
                                    .column(colIdx)
                                    .search(
                                        this.value != ''
                                            ? regexr_cases.replace('{search}', '(((' + this.value + ')))')
                                            : '',
                                        this.value != '',
                                        this.value == ''
                                    )
                                    .draw();

                            })
                            .on('keyup', function (e) {
                                e.stopPropagation();

                                $(this).trigger('change');
                                $(this)
                                    .focus()[0]
                                    .setSelectionRange(cursorPosition, cursorPosition);
                            });
                    });
            },
        });
   });
</script>



{% endblock %}


{% extends "base.html" %}
{% block content %}


<head>
    <title>{{ config['SYSTEM_NAME'] }}/Drug Prevalence</title>
</head>
<!-- Select2 CSS -->

<!-- Select2 Bootstrap 4 theme -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css" rel="stylesheet" />
<style>
  /* ---- General form polish ---- */
  .form-label { font-weight: 500; }
  .chevron { transition: transform 0.2s ease; }
  .collapse.show .chevron { transform: rotate(90deg); }
  .table thead th { white-space: nowrap; }

  /* ---- Bootstrap-select (for .selectpicker) ---- */
  .selectpicker { width: 100%; } /* no overflow hacks */
  .bootstrap-select { width: 100%; }
  .bootstrap-select .dropdown-toggle { width: 100%; }

  /* Keep menus bounded and non-clickable when closed (prevents ghost clicks) */
  .bootstrap-select .dropdown-menu {
    max-height: 420px;
    overflow-y: auto;
    overflow-x: hidden;
    pointer-events: none;        /* closed state cannot receive clicks */
  }
  .bootstrap-select.show .dropdown-menu {
    pointer-events: auto;        /* clickable only when open */
  }

  /* Optional: make long option labels wrap nicely */
  .bootstrap-select .dropdown-menu li a {
    white-space: normal;
    word-break: break-word;
  }

  /* ---- Select2 (for #component_id) ---- */
  .select2-container { width: 100% !important; }
  .select2-container--bootstrap4 .select2-selection--multiple {
    min-height: 38px;            /* align with .form-control height */
    padding: 0.25rem 0.5rem;
  }

  /* Tag (choice) remove icon style */
  .select2-container--bootstrap4 .select2-selection--multiple .select2-selection__choice__remove {
    border: none;
    background: transparent;
    color: #999;
    padding-right: 4px;
  }
  .select2-container--bootstrap4 .select2-selection--multiple .select2-selection__choice__remove:hover {
    color: #dc3545;              /* subtle red on hover */
    background: transparent;
  }

  /* Keep the Select2 dropdown above nearby controls but not absurdly high */
  .select2-container .select2-dropdown {
    z-index: 1055;               /* > dropdowns in cards, < modal backdrops */
  }

    /* Compact table + smart truncation */
  #cases_table .table-sm th,
  #cases_table .table-sm td { padding: .35rem .5rem; }

  /* Column widths (desktop baseline; remains responsive) */
  #cases col.case-number   { width: 24%; }  /* give this column more breathing room */
  #cases col.case-type     { width: 14%; }
  #cases col.case-date     { width: 12%; }
  #cases col.manner        { width: 14%; }
  #cases col.cod           { width: 16%; }
  #cases col.comments      { width: 20%; }

  /* Truncate long fields nicely */
  .truncate {
    max-width: 100%;
    display: inline-block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    vertical-align: bottom;
  }

  /* Slightly de-emphasize secondary columns */
  #cases tbody td:not(:first-child) { font-size: 0.9rem; }
  /* Make the case number a touch bigger for readability */
  #cases tbody td:first-child a { font-weight: 600; font-size: 1rem; }
</style>


<div class="container-fluid mt-4 px-4">
    <h1 class="text-center mb-4">Drug Prevalence</h1>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="POST">
                <div class="form-row mb-3">
                    <div class="form-group col-md-4">
                        {{ form.discipline.label(class='form-label') }}
                        {{ form.discipline(class='selectpicker form-control', id='form_discipline', data_live_search='true') }}

                    </div>
                    <div class="form-group col-md-4">
                        {{ form.date_type.label(class='form-label') }}
                        {{ form.date_type(class='form-control') }}
                    </div>
                    <div class="form-group col-md-4">
                        {{ form.start_date.label(class='form-label') }}
                        {{ form.start_date(class='form-control', type='date') }}
                    </div>
                    <div class="form-group col-md-4">
                        {{ form.end_date.label(class='form-label') }}
                        {{ form.end_date(class='form-control', type='date') }}
                    </div>
                    <div class="form-group col-md-4">
                        {{ form.date_by.label(class='form-label') }}
                        {{ form.date_by(class='form-control') }}
                    </div>
                    <div class="form-group col-md-4">
                        {{ form.case_type.label(class='form-label') }}
                        {{ form.case_type(class='selectpicker form-control', id='case_type', data_live_search='true', multiple=True) }}
                    </div>
                </div>
                <div class="form-row mb-3">
                    <div class="form-group col-md-6">
                        {{ form.specimen_type.label(class='form-label') }}
                        {{ form.specimen_type(class='selectpicker form-control', id='specimen_type', data_live_search='true', data_actions_box='true', multiple=True) }}
                    </div>
                    <div class="form-group col-md-6">
                        {{ form.drug_class.label(class='form-label') }}
                        {{ form.drug_class(class='selectpicker form-control', id='drug_class') }}
                    </div>
                </div>
                
                <div class="form-row mb-3">
                    <div class="form-group col-md-10">
                        {{ form.component_id.label(class='form-label') }}
                        {{ form.component_id(class='form-control select2', multiple=True) }}
                    </div>
                    <div class="form-group col-md-2" id="and_or_wrapper" style="display: none;">
                        {{ form.and_or.label(class='form-label') }}
                        {{ form.and_or(class='form-control', id='and_or') }}
                    </div>
                </div>
                
                <div class="form-row mb-3">
                    <div class="form-group col-md-4">
                        {{ form.reported_only.label(class='form-label') }}
                        {{ form.reported_only(class='selectpicker form-control', id='reported-only') }}
                    </div>
                    <div class="form-group col-md-4">
                        {{ form.result_status.label(class='form-label') }}
                        {{ form.result_status(
                            class='selectpicker form-control', 
                            id='result_status', 
                            data_live_search='true',
                            disabled='disabled' if form.reported_only.data == 'Yes' else None
                        ) }}
                    </div>
                    <div class="form-group col-md-4">
                        {{ form.color_palette.label(class='form-label') }}
                        {{ form.color_palette(class='form-control', id='color_palette') }}
                    </div>
                </div>
                
                

                <div class="text-center">
                    {{ form.submit(class='btn btn-primary px-4') }}
                </div>
            </form>
        </div>
    </div>

    {% if component_name %}
        <h2 class="text-center my-4">{{ component_name }}</h2>
    {% endif %}

    <div class="card mt-4">
        <div class="card-body" style="padding: 0">
            <div style="width: 100%; overflow-x: auto">
                {{ drug_prevalence_html|safe }}
            </div>
        </div>
    </div>
    <div class="card mt-4">
        <div class="card-body" style="padding: 0">
            <div style="width: 100%; overflow-x: auto">
                {{ fig_specimen_html|safe }}
            </div>
        </div>
    </div>
    {{ fig_conc_html|safe }}

    <!-- Case Types Table -->
    <div class="card mt-4">
        <div class="card-header" id="case_type_heading">
            <h5 class="mb-0">
                <button class="btn btn-link chevron-btn" data-toggle="collapse" data-target="#case_type_table">
                    <i class="fa-solid fa-chevron-right mr-2 chevron"></i> Case Types
                </button>
            </h5>
        </div>
        <div class="collapse" id="case_type_table" aria-labelledby="case_type_heading">
            <div class="card-body table-responsive">
                <table class="table table-striped table-bordered display nowrap" id="case_types" style="width:100%">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Date</th>
                            {% for col in cols %}
                                <th>{{ col }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for item, cols in counts_pivot_dict.items() %}
                            {% set weight = 'bold' if item in ['Total', 'Average', 'Median', 'Min', 'Max'] else 'normal' %}
                            <tr>
                                <td style="font-weight:{{ weight }}">{{ loop.index }}</td>
                                <th style="font-weight:{{ weight }}">{{ item }}</th>
                                {% for col in cols.values() %}
                                    <td style="font-weight:{{ weight }}">{{ col }}</td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Cases Table -->
    <div class="card mt-4">
        <div class="card-header" id="cases_heading">
            <h5 class="mb-0">
                <button class="btn btn-link chevron-btn" data-toggle="collapse" data-target="#cases_table">
                    <i class="fa-solid fa-chevron-right mr-2 chevron"></i> Cases
                </button>
            </h5>
        </div>
        <div class="collapse" id="cases_table" aria-labelledby="cases_heading">
            <div class="card-body table-responsive">
                <table class="table table-striped table-bordered display nowrap" id="cases" style="width:100%">
                    <thead>
                        <tr>
                            <th>Case Number</th>
                            <th>Case Type</th>
                            <th>Case Date</th>
                            <th>Manner of Death</th>
                            <th>COD</th>
                            <th>Case Comments</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for case in cases %}
                            <tr>
                                <td><a href="{{ url_for('cases.view', item_id=case.id) }}" target="_blank">{{ case.case_number }}</a></td>
                                <td>{{ case.case_type }}</td>
                                <td>{{ case.selected_date.strftime('%m/%d/%Y') if case.selected_date else '' }}</td>
                                <td>{{ case.manner_of_death }}</td>
                                <td>{{ case.cod_a }}</td>
                                <td>{{ case.fa_case_comments }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function () {
        $('#component_id').select2({
            theme: 'bootstrap4',
            height: '100%',
            placeholder: 'Select options',
            closeOnSelect: false
        });
    });
    </script>
    

<script>
    function loadSpecimenTypes(discipline) {
        $.ajax({
            url: '/drug_prevalence/get_specimen_types',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ discipline: discipline }),
            success: function (data) {
                console.log("Specimen types received:", data);
                const $specimenSelect = $('#specimen_type');

                // Clear and append new options
                $specimenSelect.empty();
                data.forEach(function (item) {
                    $specimenSelect.append(
                        $('<option></option>').val(String(item.id)).text(item.name)
                    );
                });

                // Refresh Bootstrap-select UI first
                $specimenSelect.selectpicker('refresh');

                // THEN select all (must come after refresh)
                $specimenSelect.selectpicker('val', data.map(item => String(item.id)));
            },
            error: function (xhr, status, error) {
                console.error('Error fetching specimen types:', error);
            }
        });
    }

    $(document).ready(function () {
        // Run on page load using the current value (default is Toxicology)
        const initialDiscipline = $('#form_discipline').val();
        loadSpecimenTypes(initialDiscipline);
        console.log("Initial discipline on load:", initialDiscipline);
        // Re-run on change
        $('#form_discipline').on('change', function () {
            const selected = $(this).val();
            loadSpecimenTypes(selected);
        });
    });


</script>
<script>
    $(document).ready(function () {
        function toggleResultStatus() {
            const isReported = $('#reported-only').val() === 'Yes';
            const $resultStatus = $('#result_status');

            // Disable or enable the native select element
            $resultStatus.prop('disabled', isReported);

            // Force Bootstrap-select to recognize the change
            $resultStatus.selectpicker('refresh').selectpicker('render');
        }

        // Initial load
        toggleResultStatus();

        // On change of the 'Reported Only' dropdown
        $('#reported-only').on('change', function () {
            toggleResultStatus();
        });
    });

</script>
<script>
    function loadComponents(drug_class_id) {
        const $componentSelect = $('#component_id');
        const selectedValues = ($componentSelect.val() || []).map(String); // force to strings
    
        const selectedTextMap = {};
        $componentSelect.find('option:selected').each(function () {
            selectedTextMap[$(this).val()] = $(this).text();
        });
    
        $.ajax({
            url: '/drug_prevalence/get_components',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ drug_class_id }),
            success: function (data) {
                $componentSelect.empty();
    
                // STEP 1: Add unselected items only (force ID to string)
                data.forEach(item => {
                    const idStr = String(item.id);
                    if (!selectedValues.includes(idStr)) {
                        const opt = new Option(item.name, item.id, false, false);
                        $componentSelect.append(opt);
                    }
                });
    
                // STEP 2: Re-add selected items as selected (but not in dropdown)
                selectedValues.forEach(id => {
                    const label = selectedTextMap[id] || `[Unknown: ${id}]`;
                    const opt = new Option(label, id, true, true);
                    $componentSelect.append(opt);
                });
    
                $componentSelect.trigger('change.select2');
            },
            error: function (xhr, status, error) {
                
                console.error('Error fetching components:', error);
            }
        });
    }
    
    

    $(document).ready(function () {
        $('#drug_class').on('change', function () {
            const selectedDrugClass = $(this).val();
            loadComponents(selectedDrugClass);
        });

        // Optionally load components on page load for initial value
        const initialDrugClass = $('#drug_class').val();
        loadComponents(initialDrugClass);
    });
</script>

<script>
    $(document).ready(function () {
        function toggleAndOrField() {
            const selected = $('#component_id').val() || [];
            if (selected.length >= 2) {
                $('#and_or_wrapper').show();
            } else {
                $('#and_or_wrapper').hide();
                $('#and_or').val(''); // clear the field when hidden
            }
        }
    
        $('#component_id').on('change', function () {
            toggleAndOrField();
        });
    
        // Trigger on load in case preselected
        toggleAndOrField();
    });
    
</script>
{% endblock %}

{% block scripts %}

{% endblock %}
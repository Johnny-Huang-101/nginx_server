{% extends "form_template.html" %}
{% block content %}

<style>
  th.sorting {
    cursor: pointer;
    user-select: none;
    position: relative;
    padding-right: 20px; /* space for icon */
  }
  th.sorting .sort-icon {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.8em;
    color: #666;
    user-select: none;
  }
</style>

<style>
  .notes-col {
    min-width: 500px;
    width: 300px;
    max-width: 500px; /* adjust as needed */
    white-space: normal;
    word-break: break-word;
  }
</style>

<style>
  .filter-row input.filter-input {
    width: 100px;
    height: 36px;              /* increase height */
    font-size: 0.95rem;        /* larger font */
    padding: 4px 8px;          /* more padding */
  }

  .notes-col input.filter-input {
    width: 515px;
    height: 36px;
    font-size: 0.95rem;
    padding: 4px 8px;
  }
</style>

<style>
  /* Target all display fields from your JS IDs */
  [id^="display-"] {
    font-size: 0.8rem; /* or something like 12px */
  }
</style>


<!-- Button Row -->
<div class="d-flex justify-content-between align-items-center bg-white py-2 px-3 shadow"
     style="position: fixed; top: 0; left: 0; right: 0; z-index: 1050; border-bottom: 1px solid #ccc;">
     <div>
        <a href="{{ url_for(table_name ~ '.view', item_id=item.id) }}" class="btn btn-secondary mr-2">
            ‚Üê Back to Evidence Storage
        </a>
        <button type="button" class="btn btn-primary mr-2" data-toggle="modal" data-target="#filePathModal">
        Attach Manifest
        </button>
        {% if not read_only%}
        <button type="submit" form="manifest-form" class="btn btn-success">
             <i class="fas fa-save"></i>  Save Changes
        </button>
        {% endif %}
    </div>

    {% if not read_only%}
        <h2>Edit Manifest {{ custody_id }}</h2>
    {% else %}

    <h2>View Manifest {{ custody_id }}</h2>
    {% endif %}

</div>

<!-- Main Save Form -->
<!-- Main Save Form -->
<form id="manifest-form" method="POST" action="{{ url_for(table_name ~ '.save_manifest', item_id=item.id) }}" style="padding-top: 70px;">
    <table id="manifest-table"class="table table-bordered table-sm">
        
        <div class="form-inline mb-2">
        </div>
        <thead>
        <tr>
            {% for header in headers %}
            <th class="sorting {% if header == 'Notes' %}notes-col{% endif %}"
                tabindex="0"
                aria-controls="specimens"
                rowspan="1"
                colspan="1"
                style="width: {% if header == 'Notes' %}300px{% else %}90px{% endif %};"
                aria-label="{{ header }}: activate to sort column ascending"
                data-col-index="{{ loop.index0 }}">
                {{ header }}
            </th>
            {% endfor %}
        </tr>

        <tr class="filter-row">
        {% for header in headers %}
        <th class="{% if header == 'Notes' %}notes-col{% endif %}" style="width: {% if header == 'Notes' %}300px{% else %}90px{% endif %};">
            <input type="text"
                  class="form-control form-control-sm filter-input"
                  data-col="{{ loop.index0 }}"
                  placeholder="{{ header }}">
        </th>
        {% endfor %}
        </tr>
        </thead>


        <tbody>
            {% for row in data_rows %}
                {% set row_index = loop.index0 %}
                <tr>
                    {% for cell in row %}
                    {% set col_index = loop.index0 %}
                    {% set header = headers[col_index] %}

                    <td class="{% if header == 'Notes' %}notes-col{% endif %}">
                    {% if read_only %}
                        {# READ-ONLY MODE: show plain text or links, no inputs or buttons #}
                        {% if header in ['Personnel A', 'Personnel B'] %}
                            {{ cell }}
                        {% elif header == 'Notes' %}
                            {{ cell }}
                        {% elif header == 'Case Number' and cell %}
                            <a href="{{ url_for(table_name + '.redirect_by_case_num', case_num=cell) }}" target="_blank">{{ cell }}</a>
                        {% else %}
                            {{ cell }}
                        {% endif %}
                    {% else %}
                        {# EDIT MODE: inputs, buttons, etc. #}
                        {% if header in ['Personnel A', 'Personnel B'] %}
                            <input type="hidden" name="row-{{ row_index }}-col-{{ col_index }}" id="input-{{ row_index }}-{{ col_index }}" value="{{ cell }}" />
                            <span id="display-{{ row_index }}-{{ col_index }}">
                            {% if cell %}{{ cell }}{% endif %}
                            </span>
                            <a href="javascript:void(0);" class="btn btn-link btn-sm p-0" id="verify-btn-{{ row_index }}-{{ col_index }}"
                            style="{% if cell %}display: none;{% endif %}"
                            onclick="setPersonnel({{ row_index }}, {{ col_index }}, event)">
                            Verify
                            </a>
                            <a href="javascript:void(0);" class="btn btn-link btn-sm p-0 text-danger"
                            id="clear-btn-{{ row_index }}-{{ col_index }}"
                            style="{% if not cell %}display: none;{% endif %}"
                            onclick="clearPersonnel({{ row_index }}, {{ col_index }})">
                            Clear
                            </a>
                        {% elif header == 'Notes' %}
                            <textarea name="row-{{ row_index }}-col-{{ col_index }}" rows="1" class="form-control form-control-sm auto-expand">{{ cell }}</textarea>
                        {% elif header == 'Case Number' and cell %}
                            <a href="{{ url_for(table_name + '.redirect_by_case_num', case_num=cell) }}" target="_blank">{{ cell }}</a>
                            <input type="hidden" name="row-{{ row_index }}-col-{{ col_index }}" value="{{ cell }}" />
                        {% else %}
                            {{ cell }}
                            <input type="hidden" name="row-{{ row_index }}-col-{{ col_index }}" value="{{ cell }}"/>
                        {% endif %}
                    {% endif %}
                    </td>
                {% endfor %}
                </tr>
            {% endfor %}
        </tbody>

    <input type="hidden" name="num_rows" value="{{ data_rows|length }}">
    <input type="hidden" name="num_cols" value="{{ headers|length }}">
</form>



<div class="modal fade" id="filePathModal" tabindex="-1" aria-labelledby="filePathModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="filePathForm" method="GET" action="{{ url_for(table_name + '.attach', item_id=item.id) }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Attach Manifest</h5>
          <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

          <!-- Always pass default file_path -->
          <input type="hidden" name="folderpath" id="folderpath" value="{{ folder }}">

          <input type="hidden" name="file_path" id="filepath" value="{{ filename }}">
          <!-- User chooses pdf_path -->
          <div class="mb-3">
            <label for="pdfPathInput" class="form-label">PDF Path</label>
            <div class="input-group">
              <input type="text" class="form-control" id="pdfPathInput" name="pdf_path" value="{{ filename }}" required>
              <span class="input-group-text">.pdf</span>
            </div>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Attach</button>
        </div>
      </div>
    </form>
  </div>
</div>


<script>
document.getElementById('filePathForm').addEventListener('submit', function (e) {
    e.preventDefault(); // Stop default form submission

    // Folder path (from hidden input)

    const filename = document.getElementById('filepath').value
    const folderPath = document.getElementById('folderpath').value;

    // User-specified filename (without extension)
    const pdfName = document.getElementById('pdfPathInput').value;

    // Build full paths
    const csvFullPath = folderPath + "\\" + filename + ".csv";
    const pdfFullPath = folderPath + "\\" + pdfName + ".csv";

    // Build new URL with full paths
    const baseUrl = this.getAttribute('action');
    const url = new URL(baseUrl, window.location.origin);
    url.searchParams.set('file_path', csvFullPath);  // actual CSV full path
    url.searchParams.set('pdf_path', pdfFullPath);   // actual PDF full path

    // Redirect with both query params
    window.location.href = url.toString();
});
</script>



<!-- scripts -->
<script>
  function setPersonnel(row, col, event) {
    event.preventDefault();

    const initials = "{{ initials }}";

    // Format date as YYYY-MM-DD HH:mm
    const d = new Date();
    const now = d.getFullYear() + '-' +
                String(d.getMonth() + 1).padStart(2, '0') + '-' +
                String(d.getDate()).padStart(2, '0') + ' ' +
                String(d.getHours()).padStart(2, '0') + ':' +
                String(d.getMinutes()).padStart(2, '0');

    const value = `${initials} | ${now}`;

    const input = document.getElementById(`input-${row}-${col}`);
    const display = document.getElementById(`display-${row}-${col}`);
    const clearBtn = document.getElementById(`clear-btn-${row}-${col}`);

    if (input) input.value = value;
    if (display) display.textContent = value;

    if (event.target) event.target.style.display = 'none';
    if (clearBtn) clearBtn.style.display = 'inline';
  }

  function clearPersonnel(rowIndex, colIndex) {
    const inputId = `input-${rowIndex}-${colIndex}`;
    const displayId = `display-${rowIndex}-${colIndex}`;
    const verifyBtnId = `verify-btn-${rowIndex}-${colIndex}`;
    const clearBtnId = `clear-btn-${rowIndex}-${colIndex}`;

    const inputElem = document.getElementById(inputId);
    const displayElem = document.getElementById(displayId);
    const verifyBtn = document.getElementById(verifyBtnId);
    const clearBtn = document.getElementById(clearBtnId);

    if (inputElem) inputElem.value = '';
    if (displayElem) displayElem.textContent = '';
    if (verifyBtn) verifyBtn.style.display = 'inline';
    if (clearBtn) clearBtn.style.display = 'none';
  }
</script>


<script>
  $(document).ready(function() {
    $('#manifest-table').DataTable({
      // Optional configs
      paging: false,     // disable pagination if you want, or true if preferred
      searching: false,  // disable search if you want, or true if preferred
      
      // Define how to extract the sorting data for each column
      columnDefs: [
        {
          targets: [7,8],
          orderDataType: 'dom-text',
        }
      ],
      orderCellsTop: true,       // allow multiple header rows
        fixedHeader: true         // optional
    });

    // Custom ordering plugin for sorting by text inside an element (like span) ignoring hidden inputs
    $.fn.dataTable.ext.order['dom-text'] = function  ( settings, col ) {
      return this.api().column( col, {order:'index'} ).nodes().map( function ( td, i ) {
        // get text from span inside td (ignore hidden inputs)
        return $(td).find('span').text().toLowerCase();
      } );
    };
  });
</script>




<script>
document.addEventListener('DOMContentLoaded', function () {
    const table = document.getElementById('manifest-table');
    const filterInputs = table.querySelectorAll('.filter-input');
    const rows = table.querySelectorAll('tbody tr');

    filterInputs.forEach(input => {
        input.addEventListener('input', function () {
            const filters = Array.from(filterInputs).map(input => ({
                col: parseInt(input.dataset.col),
                value: input.value.toLowerCase()
            }));

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const match = filters.every(f => {
                    const cell = cells[f.col];
                    return cell && cell.textContent.toLowerCase().includes(f.value);
                });
                row.style.display = match ? '' : 'none';
            });
        });
    });
});
</script>


{% endblock %}

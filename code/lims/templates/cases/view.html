{% extends "view_template.html" %}

{% block style %}
    .alert-warning {
        background-color: rgb(221, 204, 238);
        color: black;
        border-color: #8b53e6
    }
.table-container {
        display: flex;
    }
    .table-column {
        flex: 1;
        margin: 0 5px;
    }
    .table-bordered th, .table-bordered td {
        border: 1px solid #dddddd !important;
        vertical-align: top;
        padding: 4px;
        font-size: 12px;
    }
    .link {
        color: blue;
        text-decoration: underline;
        cursor: pointer;
    }
    .custom-container {
        display: flex;
        width: 100%;
        gap: 10px;
    }
    .custom-column {
        flex: 1;
    }
    .custom-table {
        width: 100%;
        border-collapse: collapse;
    }
    .custom-table td, .custom-table th {
        border: 1px solid #dddddd;
        text-align: left;
        padding: 8px;
    }
    .custom-table th {
        background-color: #f2f2f2;
        white-space: nowrap;
    }
    .custom-link {
        color: blue;
        text-decoration: underline;
        cursor: pointer;
    }
    .btn-link {
        font-size: 24px
        }

    #header {
        position: fixed;
        width: 90%;
    }

    #body{
        overflow: auto;
    }


    .expanded-content {
        height: auto !important;
        max-height: none !important;
        overflow: visible !important;
    }
@media print {
        body * {
            visibility: hidden;
        }
        #all-content, #all-content * {
            visibility: visible;
        }
        #all-content {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }
    }
/* Lighter, readable-safe backdrop blur */
.restrict-overlay {
  position: fixed;
  inset: 0;
  z-index: 2147483647;
  background: rgba(0,0,0,0.50); /* dim but not opaque */
  backdrop-filter: blur(12px) saturate(0.9) brightness(0.85);
  -webkit-backdrop-filter: blur(12px) saturate(0.9) brightness(0.85);
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Dialog */
.restrict-modal-box {
  background: #fff;
  border-radius: 14px;
  padding: 24px 22px;
  width: min(92vw, 520px);
  box-shadow: 0 10px 40px rgba(0,0,0,0.35);
  text-align: center;
}

.restrict-modal-box h3 { margin: 0 0 .5rem 0; font-weight: 700; }
.restrict-modal-box p  { margin: 0 0 1rem 0; color: #333; }

.restrict-actions { margin-top: .5rem; }
.restrict-exit { display:inline-block; background:#111; color:#fff!important; padding:10px 16px; border-radius:10px; text-decoration:none; font-weight:600; letter-spacing:.2px; }


/* Actions */
.restrict-actions {
  margin-top: .5rem;
}

.restrict-exit {
  display: inline-block;
  background: #111;
  color: #fff !important;
  padding: 10px 16px;
  border-radius: 10px;
  text-decoration: none;
  font-weight: 600;
  letter-spacing: .2px;
}

/* Prevent accidental text selection flicker behind the blur */
.restrict-overlay, .restrict-modal-box, .restrict-modal-box * {
  user-select: text;
}
    
/* used for orange highlighting of unusual results */
.flag-mismatch {
    color: #bd6800;          
  }

{% endblock %}
    <!--  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>-->
    <!--    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>-->
    <!--    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>-->

    <!--    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>-->
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>-->
    <!--<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>-->


{% block alerts %}
{% if item.communications %}
<div class="alert alert-warning" role="alert" style="margin-top:6px">
    {{ item.communications | replace('\n', '<br>') | safe }}
</div>

{% endif %}
    {% if kwargs['all_pending_containers'].count() or kwargs['all_pending_specimens'].count() %}
        <div class="alert alert-primary" role="alert" style="margin-top: 12px">
            <button type="button" class="close" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            {% if kwargs['review_discipline'] %}
                The following <b>{{kwargs['review_discipline']}}</b> items are currently pending review:
            {% else %}
                The following items for <b>All disciplines</b> are currently pending review:
            {% endif %}
            {% if kwargs['all_pending_containers'].count() %}
                <div class="mt-2 ml-3">
                    <b>Containers</b>
                    <ul>
                        {% for cont in kwargs['all_pending_containers'] %}
                        <li>{{cont.accession_number}} - [{{cont.type.code}}] ({{cont.type.name}}) </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
            {% if kwargs['all_pending_specimens'].count() %}
                <div class="mt-2 ml-3">
                    <b>Specimens</b>
                    <ul>
                        {% for spec in kwargs['all_pending_specimens'] %}
                        <li>{{spec.accession_number}} - [{{spec.type.code}}] ({{spec.type.name}}) </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
        </div>
    {% endif %}
{% endblock %}


{% block title %}
    {{item.case_number}} | {{item.last_name}} | {{item.first_name}}
{% endblock %}

{% block header_class %}
    view-header
{% endblock %}
{% block header %}

<script>
    // Suppress all DataTables error popups
    $.fn.dataTable.ext.errMode = 'none';

    $(document).ready(function () {
        $('#narratives_table').DataTable();
    });
</script>

<div class="row">
    <div class="col">
    <h1 class="mb-0">
        {{item.case_number}} |
        <a href="#" class="text-decoration-none t-tip form-item" data-html="true" data-toggle="tooltip" data-placement="bottom" id="last_name" title="{{mod_tooltips['last_name']}}">{{item.last_name}}</a>
        <a href="#" class="text-decoration-none t-tip form-item" data-html="true" data-toggle="tooltip" data-placement="bottom" id="first_name" title="{{mod_tooltips['first_name']}}">{{item.first_name}}</a>
        {% if item.middle_name %}
        <a href="#" class="text-decoration-none t-tip form-item" data-html="true" data-toggle="tooltip" data-placement="bottom" id="middle_name" title="{{mod_tooltips['middle_name']}}">{{item.middle_name}}</a>
        {% endif %}
        |
        {{item.case_status}}<a href="#!" data-html="true" data-toggle="tooltip"
           title="
                <ul>
                    <li><b>None</b> - Case has been added but no containers or specimens have been accessioned.</li>
                    <li><b>No Testing Requested</b> - No testing has been requested for this case.</li>
                    <li><b>Needs Test Addition</b> - Specimens have been added and one or multiple requested testing disciplines need test additions.</li>
                    <li><b>Queued</b> - All disciplines have tests assigned (i.e. all discipline statuses = 'Initiated').</li>
                    <li><b>In Progress</b> - Any discipline statuses = Testing, but no status = 'No Tests Added'.</li>
                    <li><b>Closed</b> - All discipline statuses = 'Disseminated'.</li>
                </ul>
            "><i class="fa-solid fa-circle-question vertical-center" style="font-size:22px"></i>
        </a>
    </h1>
    </div>
    {% if item.priority == 'High' %}
        <div class="col-md-2 mb-0" align="right" style="font-size:42px; font-family: 'Copperplate', Fantasy; color:red;">
            PRIORITY
        </div>
    {% endif %}
    {% if item.sensitivity == 'Restricted' %}
        <div class="col-md-2 mb-0" align="right" style="font-size:42px; font-family: 'Copperplate', Fantasy; color:red;">
            RESTRICTED
        </div>
    {% endif %}

 </div>
{% endblock %}

{% block buttons %}
    {% set new_item_button %}
        <div class="dropdown" style="display:inline-block">
            {% if current_user.permissions in ['Admin', 'Owner', 'FLD'] %}
                <div class="dropdown" style="display: inline-block;">
                    <button aria-expanded="false" aria-haspopup="true" class="btn btn-secondary dropdown-toggle mb-3"
                            data-toggle="dropdown" style="background-color: black; border-color: black;"
                            id="results-filter" type="button">Discipline {% if kwargs['discipline'] %} | {{ kwargs['discipline'] }} {% endif %}
                    </button>
                    <div class="dropdown-menu" aria-labelledby="cases-filter">
                        {% for option in kwargs['disciplines'] %}
                        <a href="{{ url_for('cases.view', item_id=item.id, discipline=option)}}" class="dropdown-item">{{ option }}</a>
                        {% endfor %}
                        <a href="{{ url_for('cases.view', item_id=item.id)}}" class="dropdown-item">All</a>
                    </div>
                </div>
            {% endif %}

            {% if current_user.permissions not in ['FLD-Administrative', 'FLD-MethodDevelopment', 'ADM-Management', 'ADM', 'Developer', 'MED-Autopsy', 'MED'] %}
                <div class="dropdown" style="display:inline-block">
                    <button class="btn btn-success dropdown-toggle mb-3" type="button" id="dropdownMenu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fa-solid fa-circle-plus"></i> New
                    </button>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="{{ url_for('containers.add', case_id=item.id) }}">Container</a>
                        {% if kwargs['containers'].all() | length > 0 %}
                        <a class="dropdown-item" href="{{ url_for('specimens.add', case_id=item.id) }}">Specimen</a>
                        {% endif %}
                        {% if current_user.permissions in ['Admin', 'Owner', 'FLD'] %}
                        {% if kwargs['specimens'].all() | length > 0 %}
                        <a class="dropdown-item" href="{{ url_for('tests.add', case_id=item.id) }}">Test</a>
                        {% endif %}
                        {% endif %}
                        {% if current_user.permissions in ['Admin', 'Owner', 'FLD'] %}
                        {% if kwargs['tests'] | length > 0 %}
                        <a class="dropdown-item" href="{{ url_for('results.add', case_id=item.id) }}">Result</a>
                        {% endif %}
                        {% endif %}
                        {% if kwargs['results'].all() | length > 0 %}
                        {% if current_user.permissions not in ['INV'] %}
                        <a class="dropdown-item" href="{{ url_for('reports.add', item_id=item.id, discipline='Toxicology') }}">Report</a>
                        <a class="dropdown-item" href="{{ url_for('records.add', item_id=item.id) }}">Record</a>
                        <a class="dropdown-item" href="{{ url_for('bookings.add', case_id=item.id) }}">Booking</a>
                        {% endif %}
                        {% endif %}
                        {% if current_user.permissions in ['Admin', 'FLD', 'FLD-Administrative', 'Owner'] %}
                        <a class="dropdown-item" href="/cases/{{item.id}}/litigation_packet_creation">Packet</a>
                        {% endif %}
                        {% if current_user.permissions in ['Admin', 'Owner'] %}
                        <a class="dropdown-item" href="/cases/{{item.id}}/gen_decedent_report">Decedent Report</a>
                        <a class="dropdown-item" href="/cases/{{item.id}}/gen_decedent_report_draft">Decedent Report Draft</a>
                        {% endif %}
                    </div>
                    {% if current_user.permissions in ['Admin', 'Owner', 'FLD'] %}
                    <a class="btn btn-secondary mb-3" href="{{ url_for(table_name~'.attach', item_id=item.id) }}"><i class="fa-solid fa-paperclip"></i> Attach</a>
                    {% endif %}
                    <a class="btn btn-secondary mb-3" href="{{ url_for(table_name~'.export_records', item_id=item.id) }}"> Export Case Records</a>
                    {% if current_user.permissions in ['Admin', 'Owner'] %}
                    <a class="btn btn-primary mb-3" href="{{url_for(table_name~'.update_retention_policy', item_id=item.id)}}">Update Retention Policy</a>
                    {% endif %}
                </div>
                {% elif current_user.permissions in ['Admin', 'Owner', 'FLD', 'FLD-Administrative'] %}
                    <a class="btn btn-secondary mb-3" href="{{ url_for(table_name~'.attach', item_id=item.id) }}"><i class="fa-solid fa-paperclip"></i> Attach</a>
                {% endif %}
            <form id="filterForm" method="POST" action="/filter_data">
                <input type="hidden" id="selectedDiscipline" name="discipline">
            </form>
        </div>
    {% endset %}
                {% if current_user.permissions == 'ADM-Management' %}
                <div class="dropdown" style="display:inline-block">
                    <button class="btn btn-success dropdown-toggle mb-3" type="button" id="dropdownMenu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fa-solid fa-circle-plus"></i> New
                    </button>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="/cases/{{item.id}}/gen_decedent_report_draft">Decedent Report Draft</a>
                    </div>
                </div>
            {% endif %}
    {% if item.db_status not in ['Deletion Pending', 'Removed'] %}
    
        {% if not view_only %}
            {% if item.locked and item.locked_by != current_user.initials %}
                <a class="btn btn-primary mb-3" href="#" ><i class="fa-solid fa-lock"></i> {{item.locked_by}}</a>
            {% elif item.locked_by == current_user.initials %}
                {{new_item_button}}
                {% if item.pending_submitter %}
                    <div class="btn-group mb-3">
                        {% if kwargs['case_approved'] %}
                            <a class="btn btn-primary disabled" href="#">Case Approved <i class="bi bi-check-circle"></i></a>
                        {% else %}
                            {% if item.pending_submitter == current_user.initials %}
                                <a class="btn btn-primary" href="{{ url_for(table_name~'.edit', item_id=item.id) }}">Edit Case</a>
                            {% else %}
                                 <a class="btn btn-primary" href="{{ url_for(table_name~'.approve', item_id=item.id) }}">Review Case</a>
                            {% endif %}
                        {% endif %}
                            {% if kwargs['pending_containers'].count() or kwargs['pending_specimens'].count() %}
                                <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span class="sr-only">Toggle Dropdown</span>
                                </button>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item" href="#" data-toggle="modal" data-target="#approve-select">Approve select items</a>
                                    <a class="dropdown-item" href="#"  data-toggle="modal" data-target="#approve-all">Approve All</a>
                                </div>
                            {% endif %}
                    </div>
                {% else %}
                    <a class="btn btn-primary mb-3" style="display:inline-block" href="{{ url_for('cases.update', item_id = item.id)}}" role="button">Update</a>
                {% endif %}
                {% if kwargs['specimens_in_custody'] | count == 0 %}
                    <a class="btn btn-primary mb-3" href="{{url_for(table_name~'.unlock', item_id=item.id)}}" ><i class="fa-solid fa-unlock"></i> Unlock</a>
                {% else %}
                    <a class="btn btn-primary mb-3" href="#" data-toggle="modal" data-target="#specimen_audit"><i class="fa-solid fa-unlock"></i> Unlock</a>
                {% endif %}
            {% elif kwargs['add_new'] %}
                <a class="btn btn-primary mb-3" style="display:inline-block" href="{{ url_for('cases.update', item_id = item.id)}}" role="button">Update</a>
                {{new_item_button}}
            {% else %}
                {% if item.db_status in ['Active', 'Active with pending changes'] %}
                    {% if current_user.permissions in ['Admin', 'FLD', 'Owner'] %}
                        <a class="btn btn-primary mb-3" style="display:inline-block" href="{{ url_for('cases.update', item_id = item.id)}}" role="button">Update</a>
                    {% endif %}
                    {{new_item_button}}
                    {% if item.locked != True and current_user.permissions in ['Admin', 'Owner'] %}
                        <a class="btn btn-danger mb-3" href="{{ url_for(table_name~'.lock', item_id=item.id) }}"><i class="fa-solid fa-lock"></i> Lock</a>
                    {% endif %}
                {% endif %}
            {% endif %}
            {% if current_user.permissions != 'ADM-Management' %}
            <a class="btn btn-danger mb-3" data-toggle="modal" data-target="#remove-modal">Remove</a>
            {% endif %}
            {% if current_user.permissions in ['Admin', 'Owner'] and item.remove_reason %}
                {% if item.db_status == 'Removed' %}
                    <a class="btn btn-secondary mb-3" href="{{ url_for(table_name~'.restore', item_id=item.id) }}">Restore</a>
                {% elif current_user.initials != item.modified_by %}
                    <a class="btn btn-success mb-3" href="{{ url_for(table_name~'.approve_remove', item_id=item.id) }}">Approve Removal</a>
                    <a class="btn btn-danger mb-3" href="{{ url_for(table_name~'.reject_remove', item_id=item.id) }}">Reject Removal</a>
                {% endif %}
            {% endif %}
            {% if current_user.permissions not in ['MED-Autopsy', 'MED', 'ADM-Management', 'ADM', 'INV'] %}
                <a class="btn btn-secondary mb-3" href="{{url_for(table_name~'.communications', item_id=item.id)}}">
                    Add Communication
                </a>
                <a class="btn btn-secondary mb-3" href="{{ url_for('comment_instances.add', comment_item_type='Cases', comment_item_id = item.id, redirect_url=url_for('cases.view', item_id=item.id))}}">Add Comment</a>
            {% endif %}
            <hr style="border-width:5px">
        {% else %}
            {% if kwargs['add_new'] %}
                {{new_item_button}}
            {% endif %}
            {% if current_user.permissions in ['Admin', 'Owner'] %}
                <a class="btn btn-primary mb-3" href="#" data-toggle="modal" data-target="#specimen_audit"><i class="fa-solid fa-unlock"></i> Unlock</a>
            {% endif %}
            {% if current_user.permissions not in ['MED-Autopsy', 'MED', 'ADM-Management', 'ADM', 'INV'] %}
                <a class="btn btn-secondary mb-3" href="{{ url_for('comment_instances.add', comment_item_type='Cases', comment_item_id = item.id, redirect_url=url_for('cases.view', item_id=item.id))}}">Add Comment</a>
                <a class="btn btn-secondary mb-3" href="{{url_for(table_name~'.communications', item_id=item.id)}}">
                    Add Communication
                </a>
            {% endif %}
        {% endif %}
        
    {% endif %}
{% endblock %}
{% block view %}
{% set _must_block_case = (item.sensitivity == 'Restricted') 
    and (item.cod_a is string) 
    and (item.cod_a | trim | length > 0) 
    and ((item.cod_a | trim | upper) != 'PENDING') %}
    {% if current_user.permissions in ['ADM'] %}
        <a class="btn btn-success" href="/cases/{{item.id}}/gen_decedent_report_draft">Decedent Report Draft</a>
    {% endif %}
{% if current_user.permissions not in ['FLD-Administrative', 'FLD-MethodDevelopment', 'ADM-Management', 'Developer'] %}
    <hr style="border-width:5px">
{% endif %}
    <div class="col mb-3">
        <table class="table-hover table-striped nowrap" style="width:100%">
            <thead>
            <tr>
                <th></th>
                <th>Requested</th>
                <th>Performed</th>
                <th>
                    Status
                    <a href="#!" class="text-decoration-none" data-html="true" data-toggle="tooltip"
                       title="
                            <ul>
                                <li><b>Initiated</b> - Test(s) have been added for this discipline.</li>
                                <li><b>Testing</b> - Test(s) have been added to a batch.</li>
                                <li><b>Drafting</b> - Report is currently being drafted.</li>
                                <li><b>CR</b> - Report needs CR.</li>
                                <li><b>DR</b> - Report needs DR.</li>
                                <li><b>Disseminated</b> - Report has been disseminated.</li>
                            </ul>
                        "><i class="fa-solid fa-circle-question" style="font-size:16px"></i></a>
                </th>
                <th>Start Date</th>
                <th>Alternate Start Date</th>
                <th>Dissemination Date</th>
                <th>Days Since Submission (DSS)/Turnaround Time (TAT)</th>
            </tr>
            </thead>
            <tbody>
            {% for discipline in kwargs['disciplines'] %}
            {% set disc_lower = discipline.lower() %}
                <tr>
                <tr class="form-item" id="testing_requested">
                    <th style="height: 0.5rem">{{discipline}}</th>
                    <td>
                        {% if item | hasattr(disc_lower+'_requested') %}
                        <a href="#" class="text-decoration-none t-tip" data-html="true" data-toggle="tooltip" data-placement="bottom" title="{{mod_tooltips['testing_requested']}}">
                            {{item | getattr(disc_lower+'_requested')}}
                        </a>
                        {% endif %}
                    </td>
                    <td>
                        {% if item | hasattr(disc_lower+'_performed') %}
                            {% set discipline_performed = item | getattr(disc_lower+'_performed') %}
                            {% if discipline_performed %}
                                {{discipline_performed}}
                            {% endif %}
                        {% endif %}
                    </td>
                    <td>
                        {% if item | hasattr(disc_lower+'_status') %}
                            {% set discipline_status = item | getattr(disc_lower+'_status') %}
                            {% if discipline_status %}
                                {{discipline_status}}
                            {% endif %}
                        {% endif %}
                    </td>
                    <td>
                        {% if item | hasattr(disc_lower+'_start_date') %}
                            {% if item | getattr(disc_lower+'_start_date') %}
                                {% set start_date = item | getattr(disc_lower+'_start_date') %}
                                {{start_date.strftime('%m/%d/%Y %H:%M')}}
                            {% endif %}
                        {% endif %}
                    </td>
           <td>
            {% if item | hasattr(disc_lower ~ '_alternate_start_date') %}
                {% set alt_date = item | getattr(disc_lower ~ '_alternate_start_date') %}
                
                {% if alt_date %}
                {{ alt_date.strftime('%m/%d/%Y %H:%M') }}  <a href="#"
                    data-toggle="modal"
                    data-target="#edit-{{ disc_lower }}-modal"
                    class="text-primary small align-baseline"
                    style="text-decoration: none;">
                    Edit
                    </a>
                {% else %}
                {% if current_user.permissions in ['Admin', 'Owner'] %}
                    <a href="#"
                    data-toggle="modal"
                    data-target="#edit-{{ disc_lower }}-modal"
                    class="text-primary small align-baseline"
                    style="text-decoration: none;">
                    Edit
                    </a>
                {% endif %}
                {% endif %}
            {% endif %}
            </td>

                <td>
                    {% if item | hasattr(disc_lower ~ '_end_date') %}
                        {% set end_date = item | getattr(disc_lower ~ '_end_date') %}
                        {% if end_date %}
                            {{ end_date.strftime('%m/%d/%Y') }}
                        {% endif %}
                    {% endif %}
                </td>
                <td>{{kwargs[disc_lower+'_time']}}</td>
                </tr>
            {% endfor %}
            <tr class="form-item" name="submitter_requests">
                <th>Submitter Requests</th>
                <td colspan=7 ><a href="#" class="text-decoration-none t-tip" data-html="true" data-toggle="tooltip" data-placement="bottom" title="{{mod_tooltips['submitter_requests']}}">{{item.submitter_requests}}</a></td>
            </tr>
            </tbody>
        </table>
    </div>
    <hr style="border-width:5px">
{% endblock %}

{% block accordion %}
        <div class="card">
            <div class="card-header view-card-header" id="case-details">
                <button class="btn btn-link chevron-btn" style="font-size:20px" data-toggle="collapse" data-target="#case-details-collapse" aria-expanded="false" aria-controls="case-details">
                    <span><i class="fa-solid fa-chevron-down mr-2 chevron" style="border: '#FF0000'"></i></span>
                    Case Details
                </button>
            </div>
            <div id="case-details-collapse" class="collapse show" aria-labelledby="case-details-heading">
                <div class="card-body">
                    <div class="row">
                        <div class="col-4">
                            <table class="table-hover table-striped nowrap" style="width: 100%" id="case_details">
                                <tbody>
                                <tr class="form-item" name="case_type">
                                    <th>Case Type</th>
                                    <td><a href="#" class="text-decoration-none t-tip" data-html="true" data-toggle="tooltip" data-placement="bottom" title="{{mod_tooltips['case_type_id']}}">{{item.type.name}} ({{item.type.code}})</a></td>
                                </tr>
                                <!-- {% if item.type.code == 'PM' %}
                                <tr>
                                    <th>Primary Pathologist</th>
                                    <td>
                                        {% if item.primary_pathologist %}
                                            {{item.pathologist.full_name}}
                                        {% else %}
                                        <a href="" data-toggle="tooltip" title="<ul><li>If Autopsy Type = Admin Review <i class='fa fa-arrow-right' aria-hidden='true'></i> Inform CHIEF INV to populate</li>
                                        <li> For all other Autopsy Types <i class='fa fa-arrow-right' aria-hidden='true'></i> Inform AUTOPSY TECHS to populate </li></ul>"><i class="fa fa-exclamation" aria-hidden="true"></i></a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endif %} -->
                                <tr class="form-item" name="priority">
                                    <th>Priority</th>
                                    {% if item.priority == 'High' %}
                                    {% set color = 'red' %}
                                    {% set font_weight = 'bold' %}
                                    {% endif %}
                                    <td>
                                    <a href="#" class="text-decoration-none t-tip" style="color: {{color}}; font-weight: {{font_weight}}" data-html="true" data-toggle="tooltip" data-placement="bottom" title="{{mod_tooltips['priority']}}">{{item.priority}}</a>     
                                    {% if current_user.permissions in ['Admin', 'Owner'] %}
                                    <a href="#"data-toggle="modal"
                                    data-target="#edit-priority-modal"
                                    class="text-primary normal align-baseline"
                                    style="text-decoration: none;">
                                    | Update </a>
                                    {% endif %}
                                    </td>
                                </tr>
                                <tr class="form-item" name="sensitivity">
                                    <th>Sensitivity</th>
                                    {% if item.sensitivity == 'Restricted' %}
                                    {% set sens_color = 'red' %}
                                    {% set sens_font_weight = 'bold' %}
                                    {% endif %}
                                    <td><a href="#" class="text-decoration-none t-tip" style="color:{{sens_color}}; font-weight: {{sens_font_weight}}" data-html="true" data-toggle="tooltip" data-placement="bottom" title="{{mod_tooltips['sensitivity']}}">{{item.sensitivity}}</a>
                                    {% if current_user.permissions in ['Admin', 'Owner'] %}
                                    <a href="#"data-toggle="modal"
                                    data-target="#edit-sensitivity-modal"
                                    class="text-primary normal align-baseline"
                                    style="text-decoration: none;">
                                    | Update </a>
                                    {% endif %}
                                </td>
                                </tr>
                                <tr>
                                    <th>Number of Containers</th>
                                    <td>{{item.n_containers}}</td>
                                </tr>
                                <tr>
                                    <th>Retention Policy</th>
                                    <td>{{item.retention.name}}</td>
                                </tr>
                                <tr>
                                    <th>Discard Eligible <i>(Date)</i></th>
                                    <td>
                                        {{item.discard_eligible}}

                                        {% if item.discard_date %}
                                        (<i>{{item.discard_date.strftime('%m/%d/%Y')}}</i>)
                                        {% else %}
                                        (<i>None</i>)
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Case Entry Date</th>
                                    <td>
                                        {% if item.case_type == 7 and item.fa_case_entry_date %}
                                        {{ item.fa_case_entry_date.strftime('%m/%d/%Y') }} {{item.fa_case_entry_date.strftime('%H:%M')}}
                                        {% elif item.create_date %}
                                        {{ item.create_date.strftime('%m/%d/%Y') }} {{item.create_date.strftime('%H:%M')}}
                                        {% else %}
                                        N/A
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Case Close Date</th>
                                    <td>
                                        {% if item.case_type == 7 %}
                                            {{ item.case_close_date.strftime('%m/%d/%Y') if item.case_close_date }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Aliases</th>
                                    <td>{{item.alias_names if item.case_type == 7 else 'N/A' }}</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col">
                            <table class="table-hover table-striped nowrap" style="width: 100%">
                                <tbody>
                                <tr class="form-item" name="date_of_incident">
                                    <th>Date and Time of Incident/Death</th>
                                    <td>
                                        {% if item.date_of_incident %}
                                        <a href="#" class="text-decoration-none t-tip" data-html="true"
                                           data-toggle="tooltip" data-placement="bottom"
                                           title="{{mod_tooltips['date_of_incident']}}">
                                            {{ item.date_of_incident.strftime("%m/%d/%Y") }}
                                        </a>
                                        {% if item.time_of_incident %}
                                        <span> at </span>
                                        <a href="#" class="text-decoration-none t-tip" data-html="true"
                                           data-toggle="tooltip" data-placement="bottom"
                                           title="{{mod_tooltips['time_of_incident']}}">
                                            {{ item.time_of_incident[:2] }}:{{ item.time_of_incident[2:] }}
                                        </a>
                                        {% endif %}
                                        {% endif %}
                                    </td>

                                </tr>

                                <tr class="form-item" name="submitting_agency">
                                    <th>Client (Agency)</th>
                                    <td>
                                        <a href="{{url_for('agencies.view' , item_id=item.agency.id) }}" class="text-decoration-none t-tip" data-html="true" data-toggle="tooltip" data-placement="bottom" title="{{mod_tooltips['submitting_agency']}}">
                                            {{item.agency.name}}
                                        </a>
                                    </td>
                                </tr>
                                <tr class="form-item" name="submitting_agency">
                                    <th>Client (Division)</th>
                                    <td>
                                        {% if item.division %}
                                        <a class="text-decoration-none t-tip" data-html="true" data-toggle="tooltip" data-placement="bottom" title="{{mod_tooltips['submitting_agency']}}">
                                            {{item.division.name}}
                                        </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr class="form-item" name="submitter_case_reference_number">
                                    <th>Case Ref. No.</th>
                                    <td><a class="text-decoration-none t-tip" data-html="true" data-toggle="tooltip" data-placement="bottom" title="{{mod_tooltips['submitter_case_reference_number']}}">{{item.submitter_case_reference_number}}</a></td>
                                </tr>
                                <tr class="form-item" name="alternate_case_reference_number_1">
                                    <th>Alt. Case Ref. No. 1</th>
                                    <td><a class="text-decoration-none t-tip" data-html="true" data-toggle="tooltip" data-placement="bottom" title="{{mod_tooltips['alternate_case_reference_number_1']}}">{{item.alternate_case_reference_number_1}}</a></td>
                                </tr>
                                <tr class="form-item" name="alternate_case_reference_number_2">
                                    <th>Alt. Case Ref. No. 2</th>
                                    <td><a class="text-decoration-none t-tip" data-html="true" data-toggle="tooltip" data-placement="bottom" title="{{mod_tooltips['alternate_case_reference_number_2']}}">{{item.alternate_case_reference_number_2}}</a></td>
                                </tr>
                                 <tr>
                                    <th>Medical Record</th>
                                    <td>{{item.medical_record if item.case_type == 7 else 'N/A' }}</td>
                                </tr>
                                 <tr>
                                    <th>Height and Weight</th>
                                    <td>
                                        {% if item.case_type == 7 %}
                                            {% if item.height_inches %}
                                            {% set inches = item.height_inches %}
                                            {{ (inches // 12)|int }}'{{ (inches % 12)|int }}"&emsp;{% if item.weight_pounds %}{{ item.weight_pounds }} lbs{% endif %}
                                            {% endif %}
                                        {% else %} N/A 
                                        {% endif %}
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-3">
                            <table class="table-hover table-striped nowrap" style="width: 100%">
                                <tbody>
                                <tr>
                                <tr class="form-item" id="gender_id">
                                    <th>Gender/Birth Sex</th>
                                    <td>
                                        {% if item.gender %}
                                            <a href="#" class="text-decoration-none t-tip form-item" name="gender" data-html="true" data-toggle="tooltip" data-placement="bottom" title="{{mod_tooltips['gender_id']}}">{{item.gender.name}}</a>
                                        {% endif %}
                                        /
                                        {% if item.birth_sex %}
                                            <a href="#" class="text-decoration-none t-tip form-item" name="birth_sex" data-html="true" data-toggle="tooltip" data-placement="bottom" title="{{mod_tooltips['birth_sex']}}">{{item.birth_sex}}</a>
                                        {% else %}
                                            Not specified
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr class="form-item" id="race_id">
                                    <th>Race</th>
                                    <td><a href="#" class="text-decoration-none t-tip" data-html="true" data-toggle="tooltip" data-placement="bottom" title="{{mod_tooltips['race_id']}}">{{item.race.name if item.case_type == 7 else 'N/A' }}</a></td>
                                </tr>
                                <tr>
                                    <th>Hispanic Ethnicity</th>
                                    <td>{{item.hispanic_ethnicity if item.case_type == 7 else 'N/A' }}</td>
                                </tr>
                                <tr class="form-item" name="date_of_birth">
                                    <th>Date of Birth</th>
                                    {% if item.date_of_birth is none %}
                                    <td></td>
                                    {% else %}
                                    <td><a href="#" class="text-decoration-none t-tip" data-html="true" data-toggle="tooltip" data-placement="bottom" title="{{mod_tooltips['date_of_birth']}}">{{item.date_of_birth.strftime("%m/%d/%Y")}}</a></td>
                                    {% endif %}
                                </tr>
                                <tr class="form-item" id="age">
                                    <th>Age</th>
                                    <td ><a href="#" class="text-decoration-none t-tip" data-html="true" data-toggle="tooltip" data-placement="bottom" title="{{mod_tooltips['age']}}">{{item.age}}</a></td>
                                </tr>
                                <tr>
                                    <th>Age Status</th>
                                    <td>{{item.age_status}}</td>
                                </tr>
                                <tr>
                                    <th>Marital Status</th>
                                    <td>{{item.marital_status if item.case_type == 7 else 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <th>Pregnancy Status</th>
                                    <td>{{item.pregnancy_status if item.case_type == 7 else 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <th>SSN</th>
                                    <td>
                                    {% if item.case_type == 7 %}    
                                        {% if item.ssn %}<a class="text-decoration-none t-tip" data-html="true" data-toggle="tooltip" data-placement="bottom" title="If required, see CFT.">Yes</a>{% endif %}
                                    {% else %} N/A 
                                    {% endif %}
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col">
                            <table class="table-hover table-striped nowrap" style="width:100%; margin:auto">
                                {% if kwargs['last_names'] %}
                                    <tr>
                                        <th class="col-md-2">Last Name Changes</th>
                                        <td>{{kwargs['last_names']}}</td>
                                    </tr>
                                {% endif %}
                                {% if kwargs['first_names'] %}
                                    <tr>
                                        <th class="col-md-2">First Name Changes</th>
                                        <td>{{kwargs['first_names']}}</td>
                                    </tr>
                                {% endif %}
                            </table>
                        </div>
                    </div>
                    {% if item.type.code == 'PM' %}
                    <hr style="border-width:5px">
                    <div>
                        <h4>Autopsy & Death Information</h4>
                        <div class="row">
                            <div class="col">
                                <table class="table-hover table-striped nowrap" style="width: 100%">
                                    <tbody>
                                    <tr>
                                        <th>Autopsy Type</th>
                                        <td>{{item.autopsy_type}}</td>
                                    </tr>
                                    <tr>
                                        <th>Autopsy Performed</th>
                                        <td>{{item.autopsy_performed}}</td>
                                    </tr>   
                                    <tr>
                                        <th>Start Date</th>
                                        <td>
                                            {% if item.autopsy_start_date %}
                                            {{item.autopsy_start_date.strftime('%m/%d/%Y')}}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>End Date</th>
                                        <td>
                                            {% if item.autopsy_end_date %}
                                            {{item.autopsy_end_date.strftime('%m/%d/%Y')}}
                                            {% endif %}
                                        </td>
                                    </tr>       
                                    <tr>
                                        <th>Exam Status</th>
                                        <td>{{item.exam_status}}</td>
                                    </tr>       
                                    <tr>
                                        <th>Primary Pathologist</th>
                                        <td>
                                            {% if item.primary_pathologist %}
                                                {{item.pathologist.full_name}}
                                            {% else %}
                                            <a href="" data-toggle="tooltip" title="<ul><li>If Autopsy Type = Admin Review <i class='fa fa-arrow-right' aria-hidden='true'></i> Inform CHIEF INV to populate</li>
                                            <li> For all other Autopsy Types <i class='fa fa-arrow-right' aria-hidden='true'></i> Inform AUTOPSY TECHS to populate </li></ul>"><i class="fa fa-exclamation" aria-hidden="true"></i></a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                </tbody>
                                </table>
                            </div>
                            <div class="col">
                                <table class="table-hover table-striped nowrap" style="width: 100%">
                                    <tbody>
                                    <tr>
                                        <th>MOD/COD Finalized Date</th>
                                        <td>
                                            {% if item.autopsy_type != 'ADMINISTRATIVE REVIEW' %}
                                                {% if item.certificate_report_date %} 
                                                    {{ item.certificate_report_date.strftime('%m/%d/%Y') }}
                                                {% endif %}
                                            {% else %} 
                                                N/A                                                 
                                            {% endif %}
                                        </td>
                                    </tr>                                                                                            
                                    <tr>
                                        <th>Manner of Death (MOD)</th>
                                        <td>{{ item.manner_of_death or ''}}</td>
                                    </tr>
                                    <tr>
                                        <th>Method of Death</th>
                                        <td>{{ item.method_of_death or '' }}</td>
                                    </tr>
                                    <tr>
                                        <th>How Injury Occurred</th>
                                        <td>{{ item.how_injury_occured or '' }}</td>
                                    </tr>
                                    <tr>
                                        <th>Certificate Status</th>
                                        <td>{{ item.certificate_status or ''}}</td>
                                    </tr>
                                    <tr>
                                        <th>Certified</th>
                                        <td>{{ item.certifier.full_name or ''}}</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col">
                                <table class="table-hover table-striped nowrap" style="width: 100%">
                                    <tbody>
                                    <tr><th></th><td><strong>Cause of Death (COD)</strong></td></tr>
                                    <tr>
                                        <th> </th>
                                        <td>{{ item.cod_a or ''}}</td>
                                    </tr>
                                    <tr>
                                        <th> </th>
                                        <td>{{ item.cod_b or ''}}</td>
                                    </tr>
                                    <tr>
                                        <th> </th>
                                        <td>{{ item.cod_c or ''}}</td>
                                    </tr>
                                    <tr>
                                        <th> </th>
                                        <td>{{ item.cod_d or ''}}</td>
                                    </tr>
                                        <tr></tr>
                                        <tr><th></th><td><strong>Other Conditions</strong></td></tr>
                                        <tr><th></th><td>{% if item.other_conditions %}{{ item.other_conditions }}{% endif %}</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="pt-3">
                        <h4>Investigative Information</h4>
                        <div class="row">
                            <div class="col">
                                <table class="table-hover table-striped nowrap" style="width: 100%">
                                    <tbody>
                                    <tr>
                                        <th>Investigation Start</th>
                                        <td>
                                            {% if item.fa_inv_start_datetime %}
                                            {{ item.fa_inv_start_datetime.strftime('%m/%d/%Y') }} {{item.fa_inv_start_datetime.strftime('%H:%M')}}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Investigation End</th>
                                        <td>
                                            {% if item.fa_inv_end_datetime %}
                                            {{ item.fa_inv_end_datetime.strftime('%m/%d/%Y') }} {{item.fa_inv_end_datetime.strftime('%H:%M')}}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Primary Investigator</th>
                                        <td>
                                            {% if item.investigator %}
                                                {{item.investigator.full_name}}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Secondary Investigator</th>
                                        <td>
                                            {% if item.secondary_investigator %}
                                            {{item.investigator_second.full_name}}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Case Death Type</th>
                                        <td>{{item.fa_case_death_type}}</td>
                                    </tr>
                                    <tr>
                                        <th>ID Completed</th>
                                        <td>
                                            {% if item.fa_ident_datetime %}
                                            {{ item.fa_ident_datetime.strftime('%m/%d/%Y') }} {{item.fa_ident_datetime.strftime('%H:%M')}}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col">
                                <table class="table-hover table-striped nowrap" style="width: 100%">
                                    <tr>
                                        <th>Case Stage</th>
                                        <td>{{item.fa_case_stage}}</td>
                                    </tr>
                                    <tr>
                                        <th>Decedent Case Comments</th>
                                        <td>{{item.fa_case_comments}}</td>
                                    </tr>
                                    <tr>
                                        <th>Decedent Case Comments (AI)<a href="#!" data-html="true" data-toggle="tooltip"
                                                title="<b>AI Decedent Case Comment & Narrative Summary</b><br>
                                                An OCME-developed AI model that generates a concise summary and case comment based on the Investigator Narrative. The model is configured to be deterministicproducing consistent results for the same input.<br><br>
                                                <strong>WARNING:</strong> Despite safeguards, AI may hallucinate (i.e., introduce inaccurate details), particularly in history (Hx) and prescription (Rx) sections. Always review and verify AI-generated content before using it in your final summary.">
                                                <i class="fa-solid fa-circle-question" style="font-size:16px; vertical-align: middle;"></i>
                                            </a></th>
                                        <td>
                                            {% if item.case_comments_ai %}
                                            {{ item.case_comments_ai }}
                                            {% else %}
                                            <div id="ai-comments-container" class="bg-info text-white rounded p-2 d-flex align-items-center">
                                                <div class="spinner-border spinner-border-sm mr-2" role="status" aria-hidden="true"></div>
                                                <span id="ai-comments-text"><i>Loading AI case comment...</i></span>
                                            </div>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Public Administrator</th>
                                        <td>
                                            {% if item.referred_to_pub_adm %}
                                            {{ item.public_administrator }} on {{ item.pa_notified_date.strftime('%m/%d/%Y') }} {{item.pa_notified_date.strftime('%H:%M')}}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Scene Arrival</th>
                                        <td>
                                            {% if item.fa_scene_dept_datetime %}
                                            {{ item.fa_scene_arrival_datetime.strftime('%m/%d/%Y') }} {{item.fa_scene_arrival_datetime.strftime('%H:%M')}}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Scene Departure</th>
                                        <td>
                                            {% if item.fa_scene_dept_datetime %}
                                            {{ item.fa_scene_dept_datetime.strftime('%m/%d/%Y') }} {{item.fa_scene_dept_datetime.strftime('%H:%M')}}
                                            {% endif %}
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col">
                                <table class="table-hover table-striped nowrap" style="width: 100%">
                                    <tbody>
                                    <tr>
                                        <th>Home Address (County)</th>
                                        <td>
                                            {% if not item.home_status %}
                                            <a href="https://google.com/maps/?q={{item.home_address}} {{item.home_zip}}" target="_blank">
                                                {{item.home_address}} {{item.home_city}} {{item.home_zip}} ({{item.home_county}})
                                            </a>
                                            {% else %}
                                                {{item.home_status}}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Death Address (Premise)</th>
                                        <td>
                                            {% if item.latitude is not none %}
                                            <a href="https://google.com/maps/?q={{item.death_address}} {{item.death_zip}}" target="_blank">
                                                {{item.death_address}} {{item.death_zip}}
                                            </a>
                                            {% else %}
                                            <a href="https://google.com/maps/?q={{item.death_address}} {{item.death_zip}}" target="_blank">
                                                {{item.death_address}} {{item.death_zip}}
                                            </a>
                                            {% endif %}
                                            {% if item.death_premises %}
                                            ({{item.death_premises}})
                                            {% endif %}
                                    </tr>
                                    <tr>
                                        <th>NOK Notified </th>
                                        <td>
                                            {% if item.nok_notify_date %}
                                            {{ item.nok_notify_date.strftime('%m/%d/%Y') }}{% if item.nok_notify_time %} {{ item.nok_notify_time[:2] }}:{{ item.nok_notify_time[2:] }}{% endif %}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>NOK Relationship</th>
                                        <td>{{item.next_of_kin_relationship}}</td>
                                    </tr>
                                    <tr>
                                        <th>Body Received (Cooler)</th>
                                        <td>
                                            {% if item.fa_cooler_datetime %}
                                            {{ item.fa_cooler_datetime.strftime('%m/%d/%Y') }} {{item.fa_cooler_datetime.strftime('%H:%M')}}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Body Released</th> <!-- known misnomer in models -->
                                        <td>
                                            {% if item.autopsy_finalized_date %}
                                            {{item.autopsy_finalized_date.strftime('%m/%d/%Y')}}
                                            {% endif %}
                                            {% if item.body_released_time %}
                                            {{ item.body_released_time[:2] }}:{{ item.body_released_time[2:] }}
                                            {% endif %}
                                        </td>
                                    <tr>
                                        <th>Funeral Home</th>
                                        <td>{% if item.autopsy_type != 'INDIGENT' %}{{item.mortuary}}{% endif %}</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% if item.type.code == 'PM' %}
        <!-- NARRATIVES -->
        <div class="card">
            <div class="card-header view-card-header" id="narratives">
                <button class="btn btn-link chevron-btn" style="font-size:20px" data-toggle="collapse" data-target="#narratives-collapse" aria-expanded="false" aria-controls="narratives">
                    <span><i class="fa-solid fa-chevron-down mr-2 chevron" style="border: '#FF0000'"></i></span>
                    Narratives
                </button>
                <!-- <p id="output" class="bg-primary text-white rounded p-2 mt-2"> AI case summary is loading...</p> -->
            </div>
            <div id="narratives-collapse" class="collapse show" aria-labelledby="narratives-heading">
                <div class="card-body">

                    <!-- <p id="output"
                        class="bg-info text-white rounded p-2 mt-2 d-flex align-items-center"
                        style="word-break: break-word;
                                white-space: pre-wrap;
                                overflow-wrap: break-word;
                                max-height: 250px;
                                overflow-y: auto;">
                        <span class="spinner-border spinner-border-sm mr-2" role="status" aria-hidden="true"></span>
                        <span id="output-text">AI case summary is loading...</span>
                    </p>
                    <div id="copy-summary-button-container" class="mt-2"></div> -->


                    <div class="table display">
                        <div class="table-responsive">
                            <table class="display table-hover table-striped small" style="width:100%" id="narratives_table">
                                <thead>
                                <tr>
                                    <th class="click"></th>
                                    <th>Type</th>
                                    <th>Narrative</th>
                                    {% if "FLD" in current_user.permissions or current_user.permissions in ['Owner', 'Admin'] %}
                                        <th>Highlight</th>
                                        <th>Checked</th>
                                    {% endif %}
                                    <th>Import Date</th>
                                    <th>Last Updated</th>
                                </tr>
                                </thead>
                                {% set ns = namespace(found_ai_summary=false) %}
                                {% set ai_summaries = kwargs['narratives'] | selectattr('narrative_type', 'equalto', 'Summary (AI)') | list %}
                                {% if ai_summaries %}
                                <tbody>
                                {% for item in kwargs['narratives'] %}
                                    {% if item.narrative_type == "Summary (AI)" %}
                                        {% set ns.found_ai_summary = true %}
                                        <tr id="static-narrative-row">
                                            <td style="display: none"></td>
                                            <td>
                                                {% if "FLD" in current_user.permissions or current_user.permissions in ['Owner', 'Admin'] %}
                                                <a href="{{ url_for('narratives.view', item_id=item.id) }}">{{ item.narrative_type }}</a><a href="#!" data-html="true" data-toggle="tooltip"
                                                    title="<b>AI Decedent Case Comment & Narrative Summary</b><br>
                                                    An OCME-developed AI model that generates a concise summary and case comment based on the Investigator Narrative. The model is configured to be deterministicproducing consistent results for the same input.<br><br>
                                                    <strong>WARNING:</strong> Despite safeguards, AI may hallucinate (i.e., introduce inaccurate details), particularly in history (Hx) and prescription (Rx) sections. Always review and verify AI-generated content before using it in your final summary.">
                                                    <i class="fa-solid fa-circle-question" style="font-size:16px; vertical-align: middle;"></i>
                                                </a>
                                                {% else %}
                                                    {{ item.narrative_type }}<a href="#!" data-html="true" data-toggle="tooltip"
                                                    title="<b>AI Decedent Case Comment & Narrative Summary</b><br>
                                                    An OCME-developed AI model that generates a concise summary and case comment based on the Investigator Narrative. The model is configured to be deterministicproducing consistent results for the same input.<br><br>
                                                    <strong>WARNING:</strong> Despite safeguards, AI may hallucinate (i.e., introduce inaccurate details), particularly in history (Hx) and prescription (Rx) sections. Always review and verify AI-generated content before using it in your final summary.">
                                                    <i class="fa-solid fa-circle-question" style="font-size:16px; vertical-align: middle;"></i>
                                                </a>
                                                {% endif %}
                                            </td>

                                            {% set unique_id = "narrative-" ~ item.id %}
                                            {% set button_id = "copy-btn-" ~ item.id %}
                                            {% set summary_id = "summary-text-" ~ item.id %}

                                            {% if "FLD" in current_user.permissions or current_user.permissions in ['Owner', 'Admin'] %}
                                                {% set narrative = item.narrative %}
                                            {% else %}
                                                {% set narrative = item.narrative | replace("<mark>", "") | replace("</mark>", "") %}
                                            {% endif %}

                                            <td data-narrative="{{ narrative | e }}">
                                                {% if narrative | length < 500 %}
                                                    {{ narrative | safe }}
                                                {% else %}
                                                    <div id="show-more">
                                                        {{ narrative[:300] | safe }}<a href="" class="show-more">...Show More</a>
                                                    </div>
                                                    <div hidden>
                                                        {{ narrative | safe }}<br><a href="#" class="show-less">Show Less</a>
                                                    </div>
                                                {% endif %}
                                            </td>

                                            {% if "FLD" in current_user.permissions or current_user.permissions in ['Owner', 'Admin'] %}
                                                <td align="center">
                                                    {% if not item.locked or item.locked_by == current_user.initials %}
                                                        <a href="{{ url_for('narratives.update', item_id=item.id) }}">
                                                            <i class="fa-solid fa-highlighter"></i>
                                                        </a>
                                                    {% endif %}
                                                    {% if item.locked %}
                                                        {% if item.locked_by == current_user.initials %}
                                                            | <a id="lock" href="{{ url_for('narratives.unlock', item_id=item.id) }}"><i class="fa-solid fa-unlock"></i></a>
                                                        {% else %}
                                                            <i class="fa-solid fa-lock"></i>
                                                        {% endif %}
                                                        {{ item.locked_by }}
                                                    {% endif %}
                                                </td>
                                                <td align="center">
                                                    {% if item.checked == 'Y' %}
                                                        <i class="fa-solid fa-check" style="color: green; font-size: 24px;"></i>
                                                    {% endif %}
                                                </td>
                                            {% endif %}
                                            <td>
                                                {{ item.create_date.strftime('%m/%d/%Y %H:%M') }}
                                            </td>
                                            <td>
                                                {% if item.updated_date %}
                                                    {{item.updated_date.strftime('%m/%d/%Y %H:%M')}}
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endif %}
                                {% endfor %}
                                </tbody>
                                {% endif %}

                                {% if not ns.found_ai_summary %}
                                    <tbody id="summary-narratives">
                                        <tr id="loading-row">
                                            <td colspan="6" id="ai-summary-cell">
                                                <p class="bg-info text-white rounded p-2 mt-2 d-flex align-items-center"
                                                style="word-break: break-word; white-space: pre-wrap; overflow-wrap: break-word; max-height: 250px; overflow-y: auto;">
                                                    <span class="spinner-border spinner-border-sm mr-2" role="status" aria-hidden="true"></span>
                                                    <span id="output-text"><i>AI case summary is loading...</i></span>
                                                </p>
                                            </td>
                                        </tr>
                                    </tbody>
                                {% endif %}



                                <tbody>
                                    {% for item in kwargs['narratives'] %}
                                        {% if item.narrative_type != "Summary (AI)" %}
                                            <tr>
                                                <td style="display: none"></td>
                                                <td>
                                                    {% if "FLD" in current_user.permissions or current_user.permissions in ['Owner', 'Admin'] %}
                                                    <a href="{{url_for('narratives.view', item_id=item.id)}}">
                                                       {{item.narrative_type}}
                                                    </a>
                                                    {% else %}
                                                        {{item.narrative_type}}
                                                    {% endif %}
                                                </td>
                                                <td
                                                {% if "FLD" in current_user.permissions or current_user.permissions in ['Owner', 'Admin'] %}
                                                    {% set narrative = item.narrative %}
                                                {% else %}
                                                    {% set narrative = item.narrative | replace("<mark>", "") | replace("</mark>", "") %}
                                                {% endif %}
                                                data-narrative="{{ narrative | e }}"
                                                >
                                                    {% if narrative | length < 500 %}
                                                        {{narrative | safe}}
                                                    {% else %}
                                                        <div id="show-more">
                                                            {{narrative[:300]| safe}}<a href="#" class="show-more">...Show More</a>
                                                        </div>
                                                        <div hidden>
                                                            {{narrative| safe}}<br><a href="#" class="show-less">Show Less</a>
                                                        </div>
                                                    {% endif %}
                                                </td>
                                                {% if "FLD" in current_user.permissions or current_user.permissions in ['Owner', 'Admin'] %}
                                                    <td align="center">
                                                        {% if not item.locked or item.locked_by == current_user.initials %}
                                                            <a href="{{url_for('narratives.update', item_id=item.id)}}">
                                                                <i class="fa-solid fa-highlighter"></i>
                                                            </a>
                                                        {% endif %}
                                                        {% if item.locked %}
                                                            {% if item.locked_by == current_user.initials %}
                                                                | <a id="lock" href="{{url_for('narratives.unlock', item_id=item.id)}}"><i class="fa-solid fa-unlock"></i></a>
                                                            {% else %}
                                                                <i class="fa-solid fa-lock"></i>
                                                            {% endif %}
                                                            {{item.locked_by}}
                                                        {% endif %}
                                                    </td>
                                                    <td align="center">
                                                        {% if item.checked == 'Y' %}
                                                            <i class="fa-solid fa-check" style="color: green; font-size: 24px;"></i>
                                                        {% endif %}
                                                    </td>
                                                {% endif %}
                                                <td>
                                                    {{item.create_date.strftime('%m/%d/%Y %H:%M')}}
                                                </td>
                                                <td>
                                                    {% if item.updated_date %}
                                                        {{item.updated_date.strftime('%m/%d/%Y %H:%M')}}
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endif %}
                                    {% endfor %}
                                </tbody>
                                    <tr>
                                        <td style="display: none"></td>
                                        <td style="text-align:left;">Comments (Summary)</td>
                                        <td colspan="6" style="text-align:left;"> {{ kwargs['narrative_comment_dict'].get(kwargs['summary_id'], '') | safe }} </td>
                                        <td style="display: none"></td>
                                        <td style="display: none"></td>
                                        <td style="display: none"></td>
                                        <td style="display: none"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        <!-- CONTAINERS & SPECIMENS -->
        <div class="card">
            <div class="card-header view-card-header" id="containers_heading">
                <button class="btn btn-link chevron-btn" data-toggle="collapse" data-target="#containers" aria-expanded="false" aria-controls="containers">
                    <span><i class="fa-solid fa-chevron-down mr-2 chevron"></i></span>
                    Containers and Specimens
                </button>
                {% block buttons_containers_and_specimens %}
                        <button id="show-all-toggle" class="btn btn-secondary btn-sm"  style="margin-right: 8px">Show All </button>
                        <button id="pm-review-toggle" class="btn btn-secondary btn-sm"  style="margin-right: 8px">PM Review</button>
                        <button id="hp-review-toggle" class="btn btn-secondary btn-sm" style="margin-right: 8px">HP Review</button>
                        <button id="drug-review-toggle" class="btn btn-secondary btn-sm" style="margin-right: 8px">Drug Review</button>
                {% endblock %}
            </div>
            <div class="collapse show" id="containers" aria-labelledby="containers_heading">
                <div class="card-body">
                    <div class="table display">
                        <div class="table-responsive">
                            <table class="display table-hover small nowrap datatable" id="container_table">
                                <thead>
                                <tr style="text-align:center">

                                    <th class="click attach"></th>
                                    <th class="attach"></th>
                                    <th class="locked">Locked</th>
                                    <th>Discipline</th>     
                                    <th>Accession<br>Number</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th class="accd_recd">Spec. <br> Acc'd/Rec'd</span></div></th>
                                    <th class="evidence_comments">Evidence Receipt Comments</th>
                                    <th class="comments">Comments</th>                  
                                    <th class="collected_by">Collected<br>By</th>
                                    <th>Submission/Collection <br> Date and Time</th>
                                    <th class="custody-table">Custody</th>
                                    <th class ="cont_spec">Cont.-Spec.</th>
                                    <th class="submitter">Pending Submitter</th>
                                    <th class="submitter">Submitted By</th>
                                    <th class ="submission_route">Submission<br>Route Type</th>
                                    <th class ="submission_route">Submission<br>Location</th>
                                    <th>Collection<br>Vessel</th>
                                    <th class="accessioned">Accessioned<br>By</th>
                                    <th>Current/Submitted<br>Amount</th>
                                    <th>Condition</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for container in kwargs['containers'] %}
                                    {% set cont_idx =  loop.index %}
                                    {% if not container.db_status == 'Removed' or current_user.permissions in ['Admin', 'Owner'] %}
                                        {% if container.db_status in ['Pending', 'Active With Pending Changes', 'Changes Pending'] %}
                                            <tr class="table-primary" style="font-weight: bold">
                                        {% elif container.db_status == 'Removal Pending' %}
                                            <tr class="table-danger" style="font-weight: bold">
                                        {% elif container.db_status == 'Removed' %}
                                            <tr class="table-secondary" style="font-weight: bold">
                                        {% else %}
                                            <tr class="table-default" style="font-weight: bold; background-color:rgba(0, 0, 0, .05)">
                                        {% endif %}
                                            <td class ="attach">
                                                <a class="btn btn-secondary btn-size" href="{{ url_for('containers.attach', item_id=container.id, alias=item.case_number~' | '~container.accession_number) }}"><i class="fa-solid fa-paperclip"></i></a>
                                            </td>
                                            <td class ="locked">
                                                {% if container.locked %}
                                                    <i class="fa-solid fa-lock"></i> {{container.locked_by}}
                                                {% endif %}
                                            </td>
                                            <td>{{container.discipline}}</td>
                                            <td>
                                                {% if current_user.permissions not in ['ADM-Management', 'ADM'] %}
                                                {% if container.locked_by == current_user.initials %}
                                                    {% if container.pending_submitter %}
                                                        {% if container.pending_submitter == current_user.initials %}
                                                            <a href="{{url_for('containers.edit', item_id=container.id)}}">
                                                                {{container.accession_number}}
                                                            </a>
                                                        {% else %}
                                                            <a href="{{url_for('containers.approve', item_id=container.id)}}">
                                                                {{container.accession_number}}
                                                            </a>
                                                        {% endif %}
                                                    {% elif view_only %}
                                                        <a href="{{url_for('containers.view', item_id=container.id, view_only=True)}}">
                                                            {{container.accession_number}}
                                                        </a>
                                                    {% else %}
                                                        <a href="{{url_for('containers.view', item_id=container.id)}}">
                                                            {{container.accession_number}}
                                                        </a>
                                                    {% endif %}
                                                {% elif view_only %}
                                                    <a href="{{url_for('containers.view', item_id=container.id, view_only=True)}}">
                                                        {{container.accession_number}}
                                                    </a>
                                                {% else %}
                                                    <a href="{{url_for('containers.view', item_id=container.id)}}">
                                                        {{container.accession_number}}
                                                    </a>
                                                {% endif %}
                                                {% else %}
                                                
                                                {{container.accession_number}}
                                                {% endif %}
                                            </td>
                                            <td>[{{container.type.code}}]</td>
                                            <td>{{container.type.name}}</td>                                                                             
                                            <td class="accd_recd"
                                                {% if container.n_specimens != container.n_specimens_submitted or container.n_specimens|int == 0 and container.n_specimens_submitted|int == 0 %}
                                                    style="background-color: yellow;"
                                                {% endif %}>
                                                {{ container.n_specimens }}/{{ container.n_specimens_submitted }}
                                            </td>
                                            <td class ="evidence_comments">
                                                {% if container.evidence_comments %}
                                                    {% for evidence_comment in container.evidence_comments.split('\n') %}
                                                       {{evidence_comment | safe}}<br>
                                                    {% endfor %}
                                                {% endif %}
                                            </td>
                                            <td class ="comments">
                                                {{ kwargs['container_comment_dict'][container.id] | safe }}
                                            </td>
                                            <td class ="collected_by"> </td>
                                            <td>
                                                {% if container.submission_date %}
                                                {{container.submission_date.strftime('%m/%d/%Y')}} {{container.submission_time}}
                                                {% endif %}
                                            </td>                
                                            <td class ="custody-table"></td>                       
                                            <td class="cont_spec">{{cont_idx}}</td>
                                            <td class ="submitter">{{container.pending_submitter}}</td>
                                            <td class ="submitter">{{container.submitter.full_name}}</td>
                                            <td class ="submission_route">{{container.submission_route_type}}</td>
                                            <td class ="submission_route">{{container.submission_route}}</td>
                                            <td></td>
                                            <td class="accessioned"></td>
                                            <td></td>
                                            <td></td>
                                        </tr>
                                    {% endif %}
                                    {% set spec_idx = namespace(value = 0) %}
                                    {% for specimen in kwargs['specimens'] %}
                                        {% if not specimen.db_status == 'Removed' or current_user.permissions in ['Admin', 'Owner'] %}
                                            {% if specimen.container_id == container.id %}
                                                {% set spec_idx.value = spec_idx.value + 1 %}
                                                    {% if specimen.db_status in ['Pending', 'Active With Pending Changes', 'Changes Pending'] %}
                                                        <tr class="table-primary">
                                                    {% elif specimen.db_status == 'Deletion Pending' %}
                                                        <tr class="table-danger">
                                                    {% elif specimen.db_status == 'Removed' %}
                                                        <tr class="table-secondary">
                                                    {% else %}
                                                        <tr class="table-default">
                                                    {% endif %}
                                                    
                                                    <td class ="attach"></td>
                                                    <td class = "locked">
                                                        {% if specimen.locked %}
                                                            <i class="fa-solid fa-lock"></i> {{specimen.locked_by}}
                                                        {% endif %}
                                                    </td>
                                                    <td>{{specimen.discipline}}</td>
                                                    
                                                   
                                                    <td>
                                                        {% if current_user.permissions not in ['ADM-Management', 'ADM'] %}
                                                        {% if specimen.locked_by == current_user.initials %}
                                                            {% if specimen.pending_submitter %}
                                                                {% if specimen.pending_submitter == current_user.initials and specimen.custody != current_user.initials %}
                                                                    <a class="edit-specimen" style="margin-left: 20px" href="#" data-toggle="modal" name="{{specimen.accession_number}}" value="{{specimen.id}}" data-target="#edit-specimen">
                                                                        {{specimen.accession_number}}
                                                                    </a>
                                                                {% elif specimen.pending_submitter == current_user.initials and specimen.custody == current_user.initials %}
                                                                    <a href="{{url_for('specimens.edit', item_id=specimen.id)}}" style="margin-left: 20px">
                                                                        {{specimen.accession_number}}
                                                                    </a>
                                                                {% else %}
                                                                    <a href="{{url_for('specimens.approve', item_id=specimen.id, custody=kwargs['give_custody'])}}" style="margin-left: 20px">
                                                                        {{specimen.accession_number}}
                                                                    </a>
                                                                {% endif %}
                                                            {% else %}
                                                                <a href="{{url_for('specimens.view', item_id=specimen.id)}}" style="margin-left: 20px">
                                                                    {{specimen.accession_number}}
                                                                </a>
                                                            {% endif %}
                                                        {% else %}
                                                            <a href="{{url_for('specimens.view', item_id=specimen.id)}}" style="margin-left: 20px">
                                                                {{specimen.accession_number}}
                                                            </a>
                                                        {% endif %}
                                                        {% else %}

                                                            <span style="margin-left: 20px;">{{specimen.accession_number}}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>[{{specimen.type.code}}]</td>
                                                    <td>
                                                        {% if specimen.other_specimen is not none %}
                                                            <a href="#" data-toggle="tooltip"
                                                               title="{{specimen.other_specimen}}" style="display:inline-block">
                                                                {{specimen.type.name}}
                                                            </a>
                                                        {% else %}
                                                            {{specimen.type.name}}
                                                        {% endif %}
                                                    </td>
                                                    
                                                    <td class="accd_recd"></td>
                                                    <td class ="evidence_comments">
                                                        {% if specimen.evidence_comments %}
                                                            {% for evidence_comment in specimen.evidence_comments.split('\n') %}
                                                               {{evidence_comment}}<br>
                                                            {% endfor %}
                                                        {% endif %}
                                                    </td>
                                                   <td class ="comments">                                                  
                                                       {{ kwargs['specimen_comment_dict'][specimen.id] | safe }}
                                                    </td>
                                                    <td class="collected_by">{{specimen.collector.full_name}}</td>
                                                    <td>
                                                        {% if specimen.collection_date %}
                                                            {{specimen.collection_date.strftime('%m/%d/%Y')}}
                                                            {{specimen.collection_time}}
                                                        {% endif %}
                                                    </td>
                                                    <td class="custody-table">{{specimen.custody}}</td>
                                                    <td class="cont_spec">{{cont_idx}}-{{spec_idx.value}}</td>
                                                    <td class="submitter">{{specimen.pending_submitter}}</td>
                                                    <td class="submitter"></td>
                                                    <td class ="submission_route"></td>          
                                                    <td class ="submission_route"></td>                                          
                                                    <td>{{specimen.collection_container.name}}</td>
                                                    <td class="accessioned">{{specimen.accessioner.initials}}</td>
                                                    <td>
                                                        {{specimen.current_sample_amount}}/{{specimen.submitted_sample_amount}}
                                                        {{specimen.type.unit.name}}
                                                    </td>
                                                    <td>{{specimen.condition}}</td>
                                                </tr>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
<!-- Scripts for review views -->
{% block scripts_containers_and_specimens %}
        <script>
        document.addEventListener("DOMContentLoaded", function () {
            const containerTable = document.getElementById("container_table");

            function hideColumnByClass(className) {
                document.querySelectorAll(`.${className}`).forEach(el => {
                    el.style.display = "none";
                });
            }

            function showAllColumns() {
                document.querySelectorAll("#container_table th, #container_table td").forEach(el => {
                    el.style.display = "";
                });
            }

       function applyView(hiddenClasses = []) {
            showAllColumns();

            console.log('HIDDEN CLASSES', hiddenClasses)

            hiddenClasses.forEach(className => {
                document.querySelectorAll(`.${className}`).forEach(el => {
                    el.style.display = "none";
                });
            });

            //  Force reflow
            const table = document.getElementById("container_table");
            void table.offsetHeight; // this triggers layout reflow
        }

        document.getElementById("show-all-toggle").addEventListener("click", function () {
            showAllColumns();
            });
            // ====================
            // PM Review
            // ====================
          document.getElementById("pm-review-toggle").addEventListener("click", function () {
            applyView([
                "attach",
                "locked",
                "accd_recd",
                "evidence_comments",
                "custody-table",
                "cont_spec",
                "submitter",
                "submission_route",
                "accessioned"
            ]);
        });

            // ====================
            // HP Review (one-time only)
            // ====================
            document.getElementById("hp-review-toggle").addEventListener("click", function () {
                showAllColumns();
                [
                    "attach",
                    "locked",
                    "accd_recd",
                    "collected_by",
                    "custody-table",
                    "cont_spec",
                    "submitter",
                    "submission_route",
                    "accessioned"
                ].forEach(hideColumnByClass);
            });

            // ====================
            // Drug Review (toggle)
            // ====================
          document.getElementById("drug-review-toggle").addEventListener("click", function () {
            showAllColumns();  // reset the view to full table first

            [
                "attach",
                "locked",
                "accd_recd",
                "evidence_comments",
                "custody-table",
                "cont_spec",
                "submitter",
                "submission_route",
                "accessioned"
            ].forEach(hideColumnByClass);
            });
        });
    </script>
{% endblock %}




       
<!--        {% if current_user.permissions in ['Admin', 'Owner'] %}-->
<!--        <div class="card">-->
<!--            <div class="card-header view-card-header" id="containers_heading">-->
<!--                <button class="btn btn-link chevron-btn" data-toggle="collapse" data-target="#containers-test" aria-expanded="true" aria-controls="tests">-->
<!--                    <span><i class="fa-solid fa-chevron-down mr-2 chevron" style="border: '#FF0000'"></i></span>-->
<!--                    Containers and Specimens (Nested Test)-->
<!--                </button>-->
<!--            </div>-->
<!--            <div class="collapse" id="containers-test" aria-labelledby="tests_heading">-->
<!--                <div class="card-body">-->
<!--                    <div>-->
<!--                        <a href="#!" id="containers-show-all">Show All</a> |-->
<!--                        <a href="#!" id="containers-collapse-all">Collapse All</a>-->
<!--                    </div>-->
<!--                    <div class="table display">-->
<!--                        <div class="table-responsive">-->
<!--                            <table class="display table-hover nowrap small container-table" style="width:100%">-->
<!--                                <thead>-->
<!--                                    <tr>-->
<!--                                        <th></th>-->
<!--                                        <th></th>-->
<!--                                        <th>Locked</th>-->
<!--                                        <th>Pending Submitter</th>-->
<!--                                        <th>Accession Number</th>-->
<!--                                        <th>Type</th>-->
<!--                                        <th>Description</th>-->
<!--                                        <th>Discipline</th>-->
<!--                                        <th># Spec. Acc'd/Rec'd</th>-->
<!--                                        <th>Submitted By</th>-->
<!--                                        <th>Submission Date and Time</th>-->
<!--                                        <th>Submission Route Type</th>-->
<!--                                        <th>Transfered By</th>-->
<!--                                        <th>Location Type</th>-->
<!--                                        <th>Submission Location</th>-->
<!--                                        <th>Evidence Receipt Comments</th>-->
<!--                                        <th>Notes</th>-->
<!--                                    </tr>-->
<!--                                </thead>-->
<!--                                <tbody>-->
<!--                                    {% for container in kwargs['containers'] %}-->
<!--                                        {% if container.db_status in ['Pending', 'Active With Pending Changes', 'Changes Pending'] %}-->
<!--                                            <tr class="table-primary">-->
<!--                                        {% elif container.db_status == 'Deletion Pending' %}-->
<!--                                            <tr class="table-danger">-->
<!--                                        {% elif container.db_status == 'Removed' %}-->
<!--                                            <tr class="table-secondary">-->
<!--                                        {% else %}-->
<!--                                            <tr class="table-default" style="background-color:#F9F9F9">-->
<!--                                        {% endif %}-->
<!--                                            <td>-->
<!--                                                <a href="#!"><i class="fa-solid fa-square-plus expand expand-containers btn-size" style="font-size: 14px"></i></a>-->
<!--                                            </td>-->
<!--                                            <td>-->
<!--                                                <a class="btn btn-secondary btn-size" href="{{ url_for('containers.attach', item_id=container.id, alias=item.case_number~' | '~container.accession_number) }}"><i class="fa-solid fa-paperclip"></i></a>-->
<!--                                            </td>-->
<!--                                            <td>-->
<!--                                                {% if container.locked %}-->
<!--                                                    <i class="fa-solid fa-lock"></i> {{container.locked_by}}-->
<!--                                                {% endif %}-->
<!--                                            </td>-->
<!--                                            <td>{{container.pending_submitter}}</td>-->
<!--                                            <td>-->
<!--                                                {% if container.locked_by == current_user.initials %}-->
<!--                                                    {% if container.pending_submitter %}-->
<!--                                                        {% if container.pending_submitter == current_user.initials %}-->
<!--                                                            <a href="{{url_for('containers.edit', item_id=container.id)}}">-->
<!--                                                                {{container.accession_number}}-->
<!--                                                            </a>-->
<!--                                                        {% else %}-->
<!--                                                            <a href="{{url_for('containers.approve', item_id=container.id)}}">-->
<!--                                                                {{container.accession_number}}-->
<!--                                                            </a>-->
<!--                                                        {% endif %}-->
<!--                                                    {% else %}-->
<!--                                                        <a href="{{url_for('containers.view', item_id=container.id)}}">-->
<!--                                                            {{container.accession_number}}-->
<!--                                                        </a>-->
<!--                                                    {% endif %}-->
<!--                                                {% else %}-->
<!--                                                    <a href="{{url_for('containers.view', item_id=container.id)}}">-->
<!--                                                        {{container.accession_number}}-->
<!--                                                    </a>-->
<!--                                                {% endif %}-->
<!--                                            </td>-->
<!--                                            <td>[{{container.type.code}}]</td>-->
<!--                                            <td>{{container.type.name}}</td>-->
<!--                                            <td>{{container.discipline}}</td>-->
<!--                                            <td>{{container.n_specimens}}/{{container.n_specimens_submitted}}</td>-->
<!--                                            <td>{{container.submitter.full_name}}</td>-->
<!--                                            <td>-->
<!--                                                {% if container.submission_date %}-->
<!--                                                {{container.submission_date.strftime('%m/%d/%Y')}} {{container.submission_time}}-->
<!--                                                {% endif %}-->
<!--                                            </td>-->
<!--                                            <td>{{container.submission_route_type}}</td>-->
<!--                                            <td>{{container.transfer.initials}}</td>-->
<!--                                            <td>{{container.location_type}}</td>-->
<!--                                            <td>{{container.submission_route}}</td>-->
<!--                                            <td>-->
<!--                                                {% if container.evidence_comments %}-->
<!--                                                    {% for evidence_comment in container.evidence_comments.split('\n') %}-->
<!--                                                       {{evidence_comment | safe}}<br>-->
<!--                                                    {% endfor %}-->
<!--                                                {% endif %}-->
<!--                                            </td>-->
<!--                                            <td>{{container.notes}}</td>-->
<!--                                        </tr>-->
<!--                                        <tr class="hidden_row collapse show">-->
<!--                                            <td colspan="16" style="left-margin: 200px;">-->
<!--                                                <div class="table display">-->
<!--                                                    <div class="table-responsive">-->
<!--                                                        <table class="display table-hover nowrap specimen-table" id="{{container.accession_number}}">-->
<!--                                                            <thead>-->
<!--                                                            <tr>-->
<!--                                                                <th>Custody</th>-->
<!--                                                                <th>Locked</th>-->
<!--                                                                <th>Pending Submitter</th>-->
<!--                                                                <th>Accession Number</th>-->
<!--                                                                <th>Type</th>-->
<!--                                                                <th>Description</th>-->
<!--                                                                <th>Discipline</th>-->
<!--                                                                <th>Collection Date and Time</th>-->
<!--                                                                <th>Collection Vessel</th>-->
<!--                                                                <th>Collected By</th>-->
<!--                                                                <th>Current/Submitted Amount</th>-->
<!--                                                                <th>Condition</th>-->
<!--                                                                <th>Evidence Receipt Comments</th>-->
<!--                                                                <th>Notes</th>-->
<!--                                                                <th>Accessioned By</th>-->
<!--                                                                <th>Accessioned Date and Time</th>-->
<!--                                                            </tr>-->
<!--                                                            </thead>-->
<!--                                                            <tbody>-->
<!--                                                            {% for specimen in kwargs['specimens'] %}-->
<!--                                                                {% if specimen.container_id == container.id %}-->
<!--                                                                    {% if specimen.db_status in ['Pending', 'Active With Pending Changes', 'Changes Pending'] %}-->
<!--                                                                        <tr class="table-primary">-->
<!--                                                                    {% elif specimen.db_status == 'Removal Pending' %}-->
<!--                                                                        <tr class="table-danger">-->
<!--                                                                    {% elif specimen.db_status == 'Removed' %}-->
<!--                                                                        <tr class="table-secondary">-->
<!--                                                                    % else %}-->
<!--                                                                        <tr class="table-default">-->
<!--                                                                    {% endif %}-->
<!--                                                                        <td>{{specimen.custody}}</td>-->
<!--                                                                        <td>-->
<!--                                                                            {% if specimen.locked %}-->
<!--                                                                            <i class="fa-solid fa-lock"></i> {{specimen.locked_by}}-->
<!--                                                                            {% endif %}-->
<!--                                                                        </td>-->
<!--                                                                        <td>{{specimen.pending_submitter}}</td>-->
<!--                                                                        <td>-->
<!--                                                                            {% if specimen.locked_by == current_user.initials %}-->
<!--                                                                                {% if specimen.pending_submitter %}-->
<!--                                                                                    {% if specimen.pending_submitter == current_user.initials and specimen.custody != current_user.initials %}-->
<!--                                                                                        <a class="edit-specimen" href="#" data-toggle="modal" name="{{specimen.accession_number}}" value="{{specimen.id}}" data-target="#edit-specimen">-->
<!--                                                                                            {{specimen.accession_number}}-->
<!--                                                                                        </a>-->
<!--                                                                                    {% elif specimen.pending_submitter == current_user.initials and specimen.custody == current_user.initials %}-->
<!--                                                                                        <a href="{{url_for('specimens.edit', item_id=specimen.id)}}">-->
<!--                                                                                            {{specimen.accession_number}}-->
<!--                                                                                        </a>-->
<!--                                                                                    {% else %}-->
<!--                                                                                        <a href="{{url_for('specimens.approve', item_id=specimen.id)}}">-->
<!--                                                                                            {{specimen.accession_number}}-->
<!--                                                                                        </a>-->
<!--                                                                                    {% endif %}-->
<!--                                                                                {% else %}-->
<!--                                                                                    <a href="{{url_for('specimens.view', item_id=specimen.id)}}">-->
<!--                                                                                        {{specimen.accession_number}}-->
<!--                                                                                    </a>-->
<!--                                                                                {% endif %}-->
<!--                                                                            {% else %}-->
<!--                                                                                <a href="{{url_for('specimens.view', item_id=specimen.id)}}">-->
<!--                                                                                    {{specimen.accession_number}}-->
<!--                                                                                </a>-->
<!--                                                                            {% endif %}-->
<!--                                                                        </td>-->
<!--                                                                        <td>[{{specimen.type.code}}]</td>-->
<!--                                                                        <td>{{specimen.type.name}}</td>-->
<!--                                                                        <td>{{specimen.type.discipline}}</td>-->
<!--                                                                        <td>-->
<!--                                                                            {% if specimen.collection_date %}-->
<!--                                                                                {{specimen.collection_date.strftime('%m/%d/%Y')}}-->
<!--                                                                                {{specimen.collection_time}}-->
<!--                                                                            {% endif %}-->
<!--                                                                        </td>-->
<!--                                                                        <td>-->
<!--                                                                            {% if specimen.collection_container %}-->
<!--                                                                                {{specimen.collection_container.display_name}}-->
<!--                                                                            {% endif %}-->
<!--                                                                        </td>-->
<!--                                                                        <td>-->
<!--                                                                            {% if specimen.collector %}-->
<!--                                                                                {{specimen.collector.full_name}}-->
<!--                                                                            {% endif %}-->
<!--                                                                        </td>-->
<!--                                                                        <td>-->
<!--                                                                            {{specimen.current_sample_amount}}/{{specimen.submitted_sample_amount}}-->
<!--                                                                            {{specimen.type.unit.name}}-->
<!--                                                                        </td>-->
<!--                                                                        <td>{{specimen.condition}}</td>-->
<!--                                                                        <td>-->
<!--                                                                            {% if specimen.evidence_comments %}-->
<!--                                                                                {% for evidence_comment in specimen.evidence_comments.split('\n') %}-->
<!--                                                                                    {{evidence_comment}}<br>-->
<!--                                                                                {% endfor %}-->
<!--                                                                            {% endif %}-->
<!--                                                                        </td>-->
<!--                                                                        <td>{{specimen.notes}}</td>-->
<!--                                                                        <td>{{item.created_by}}</td>-->
<!--                                                                        <td>{{item.create_date.strftime("%m/%d/%Y %H%M")}}</td>-->
<!--                                                                    </tr>-->
<!--                                                                {% endif %}-->
<!--                                                            {% endfor %}-->
<!--                                                            </tbody>-->
<!--                                                        </table>-->
<!--                                                    </div>-->
<!--                                                </div>-->
<!--                                            </td>-->
<!--                                        </tr>-->
<!--                                    {% endfor %}-->
<!--                                </tbody>-->
<!--                            </table>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
<!--        {% endif %}-->
        <!-- TESTS -->
    {% if current_user.permissions in ['Admin', 'Developer', 'FLD', 'Owner', 'FLD-MethodDevelopment', 'FLD-Administrative', 'ADM-Management'] %}
        <div class="card">
            <div class="card-header view-card-header" id="tests_heading">
                <button class="btn btn-link chevron-btn" data-toggle="collapse" data-target="#tests" aria-expanded="true" aria-controls="tests">
                    <span><i class="fa-solid fa-chevron-down mr-2 chevron" style="border: '#FF0000'"></i></span>
                    Tests
                </button>
            </div>
            <div class="collapse show" id="tests" aria-labelledby="tests_heading">
                <div class="card-body">
                    <div>
                        <a href="#!" id="tests-show-all">Show All</a> |
                        <a href="#!" id="tests-collapse-all">Collapse All</a>
                    </div>
                    <div class="table display">
                        <div class="table-responsive">
                            <table class="display small display nowrap" style="width:100%" id="test_table">
                                <thead id="main">
                                <tr>
                                    <th class="click"></th>
                                    <th></th>
                                    <th>Discipline</th>
                                    <th>Assay</th>
                                    <th>Batch</th>
                                    <th>Test Status</th>
                                    <th>Test</th>
                                    <th>Finalized Date and Time</th>
                                    <th>Dilution</th>
                                    <th>Directives</th>
                                    <th>Comments</th>
                                    <th>Specimen Accession Number</th>
                                    <th>Specimen Type</th>
                                    <th>Added Date / By</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% if kwargs['tests'] | length > 0 %}
                                {% for test in kwargs['tests'] %}
                                     {% if not test.db_status == 'Removed' or current_user.permissions in ['Admin', 'Owner'] %}
                                        {% if loop.cycle('odd', 'even') == 'even' %}
                                        {% set color = 'white' %}
                                        {% else %}
                                        {% set color = 'rgba(0, 0, 0, .05)' %}
                                        {% endif %}
                                        {% if test.db_status == 'Removal Pending' %}
                                            <tr class="table-danger" style="font-weight: bold">
                                        {% elif test.db_status == 'Removed' %}
                                            <tr class="table-secondary" style="font-weight: bold">
                                        {% else %}
                                            <tr class="main" style="background-color: {{color}}">
                                        {% endif %}
                                            <td style="display: none"></td>
                                            <td class="row-control">
                                                {% if test.id in kwargs['test_ids']  %}
                                                    <a href="#!"><i class="fa-solid fa-square-plus expand"></i></a>
                                                {% endif %}
                                            </td>
                                            <td>{{test.assay.discipline}}</td>
                                            <td>{{test.assay.assay_name}}</td>
                                           
                                            <td>
                                                {% if test.batch %}
                                                    {% set tooltip = kwargs['batches_comment_dict'].get(test.batch.id) %}
                                                    <a href="{{ url_for('batches.view', item_id=test.batch.id) }}"
                                                    data-toggle="tooltip"
                                                    data-html="true"
                                                    title="{{ tooltip | e | default('No batch comments.', true) | safe }}">
                                                        {{ test.batch.batch_id }}
                                                    </a>
                                                {% endif %}
                                            </td>
                                             <td>
                                                {% if test.sequence_check is not none and 'NT' in test.sequence_check %}
                                                    {% if test.id in kwargs['test_comment_dict'].keys() %}
                                                        <a href="#!" data-toggle="tooltip" title="{{kwargs['test_comment_dict'][test.id]}}">{{test.sequence_check}}</a>
                                                    {% else %}
                                                        {{test.sequence_check}}
                                                    {% endif %}
                                                {% elif test.sequence_check_2 is not none and 'NT' in test.sequence_check_2 %}
                                                    {% if test.id in kwargs['test_comment_dict'].keys() %}
                                                        <a href="#!" data-toggle="tooltip" title="{{kwargs['test_comment_dict'][test.id]}}">{{test.sequence_check_2}}</a>
                                                    {% else %}
                                                        {{test.sequence_check_2}}
                                                    {% endif %}
                                                {% else %}
                                                    {% if test.test_status == 'Withdrawn' %}
                                                        {% for result in kwargs['results'] %}
                                                            {% if result.test_id == test.id and result.result_status == 'Withdrawn' %}
                                                                <a href="" data-toggle="tooltip" title="{{result.result_status_update_reason}}">{{test.test_status}}</a>
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% else %}
                                                        {{test.test_status}}
                                                    {% endif %}
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{{url_for('tests.view', item_id=test.id)}}">
                                                   {{test.test_name}}
                                                </a>
                                            </td>
                                            <td>
                                                {% if test.batch %}
                                                    {% if test.batch.batch_status in ['Cancelled', 'Withdrawn'] %}
                                                        N/A
                                                    {% elif test.batch.review_finish_date %}
                                                        {{test.batch.review_finish_date.strftime('%m/%d/%Y %H:%M')}}
                                                    {% endif %}
                                                {% endif %}
                                            </td>
                                            <td>{{test.dilution}}</td>
                                            <td>{{test.directives}}</td>
                                            <td>
                                                {% if test.id in kwargs['test_comment_dict'].keys() %}
                                                <a href="#!" data-toggle="tooltip" title="{{kwargs['test_comment_dict'][test.id]}}">View comments</a>
                                                {% endif %}
                                            </td>
                                            <td>{{test.specimen.accession_number}}</td>
                                            <td>
                                                {% if test.specimen %}
                                                [{{test.specimen.type.code}}]
                                                {% endif %}
                                            </td>
                                            <td>{% if test.create_date %} {{test.create_date.strftime('%m/%d/%Y %H:%M')}}{% endif %} {{test.created_by}}</td>
                                        </tr>
                                        {% if test.id in kwargs['test_ids'] %}
                                        <tr class="hidden_row collapse">
                                            <td colspan="11">
                                                <table class="display table-hover table-striped nowrap ml-5" style="left-margin: 50px;" id="result">
                                                    <thead>
                                                    <tr>
                                                        <th>Result Status</th>
                                                        <th>Result Type</th>
                                                        <th>Component Name</th>
                                                        <th>Result</th>
                                                        <th>Supp. Result</th>
                                                        <th>Qualitative</th>
                                                        <th>Comments</th>
                                                        <th>Drug Class</th>
                                                        <th>Drug Class Rank</th>
                                                        <th>Component Rank</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% if test.id in kwargs['test_ids'] %}
                                                        {% for result in kwargs['results'] %}
                                                            {% if result.test_id == test.id and result.result_status == 'Confirmed' and result.db_status == 'Active' %}
                                                                {% if result.unit %}
                                                                    {% set unit = result.unit.name %}
                                                                {% endif %}
                                                                    <tr>
                                                                        <td>{{result.result_status}}</td>
                                                                        <td>{{result.result_type}}</td>
                                                                        <td>
                                                                            {% if result.component %}
                                                                            <a href="{{url_for('components.view', item_id=result.component_id) }}">
                                                                                {{result.component.name}}
                                                                            </a>
                                                                            {% else %}
                                                                            {{result.component_name}}
                                                                            {% endif %}
                                                                        </td>
                                                                        <td align="right">
                                                                            {{result.result}}
                                                                            {% if result.result_type != 'Not Detected' %}
                                                                            {{unit}}
                                                                            {% endif %}
                                                                        </td>
                                                                        <td align="right">
                                                                            {% if result.supplementary_result %}
                                                                            {{result.supplementary_result}}
                                                                            {% if result.supplementary_result %}
                                                                            {{unit}}
                                                                            {% endif %}
                                                                            {% endif %}
                                                                        </td>
                                                                        <td>{{result.qualitative_reason}}</td>
                                                                        <td>
                                                                            {% if result.id in kwargs['result_comment_dict'].keys() %}
                                                                            <a href="#!" data-toggle="tooltip" title="{{kwargs['result_comment_dict'][result.id]}}">View comments</a>
                                                                            {% endif %}
                                                                        </td>
                                                                        <td>{{result.component.drug_class.name}}</td>
                                                                        {% if item.type.code == 'PM' %}
                                                                            <td>{{result.component.drug_class.pm_rank}}</td>
                                                                        {% elif item.type.code in ['D', 'M', 'P'] %}
                                                                            <td>{{result.component.drug_class.m_d_rank}}</td>
                                                                        {% elif item.type.code == 'X' %}
                                                                            <td>{{result.component.drug_class.x_rank}}</td>
                                                                        {% endif %}
                                                                        <td>{{result.component.rank}}</td>
                                                                    </tr>
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% else %}
                                                        <tr>
                                                            <td colspan="7" style="text-align: center">
                                                                <b>No Result Found</b><br>
                                                                If historical data, check test comments
                                                            </td>
                                                        </tr>
                                                    {% endif %}
                                                    </tbody>
                                                </table>
                                            </td>
                                        </tr>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="11" style="text-align: center; background-color:#F9F9F9">No Tests Added</td>
                                </tr>
                                {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- COMPONENTS -->
        <div class="card">
            <div class="card-header view-card-header" id="components-heading">
                <button class="btn btn-link chevron-btn" data-toggle="collapse" data-target="#components-card-collapse" aria-expanded="false" aria-controls="components">
                    <span><i class="fa-solid fa-chevron-right mr-2 chevron" style="border: '#FF0000'"></i></span>
                    Component/Assay Summary
                </button>
            </div>
            <div class="collapse" id="components-card-collapse" aria-labelledby="components-heading">
                <div class="card-body">
                    <div class="mb-2">
                        {% for specimen in kwargs['specimens'] %}
                            <a class="btn btn-primary specimen-btn">{{specimen.accession_number}} | {{specimen.type.code}}</a>
                        {% endfor %}
                         <a class="btn btn-primary" id="specimen-btn-clear">Clear</a>
                    </div>
                    <div class="table display">
                        <div class="table-responsive">
                            <table class="display table-hover table-striped small nowrap datatable" style="width:100%" id="components-table">
                                <thead>
                                <tr>
                                    <th class="click"></th>
                                    <th>#</th>
                                    <th>Accession Number</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Component</th>
                                    <th>Drug Class</th>
                                    <th>Confirmed Results</th>
                                    <th>Unconfirmed Results</th>
                                    <th>Saturated Results</th>
                                    <th>Trace Results</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for item in kwargs['components'] %}
                                <tr>
                                    <td style="display: none"></td>
                                    <td>{{loop.index}}</td>
                                    <td class="accession-number">{{item['specimen'].accession_number}}</td>
                                    <td>{{item['specimen'].type.code}}</td>
                                    <td>{{item['specimen'].type.name}}</td>
                                    <td>{{item['component'].name}}</td>
                                    <td>{{item['component'].drug_class.name}}</td>
                                    <td>{{item['confirmed_results']}}</td>
                                    <td>{{item['unconfirmed_results']}}</td>
                                    <td>{{item['saturated_results']}}</td>
                                    <td>{{item['trace_results']}}</td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- RESULTS -->
        <div class="card">
            <div class="card-header view-card-header" id="results_heading">
                <button class="btn btn-link chevron-btn" data-toggle="collapse" data-target="#results" aria-expanded="false" aria-controls="results">
                    <span><i class="fa-solid fa-chevron-down mr-2 chevron" style="border: '#FF0000'"></i></span>
                    Results
                </button>
            </div>
            <div class="collapse show" id="results" aria-labelledby="results_heading">
                <div class="card-body">
                    <div class="alert alert-secondary" id="confirmed-only-alert" hidden>Showing only <b>confirmed</b> results. Click the <b>Clear</b> button to show all results.</div>
                    <div class="alert alert-secondary" id="unconfirmed-trace-alert" hidden>Showing <b>Unconfirmed, Trace and Do Not Report</b> results. Click the <b>Clear</b> button to show all results.</div>
                    <div class="alert alert-secondary" id="withdrawn-alert" hidden>Showing only <b>Withdrawn, Omit and DNR</b> results. Click the <b>Clear</b> button to show all results.</div>
                    <a class="btn btn-primary mb-2" id="clear-filter">Clear</a>
                    <a class="btn btn-primary mb-2" id="filter-confirmed" style="display:none;">Confirmed</a>
                    <a class="btn btn-primary mb-2" id="filter-confirmed-saturated">Confirmed, Saturated and Not Tested</a>
                    <a class="btn btn-primary mb-2" id="filter-unconfirmed-trace">Unconfirmed, Trace and Do Not Report</a>
                    <button id="resultsView" class="btn btn-primary mb-2">Results View</button>
                    <button id="testAddView" class="btn btn-primary mb-2">Test Addition View</button>
                    <a class="btn btn-primary mb-2" id="filter-withdrawn">Withdrawn, Omit and DNR</a>
                    <button id="t1-view" class="btn btn-primary mb-2">Toxicology</button>
                    <button id="b1-view" class="btn btn-primary mb-2">Biochemistry</button>
                    <button id="x1-view" class="btn btn-primary mb-2">External</button>
                    <button id="d1-view" class="btn btn-primary mb-2">Drug</button>
                    <div class="table display">
                        <div class="table-responsive">
                            <table class="display table-hover table-striped small nowrap datatable" style="width:100%" id="results_table">
                                <thead>
                                <tr>
                                    <th class="click"></th>
                                    <th></th>
                                    <th>#</th>
                                    <th>Desc.</th>
                                    <th data-column="type">Type</th>
                                    <th>Accession <br> Number</th>
                                    <th>Batch</th>
                                    <th data-column="drug_class">Drug Class</th>
                                    <th data-column="component_name">Component Name</th>
                                    <th>Result</th>
                                    <th>Supplementary Result</th>
                                    <th>Result Status</th>
                                    <th>Result Type</th>
                                    <th>Qualitative</th>
                                    <th>Dilution</th>
                                    <th>Directives</th>
                                    <th>Report Reason</th>
                                    <th>Comments</th>
                                    <th>Assay</th>
                                    <th data-column="batch_date">Batch Date and Time</th>
                                    <th>Test</th>
                                    <th>Discipline</th>
                                    <th>Reported</th>
                                    <th>Primary</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for item in kwargs['results'] %}
                                {% if item.db_status != 'Removed' %}
                                {% if item.unit %}
                                {% set unit = item.unit.name %}
                                {% endif %}
                                {% if item.report_reason is not none and 'ULOQ' in item.report_reason %}
                                    <tr style="background: #e1fffb">
                                {% elif item.component_name not in ['None Detected', 'Not Tested'] and item.component_name in kwargs['result_counts'] and kwargs['result_counts'][item.component_name] == 1 %}
                                    <tr style="background: #fae5d3">
                                {% else %}
                                    <tr>
                                {% endif %}
                                    <td style="display: none"></td>
                                    <td><a href="{{url_for('results.view', item_id=item.id)}}"><i class="fas fa-edit"></i></a></td>
                                    <td>{{loop.index}}</td>
                                    <td>{{item.test.specimen.type.name}}</td>
                                    <td>[{{item.test.specimen.type.code}}]</td>
                                    <td>{{item.test.specimen.accession_number}}</td>
                                    <td>
                                        <a href="{{url_for('batches.view', item_id=item.test.batch.id)}}">
                                            {{item.test.batch.batch_id}}
                                        </a>
                                    </td>                                   
                                    <td>{{item.component.drug_class.name}}</td>
                                    <td>
                                        {% if item.component %}
                                        <a href="{{url_for('components.view', item_id=item.component_id) }}">
                                            {{item.component.name}}
                                        </a>
                                        {% else %}
                                            {{item.component_name}}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{item.result}}
                                        {% if item.result_type != 'Not Detected' %}
                                        {{unit}}
                                        {% endif %}
                                    </td>
                                     <td>
                                        {% if item.supplementary_result %}
                                        {{item.supplementary_result}}
                                        {% if item.supplementary_result %}
                                        {{unit}}
                                        {% endif %}
                                        {% endif %}
                                    </td>
                                    <td id="result-status">{{item.result_status}}
                                        {% if item.result_status_updated == 'Y' %}
                                        <span data-toggle="tooltip" title="{{ item.result_status_update_reason }}" style="color:#007bff;">(Updated)</span>
                                    {% endif %}
                                    </td>
                                    <td>{{item.result_type}}
                                        {% if item.result_type_updated == 'Y' %}
                                        <span data-toggle="tooltip" title="{{ item.result_type_update_reason }}" style="color:#007bff;">(Updated)</span>
                                    {% endif %}
                                    </td>
                                    <td>{{item.qualitative_reason}}</td>
                                    <td>{{item.test.dilution}}</td>
                                    <td>{{item.test.directives}}</td>
                                    <td>{{item.report_reason}}</td>
                                    <td>
                                        {% if item.id in kwargs['result_comment_dict'].keys() %}
                                        <a href="#!" data-toggle="tooltip" title="{{kwargs['result_comment_dict'][item.id]}}">View comments</a>
                                        {% endif %}
                                    </td>
                                      <td>{{item.test.assay.assay_name}}</td>
                                    <td>
                                        {% if item.test.batch %}
                                        {{item.test.batch.extraction_date.strftime('%m/%d/%Y %H:%M')}}
                                        {% endif %}
                                    </td>
                                        
                                    <td>{{item.test.test_name}}</td>
                                    <td>{{ item.test.assay.discipline }}</td>
                                    <td>{{item.reported}}</td>
                                    <td>{{item.primary}}</td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- PT EVALUATIONS-->
        {% if item.type.code == "Q" %}
        <div class="card">
            <div class="card-header view-card-header" id="pt_eval_heading">
                <h5 class="mb-0">
                    <button class="btn btn-link chevron-btn" data-toggle="collapse" data-target="#pt_evals" aria-expanded="false" aria-controls="pt_eval">
                        <span><i class="fa-solid fa-chevron-right mr-2 chevron" style="border: #FF0000"></i></span>
                        PT Evaluations
                    </button>
                </h5>
            </div>
            <div class="collapse" id="pt_evals" aria-labelledby="pt_eval_heading">
                <div class="card-body">
                    {% for item in kwargs['pt_evals'] %}
                    <a href="{{url_for('pt_results.view_eval',item_id=item.result_official)}}">{{item.eval_date.strftime('%m/%d/%Y')}}</a><br>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        <!-- REPORTS -->
        <div class="card">
            <div class="card-header view-card-header" id="report_heading">
                <button aria-controls="reports" aria-expanded="true" class="btn btn-link chevron-btn"
                        data-target="#reports" data-toggle="collapse">
                    <span><i class="fa-solid fa-chevron-down mr-2 chevron" style="border: #FF0000"></i></span>
                    Reports 
                </button>
            </div>
            <div class="collapse show" id="reports" aria-labelledby="reports_heading">
                <div class="card-body">
                    <div class="table display">
                        <div class="table-responsive">
                            <table class="display table-hover table-striped small display nowrap datatable" style="width:100%" id="report_table">
                                <thead>
                                <tr>
                                    <th class="click"></th>
                                    <th>Report Name</th>
                                    <th>Report Name</th>
                                    <th>Discipline</th>
                                    <th>Report Number</th>
                                    <th>Draft Number</th>
                                    <th>Draft Status</th>
                                    <th>CR</th>
                                    <th>CR Date and Time</th>
                                    <th>DR</th>
                                    <th>DR Date and Time</th>
                                    <th>Record</th>
                                    <th>Date Created</th>
                                    <th>Created By</th>
                                    <th>Date Modified</th>
                                    <th>Modified By</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for item in kwargs['reports'] %}
                                <tr>
                                    <td style="display: none"></td>
                                        {% set sensitivity   = (item.case.sensitivity or '')|lower %}
                                        {% set is_restricted = (sensitivity == 'restricted') %}
                                        {% set is_finalized  = ((item.report_status or '')|lower == 'finalized') %}
                                        {% set is_privileged = (current_user.permissions in ['Admin', 'Owner']
                                                                or current_user.initials in ['CSL', 'DSS']) %}

                                        <td>
                                        {# Show the link unless the case is Restricted AND Finalized AND the user is not privileged #}
                                        {% if not (is_restricted and is_finalized and not is_privileged) %}
                                            <a href="{{ url_for('reports.view', item_id=item.id) }}">{{ item.report_name }}</a>
                                        {% else %}
                                            {{ item.report_name }}
                                        {% endif %}
                                    </td>

                                    <td>{{item.report_name}}</td>
                                    <td>{{item.discipline}}</td>
                                    <td>{{item.report_number}}</td>
                                    <td>{{item.draft_number}}</td>
                                    <td>{{item.draft_status}}</td>
                                    <td>
                                        {% if item.case_reviewer %}
                                        {{item.case_reviewer.initials}}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.case_review_date %}
                                        {{item.case_review_date.strftime('%m/%d/%Y %H:%M')}}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.divisional_reviewer %}
                                        {{item.divisional_reviewer.initials}}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.divisional_review_date %}
                                        {{item.divisional_review_date.strftime('%m/%d/%Y %H:%M')}}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.record %}
                                        {{item.record.record_name}}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.create_date %}
                                        {{item.create_date.strftime('%m/%d/%Y %H:%M')}}
                                        {% endif %}
                                    </td>
                                    <td>{{item.created_by}}</td>
                                    <td>
                                        {% if item.modify_date %}
                                        {{item.modify_date.strftime('%m/%d/%Y %H:%M')}}
                                        {% endif %}
                                    </td>
                                    <td>{{item.modified_by}}</td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% elif current_user.permissions in ['MED'] %}
        <div class="card">
            <div class="card-header view-card-header" id="tests_heading">
                <button class="btn btn-link chevron-btn" data-toggle="collapse" data-target="#tests" aria-expanded="true" aria-controls="tests">
                    <span><i class="fa-solid fa-chevron-down mr-2 chevron" style="border: '#FF0000'"></i></span>
                    Tests
                </button>
            </div>
            <div class="collapse show" id="tests" aria-labelledby="tests_heading">
                <div class="card-body">
                    <div class="table display">
                        <div class="table-responsive">
                            <table class="display small display nowrap" style="width:100%" id="test_table">
                                <thead id="main">
                                <tr>
                                    <th>Discipline</th>
                                    <th>Assay</th>
                                    <th>Batch Date and Time</th>
                                    <th>Test Status</th>
                                    <th>Specimen Accession Number</th>
                                    <th>Specimen Type</th>
                                    <th>Dilution</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% if kwargs['tests'] | length > 0 %}
                                {% for test in kwargs['tests'] %}
                                     {% if not test.db_status == 'Removed' or current_user.permissions in ['Admin', 'Owner'] %}
                                        {% if loop.cycle('odd', 'even') == 'even' %}
                                        {% set color = 'white' %}
                                        {% else %}
                                        {% set color = 'rgba(0, 0, 0, .05)' %}
                                        {% endif %}
                                        {% if test.db_status == 'Removal Pending' %}
                                            <tr class="table-danger" style="font-weight: bold">
                                        {% elif test.db_status == 'Removed' %}
                                            <tr class="table-secondary" style="font-weight: bold">
                                        {% else %}
                                            <tr class="main" style="background-color: {{color}}">
                                        {% endif %}
                                            <td>{{test.assay.discipline}}</td>
                                            <td>{{test.assay.assay_name}}</td>
                                            <td>
                                                {% if test.batch %}
                                                    {% if test.batch.extraction_date%}
                                                        {{test.batch.extraction_date.strftime('%m/%d/%Y %H:%M')}}
                                                    {% endif %}
                                                {% endif %}
                                            </td>
                                            <td>{{test.test_status}}</td>
                                            <td>{{test.specimen.accession_number}}</td>
                                            <td>
                                                {% if test.specimen %}
                                                [{{test.specimen.type.code}}]
                                                {% endif %}
                                            </td>
                                            <td>{{test.dilution}}</td>
                                        </tr>
                                        {% if test.id in kwargs['test_ids'] %}
                                        <tr class="hidden_row collapse">
                                            <td colspan="11">
                                                <table class="display table-hover table-striped nowrap ml-5" style="left-margin: 50px;" id="result">
                                                    <thead>
                                                    <tr>
                                                        <th>Result Status</th>
                                                        <th>Result Type</th>
                                                        <th>Component Name</th>
                                                        <th>Result</th>
                                                        <th>Supp. Result</th>
                                                        <th>Qualitative</th>
                                                        <th>Comments</th>
                                                        <th>Drug Class</th>
                                                        <th>Drug Class Rank</th>
                                                        <th>Component Rank</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% if test.id in kwargs['test_ids'] %}
                                                        {% for result in kwargs['results'] %}
                                                            {% if result.test_id == test.id and result.result_status == 'Confirmed' %}
                                                                {% if result.unit %}
                                                                    {% set unit = result.unit.name %}
                                                                {% endif %}
                                                                    <tr>
                                                                        <td>{{result.result_status}}
                                                                            {% if result.result_status_updated == 'Y' %}
                                                                            true
                                                                            <span data-toggle="tooltip" title="{{ result.result_status_update_reason }}">(Updated)</span>
                                                                        {% endif %}
                                                                        </td>
                                                                        <td>{{result.result_type}}
                                                                            {% if result.result_type_updated == 'Y' %}
                                                                            <span data-toggle="tooltip" title="{{ result.result_type_update_reason }}">(Updated)</span>
                                                                        {% endif %}
                                                                        </td>
                                                                        <td>
                                                                            {% if result.component %}
                                                                            <a href="{{url_for('components.view', item_id=result.component_id) }}">
                                                                                {{result.component.name}}
                                                                            </a>
                                                                            {% else %}
                                                                            {{result.component_name}}
                                                                            {% endif %}
                                                                        </td>
                                                                        <td align="right">
                                                                            {{result.result}}
                                                                            {% if result.result_type != 'Not Detected' %}
                                                                            {{unit}}
                                                                            {% endif %}
                                                                        </td>
                                                                        <td align="right">
                                                                            {% if result.supplementary_result %}
                                                                            {{result.supplementary_result}}
                                                                            {% if result.supplementary_result %}
                                                                            {{unit}}
                                                                            {% endif %}
                                                                            {% endif %}
                                                                        </td>
                                                                        <td>{{result.qualitative_reason}}</td>
                                                                        <td>
                                                                            {% if result.id in kwargs['result_comment_dict'].keys() %}
                                                                            <a href="#!" data-toggle="tooltip" title="{{kwargs['result_comment_dict'][result.id]}}">View comments</a>
                                                                            {% endif %}
                                                                        </td>
                                                                        <td>{{result.component.drug_class.name}}</td>
                                                                        {% if item.type.code == 'PM' %}
                                                                            <td>{{result.component.drug_class.pm_rank}}</td>
                                                                        {% elif item.type.code in ['D', 'M', 'P'] %}
                                                                            <td>{{result.component.drug_class.m_d_rank}}</td>
                                                                        {% elif item.type.code == 'X' %}
                                                                            <td>{{result.component.drug_class.x_rank}}</td>
                                                                        {% endif %}
                                                                        <td>{{result.component.rank}}</td>
                                                                    </tr>
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% else %}
                                                        <tr>
                                                            <td colspan="7" style="text-align: center">
                                                                <b>No Result Found</b><br>
                                                                If historical data, check test comments
                                                            </td>
                                                        </tr>
                                                    {% endif %}
                                                    </tbody>
                                                </table>
                                            </td>
                                        </tr>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="11" style="text-align: center; background-color:#F9F9F9">No Tests Added</td>
                                </tr>
                                {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
        <!-- RECORDS -->
        <div class="card">
            <div class="card-header view-card-header" id="records_heading">
                <button class="btn btn-link chevron-btn" data-toggle="collapse" data-target="#records" aria-expanded="true" aria-controls="records">
                    <span><i class="fa-solid fa-chevron-down mr-2 chevron" style="border: #FF0000"></i></span>
                    Records
                </button>
            </div>
            <div class="collapse show" id="records" aria-labelledby="records_heading">
                <div class="card-body">
                    <div class="table display">
                        <div class="table-responsive">
                            <table class="display table-hover table-striped small display nowrap datatable" style="width:100%" id="record_table">
                                <thead>
                                <tr>
                                    <th class="click"></th>
                                    <th>Record Name</th>
                                    <th>Record Status</th>
                                    <th>Record Type</th>
                                    <th>Record Number</th>
                                    <th>Dissemination Date</th>
                                    <th>Disseminated By</th>
                                    <th>Disseminated To</th>
                                    <th>Comments</th>
                                    <th>Date Created</th>
                                    <th>Created By</th>
                                    <th>Date Modified</th>
                                    <th>Modified By</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for item in kwargs['records'] %}
                                <tr>
                                    <td style="display: none"></td>
                                    {% set sensitivity = (item.case.sensitivity or '')|lower %}
                                    {% set is_restricted = (sensitivity == 'restricted') %}
                                    {% set is_privileged = (current_user.permissions in ['Admin', 'Owner']
                                                            or current_user.initials in ['CSL', 'DSS']) %}

                                    <td>
                                    {% if (not is_restricted) or (is_restricted and is_privileged) %}
                                        <a href="{{ url_for('records.view', item_id=item.id) }}">{{ item.record_name }}</a>
                                    {% else %}
                                        {{ item.record_name }}
                                    {% endif %}
                                    </td>
                                    <td>{{item.record_status}}</td>
                                    <td>{{item.type.name}}</td>
                                    <td>{{item.record_number}}</td>
                                    <td>
                                        {% if item.dissemination_date %}
                                        {{item.dissemination_date.strftime('%m/%d/%Y')}}
                                        {% endif %}
                                    </td>
                                    <td>{{item.disseminated_by}}</td>
                                    <td>{{item.disseminated_to}}</td>
                                

                                    <td>{{item.general_comments}}</td>                               
                                    <td>
                                        {% if item.create_date %}
                                        {{item.create_date.strftime('%Y-%m-%d %H:%M:%S')}}
                                        {% endif %}
                                    </td>
                                    <td>{{item.created_by}}</td>
                                    <td>
                                        {% if item.modify_date %}
                                        {{item.modify_date.strftime('%Y-%m-%d %H:%M:%S')}}
                                        {% endif %}
                                    </td>
                                    <td>{{item.modified_by}}</td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- BOOKINGS -->
    {% if current_user.permissions in ['Admin', 'Developer', 'FLD', 'Owner', 'FLD-MethodDevelopment', 'FLD-Administrative', 'ADM-Management'] %}
        <div class="card">
            <div class="card-header view-card-header" id="bookings_heading">
                <button class="btn btn-link chevron-btn" data-toggle="collapse" data-target="#bookings" aria-expanded="true" aria-controls="bookings">
                    <span><i class="fa-solid fa-chevron-down mr-2 chevron" style="border: #FF0000"></i></span>
                    Bookings
                </button>
            </div>
            <div class="collapse show" id="bookings" aria-labelledby="bookings_heading">
                <div class="card-body">
                    <div class="table display">
                        <div class="table-responsive">
                            <table class="display table-striped table-hover small nowrap datatable" style="width:100%" id="bookings_table">
                                <thead>
                                <tr>
                                    <th class="click"></th>
                                    <th>View</th>
                                    <th>Status</th>
                                    <th>Case</th>
                                    <th>Subject</th>
                                    <th>Expert</th>
                                    <th>Date</th>
                                    <th>Purpose</th>
                                    <th>Agency Met With/Subpoena'd By</th>
                                    <th>Name Met With/Subpoena'd</th>
                                    <th>Change (e.g., cancelled, rescheduled, no-show)</th>
                                    <th>Format</th>
<!--                                    <th>Location</th>-->
<!--                                    <th>Others Present</th>-->
                                    <th>Crossed-By, if Court</th>
<!--                                    <th>Start</th>-->
<!--                                    <th>Finish</th>-->
<!--                                    <th>Drive Time</th>-->
<!--                                    <th>Excluded Time (e.g., lunch)</th>-->
<!--                                    <th>Waiting Time</th>-->
<!--                                    <th>Total Testifying Time</th>-->
<!--                                    <th>Total Work Time</th>-->
                                    <th>Information Provided</th>
                                    <th>Topics Discussed</th>
                                    <th>Legacy Transferred</th>
                                    <th>Date Created</th>
                                    <th>Created By</th>
                                    <th>Date Modified</th>
                                    <th>Modified By</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for booking in kwargs['bookings'] %}
                                <tr>
                                    <td style="display: none"></td>
                                    <td>
                                        <a href="{{url_for('bookings.view', item_id=booking.id)}}">
                                            View
                                        </a>
                                    </td>
                                    <td>{{booking.db_status}}</td>
                                    <td>{{booking.case.case_number}}</td>
                                    <td>{{booking.case.last_name}}, {{booking.case.first_name}} {{booking.case.middle_name}}</td>
                                    <td>{{booking.expert.initials}}</td>
                                    <td>{{booking.date.strftime('%A, %B %d, %Y')}}</td>
                                    <td>{{booking.purpose.name}}</td>
                                    <td>{{booking.agency_A.name}}</td>
                                    <td>{{booking.person_A1.full_name}}</td>
                                    <td>{{booking.change.name}}</td>
                                    <td>{{booking.format.name}}</td>
<!--                                    <td>{{booking.location}}</td>-->
<!--                                    <td>{{booking.others_present}}</td>-->
                                    <td>{{booking.cross_examined}}</td>
<!--                                    <td>{{booking.start}}</td>-->
<!--                                    <td>{{booking.finish}}</td>-->
<!--                                    <td>{{booking.drive_time}}</td>-->
<!--                                    <td>{{booking.excluded_time}}</td>-->
<!--                                    <td>{{booking.waiting_time}}</td>-->
<!--                                    <td>{{booking.total_testifying_time}}</td>-->
<!--                                    <td>{{booking.total_work_time}}</td>-->
                                    <td>
                                        {% if booking.information_provider %}
                                        {% for info in booking.information_provider.split(', ') %}
                                        {{kwargs['booking_info_provider'].query.get(info|int).name}};
                                        {% endfor %}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if booking.topics_discussed %}
                                        {% for info in booking.topics_discussed.split(', ') %}
                                        <ul>{{kwargs['booking_info_provided'].query.get(info|int).name}}</ul>
                                        {% endfor %}
                                        {% endif %}
                                    </td>
                                    <td>{{booking.legacy_transferred}}</td>
                                    {% if booking.create_date == None %}
                                    <td></td>
                                    {% else %}
                                    <td>{{booking.create_date.strftime('%m/%d/%Y %H:%M')}}</td>
                                    {% endif %}
                                    <td>{{booking.created_by}}</td>

                                    {% if booking.modify_date == None %}
                                    <td></td>
                                    {% else %}
                                    <td>{{booking.modify_date.strftime('%m/%d/%Y %H:%M')}}</td>
                                    {% endif %}
                                    <td>{{booking.modified_by}}</td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- LITIGATION PACKETS -->
        <div class="card">
            <div class="card-header view-card-header" id="litigation_packets_heading">
                <h5 class="mb-0">
                    <button class="btn btn-link chevron-btn" data-toggle="collapse" data-target="#litigation_packets" aria-expanded="true" aria-controls="litigation_packets">
                        <span><i class="fa-solid fa-chevron-right mr-2 chevron" style="border: #FF0000"></i></span>
                        Packets
                    </button>
                </h5>
            </div>
            <div class="collapse" id="litigation_packets" aria-labelledby="litigation_packets_heading">
                <div class="card-body">
                    <div class="table display">
                        <div class="table-responsive">
                            <table class="display table-hover table-striped small display nowrap" style="width:100%" id="litigation_packets_table">
                                <thead>
                                <tr>
                                    <th class="click"></th>
                                    <th>Packet Name</th>
                                    <th>Status</th>
                                    <th>Requested Agency</th>
                                    <th>Requested Division</th>
                                    <th>Requested Personnel</th>
                                    <th>Requested Date</th>
                                    <th>Due Date</th>
                                    <th>Delivery Date</th>
                                    <th>Delivered Agency</th>
                                    <th>Delivered Division</th>
                                    <th>Delivered Personnel</th>
                                    <th>Number of Pages</th>
                                    <th>Postage and Delivery</th>
                                    <th>Additional Costs</th>
                                    <th>Total Costs</th>
                                    <th>Paid Date</th>
                                    <th>PP</th>
                                    <th>PR</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for packet in kwargs['packets'] %}
                                <tr>
                                    <td style="display: none"></td>
                                    <td><a href="/litigation_packets/{{packet.id}}">{{ packet.packet_name }}</a></td>
                                    <td class="packet_status">{{packet.packet_status}}</td>
                                    <td>{{ packet.agency.name }}</td>
                                    <td>{{ packet.division.name }}</td>
                                    <td>{{ packet.personnel.full_name }}</td>
                                    <td>{{ packet.requested_date.strftime('%Y-%m-%d') if packet.requested_date else '' }}</td>
                                    <td>{{ packet.due_date.strftime('%Y-%m-%d') if packet.due_date else '' }}</td>
                                    <td>{{ packet.delivery_date.strftime('%Y-%m-%d') if packet.delivery_date else '' }}</td>
                                    <td>{{ packet.del_agency.name }}</td>
                                    <td>{{ packet.del_division.name }}</td>
                                    <td>{{ packet.del_personnel.full_name }}</td>
                                    <td>{{ packet.n_pages }}</td>
                                    <td>{{ packet.postage_and_delivery }}</td>
                                    <td>{{ packet.additional_costs }}</td>
                                    <td>{{ packet.total_costs }}</td>
                                    <td>{{ packet.paid_date }}</td>

                                    <td>{% if packet.litigation_preparer  %}
                                        {{ packet.prep_user.initials }} {{ packet.litigation_prepare_date.strftime('%Y-%m-%d %H:%M') if packet.litigation_prepare_date else 'N/A' }}
                                        {% endif %}
                                    </td>

                                    <td>{% if packet.litigation_reviewer %}
                                        {{ packet.rev_user.initials }} {{ packet.litigation_review_date.strftime('%Y-%m-%d %H:%M') if packet.litigation_review_date else 'N/A' }}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <div class="card">
            <div class="card-header view-card-header" id="requests-heading">
                <h5 class="mb-0">
                    <button class="btn btn-link chevron-btn" data-toggle="collapse" data-target="#requests" aria-expanded="true" aria-controls="requests">
                        <span><i class="fa-solid fa-chevron-right mr-2 chevron" style="border: #FF0000"></i></span>
                        Requests
                    </button>
                </h5>
            </div>
            <div class="collapse" id="requests" aria-labelledby="requests-heading">
                <div class="card-body">
                    <div class="table display">
                        <div class="table-responsive">
                            <table class="display table-hover table-striped small display nowrap" style="width:100%" id="requests-table">
                                <thead>
                                <tr>
                                    <th class="click"></th>
                                    <th>Name</th>
                                    <th>Request Type</th>
                                    <th>Status</th>
                                    <th>Due Date</th>
                                    <th>Requesting Agency</th>
                                    <th>Requesting Division</th>
                                    <th>Requesting Personnel</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for request in kwargs['requests'] %}
                                <tr>
                                    <td style="display: none"></td>
                                    {% if current_user.permissions in ['Admin', 'Owner', 'FLD', 'FLD-Administrative'] %}
                                    <td>
                                        <a href="{{url_for('requests.view', item_id=request.id)}}">
                                            {{request.name}}
                                        </a>
                                    </td>
                                    {% else %}
                                    <td>{{request.name}}</td>
                                    {% endif %}
                                    <td>{{request.request_type.name}}</td>
                                    <td>{{request.status}}</td>
                                    <td>{% if request.due_date %} {{request.due_date.strftime('%m/%d/%Y')}} {% endif %}</td>
                                    <td>{{request.agency_req.name}}</td>
                                    <td>{{request.division_req.name}}</td>
                                    <td>{{request.personnel_req.full_name}}</td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

                <div class="card">
                    <div class="card-header view-card-header" id="attachments">
                        <button class="btn btn-link chevron-btn" data-toggle="collapse" data-target="#attachments-coll" aria-expanded="false" aria-controls="attachments">
                            <span><i class="fa-solid fa-chevron-right mr-2 chevron" style="border: '#FF0000'"></i></span>
                            Attachments
                        </button>
                    </div>
                    <div id="attachments-coll" class="collapse" aria-labelledby="attachments-heading">
                        <div class="card-body">
                            <div class="table display">
                                <div class="table-responsive">
                                    <table class="display table-striped table-hover nowrap small view-table" style="width:100%;" id="attachments-table">
                                        <thead>
                                        <tr>
                                            <th class="click"></th>
                                            <th>Delete</th>
                                            <th>Case/<br>Container/<br>Other</th>
                                            <th>Case Number/<br>Accession Number/<br>ID</th>
                                            <th>File Name</th>
                                            <th>Save Name</th>
                                            <th>Type</th>
                                            <th>Source</th>
                                            <th>Description</th>
                                            <th>Added By</th>
                                            <th>Add Date</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% for attachment in attachments %}
                                        {% set table, name = module_definitions[attachment.table_name][0], module_definitions[attachment.table_name][2] %}
                                        <tr>
                                            <td style="display: none"></td>
                                            <td>{% if current_user.permissions != 'ADM-Management' %}<a href="{{url_for('attachments.delete', item_id=attachment.id)}}" class="btn btn-danger btn-size"><i class="fa fa-trash-o btn-icon" style="font-size:10px"></i></a> {%endif %}</td>
                                            <td>{{attachment.table_name}}</td>
                                            <td>{{ table.query.get(attachment.record_id).__dict__[name]}}</td>
                                            <td>
                                                {% if attachment.name.split('.')[1] in ['pdf', 'jpg', 'png'] %}
                                                    <a href="../static/filesystem/attachments/{{attachment.table_name}}/{{attachment.record_id}}/{{attachment.save_name}}" target="_blank">{{attachment.name}}</a>
                                                {% else %}
                                                    <a href="../static/filesystem/attachments/{{attachment.table_name}}/{{attachment.record_id}}/{{attachment.save_name}}" download>{{attachment.name}}</a>
                                                {% endif %}
                                            </td>
                                            <td>{{attachment.save_name}}</td>
                                            <td>{{attachment.type.name}}</td>
                                            <td>{{attachment.type.source}}</td>
                                            <td>{{attachment.description}}</td>
                                            <td>{{attachment.created_by}}</td>
                                            <td>
                                                {% if attachment.create_date %}
                                                    {{attachment.create_date.strftime('%m/%d/%Y %H:%M')}}
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

{% endif %}

{% endblock %}

{% block modals %}
{% set _has_role = current_user.permissions in ['Admin', 'Owner'] %}
{% set _is_whitelisted_initials = current_user.initials in ['CSL', 'DSS'] %}

{% set _must_block_case = (item.sensitivity == 'Restricted')
    and (item.cod_a is string)
    and (item.cod_a | trim | length > 0)
    and ((item.cod_a | trim | upper) != 'PENDING')
    and (not _has_role)
    and (not _is_whitelisted_initials) %}

{% if _must_block_case %}
  <div class="restrict-overlay" id="restrictOverlay" role="dialog" aria-modal="true" aria-labelledby="restrictTitle">
    <div class="restrict-modal-box">
      <h3 id="restrictTitle">Restricted Case</h3>
      <p>See management for access.</p>
      <div class="restrict-actions">
        <a class="restrict-exit" href="{{ url_for('cases.view_list') }}">Exit</a>
      </div>
    </div>
  </div>
  <script>
    (function() {
      // Trap focus and block ESC closes
      const o = document.getElementById('restrictOverlay');
      const exitBtn = o.querySelector('.restrict-exit');
      if (exitBtn) exitBtn.focus();
      document.addEventListener('keydown', e => { if (e.key === 'Escape') e.preventDefault(); }, true);

      // Swallow clicks outside the modal
      o.addEventListener('click', function(e){
        const box = o.querySelector('.restrict-modal-box');
        if (!box.contains(e.target)) { e.stopPropagation(); e.preventDefault(); }
      }, true);

      // Block background scroll
      document.body.style.overflow = 'hidden';
    })();
  </script>
{% endif %}



    <!-- REMOVE ITEM -->
    <div class="modal" tabindex="-1" role="dialog" id="remove-modal">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Remove {{alias}}?</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form action="{{ url_for(table_name~'.remove', item_id=item.id) }}" method="POST">
                    <div class="modal-body">
                        <p>Are you sure you want to remove <b>{{alias}}</b>?</p>
                        <label>Please enter the reason for removal.</label>
                        <div class="form-group">
                            <textarea class="form-control" name="reason" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <input class="btn btn-danger" type="submit" value="Remove">
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Approve case and all evidence modal -->
    <div class="modal" tabindex="-1" role="dialog" id="approve-all" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm approval</h5>
                </div>
                <div class="modal-body">
                    <p>By clicking on "Confirm", you <b>({{current_user.initials}})</b> confirm that the details for the following are correct:</p>
                    {% if not kwargs['case_approved'] %}
                        <b>Case</b>
                        <li>{{item.case_number}}</li>
                    {% endif %}
                    {% if kwargs['pending_containers'].count() %}
                        <b>Containers</b>
                        {% for container in kwargs['pending_containers'] %}
                            {% if container.pending_submitter %}
                                <li>{{container.accession_number}} | {{container.type.name}}</li>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    {% if kwargs['pending_specimens'].count() %}
                        <b><li class="list-unstyled">Specimens</li></b>
                        {% for specimen in kwargs['pending_specimens'] %}
                            {% if specimen.pending_submitter %}
                                <li>{{specimen.accession_number}} | {{specimen.type.name}}</li>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
                    <form class="form" action="{{ url_for(table_name~'.approve_all', item_id=item.id) }}" method="POST" enctype="multipart/form-data">
                        <div class="modal-body">
                            {% if kwargs['specimens_in_custody'] %}
                            <p>The following specimen(s) are in your possession. Please select their next location.</p>
                            {% for specimen in kwargs['specimens_in_custody'] %}
                                <div class="row" style="margin-bottom:10px">
                                    <div class="col-md-1" style="align-content:center">
                                        <label name="label" style="margin-bottom: 0px">{{specimen.accession_number}}</label>
                                        <input name="specimen-id" value="{{specimen.id}}" hidden>
                                    </div>
                                    <div class="col-md-5">
                                        <select class="form-control selectpicker custody-type" name="custody-type" required>
                                            <option value="0">Please select a custody type</option>
                                            <option value="Benches">Benches</option>
                                            <option value="Cabinets">Cabinets</option>
                                            <option value="Hoods">Hoods</option>
                                            <option value="Person">Person</option>
                                            <option value="Cooled Storage">Cooled Storage</option>
                                            <option value="Evidence Lockers">Evidence Lockers</option>
                                            <option value="Evidence Storage">Evidence Storage</option>
                                            <option value="Rooms">Room</option>
                                        </select>
                                    </div>
                                    <div class="col-md-5 hello">
                                        <select class="form-control selectpicker custody" name="custody" required>
                                            <option value="0">No custody type selected</option>
                                        </select>
                                        <div class="invalid-feedback custody-invalid"></div>
                                    </div>
                                </div>
                            {% endfor %}
                            {% endif %}
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" type="submit">Confirm</button>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>



<!-- Approve case and selected evidence modal -->
<div class="modal" tabindex="-1" role="dialog" id="approve-select" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Please select the items you wish to approve.</h5>
            </div>
            <form class="form" id="approve-select-form" name="form" action="{{ url_for(table_name~'.approve_selected', item_id=item.id) }}" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    {% if not kwargs['case_approved'] %}
                    <div class="form-group">
                        <b><label>Do you wish to approve the case details for {{item.case_number}}?</label></b><span style="color: red">*</span>
                        <select class="form-control selectpicker" id="approve-case" name="approve-case">
                            <option value="0">Please select an answer</option>
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                        <div class="invalid-feedback" id="approve-case-invalid"></div>
                    </div>
                    {% endif %}
                    {% if kwargs['pending_containers'].count() %}
                        <div class="form-group">
                            <b><label>Containers</label></b>
                            <select class="form-control selectpicker" name="approved-containers" id="container-select" multiple>
                                {% for container in kwargs['pending_containers'] %}
                                    {% if container.pending_submitter %}
                                        <option value="{{container.id}}">{{container.accession_number}} | {{container.type.name}}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                    {% endif %}
                    {% if kwargs['pending_specimens'].count() %}
                        <div class="form-group">
                            <b><label>Specimens</label></b>
                            <select class="form-control selectpicker" name="approved-specimens" id="specimen-select" multiple>
                                {% for specimen in kwargs['pending_specimens'] %}
                                    {% if specimen.pending_submitter %}
                                        <option value="{{specimen.id}}">{{specimen.accession_number}} | {{specimen.type.name}}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                    {% endif %}
                    {% if kwargs['specimens_in_custody'] | count %}
                        <p>The following specimen(s) are in your possession. Please select their next location.</p>
                        {% for specimen in kwargs['specimens_in_custody'] %}
                            <div class="row specimen-row" style="margin-bottom:10px" id="{{specimen.id}}">
                                <div class="col-md-1" style="align-content:center">
                                    <label name="label" style="margin-bottom: 0px">{{specimen.accession_number}}</label>
                                    <input name="specimen-id" value="{{specimen.id}}" hidden>
                                </div>
                                <div class="col-md-5">
                                    <select class="form-control selectpicker custody-type" name="custody-type" disabled>
                                        <option value="0">Please select a custody type</option>
                                        <option value="Benches">Benches</option>
                                        <option value="Cabinets">Cabinets</option>
                                        <option value="Hoods">Hoods</option>
                                        <option value="Person">Person</option>
                                        <option value="Cooled Storage">Cooled Storage</option>
                                        <option value="Evidence Lockers">Evidence Lockers</option>
                                        <option value="Evidence Storage">Evidence Storage</option>
                                        <option value="Rooms">Room</option>
                                    </select>
                                </div>
                                <div class="col-md-5">
                                    <select class="form-control selectpicker custody" name="custody" disabled>
                                        <option value="0">No custody type selected</option>
                                    </select>
                                    <div class="invalid-feedback custody-invalid"></div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" type="submit">Approve</button>
                    <button type="button" class="btn btn-secondary" onclick="clearModal()">Close</button>
                </div>
            </form>
        </div>
    </div>
</div>
        <!-- Set location for specimen in user possession -->
        <!--Need to make sure to add specimen audit to cases\views.py-->
<div class="modal" tabindex="-1" role="dialog" id="specimen_audit">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Specimen in your possession</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form class="form" action="{{ url_for(table_name~'.unlock', item_id=item.id) }}" name="form" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    {% if current_user.permissions in ['Admin', 'Owner'] and kwargs['specimens_in_custody']|length == 0 %}
                        <p>The following specimen(s) are in someone's custody.</p>
                        {% set specimens = kwargs['admin_specimens_in_custody'] %}
                        {% set admin = True %}
                    {% else %}
                        <p>The following specimen(s) are in your possession. Please select their next location.</p>
                        {% set specimens = kwargs['specimens_in_custody'] %}
                        {% set admin = False %}
                    {% endif %}
                    {% for specimen in specimens %}
                        <div class="row specimen-row" style="margin-bottom:10px">
                            <div class="col-md-2" style="align-content:center">
                                <label name="label" style="margin-bottom: 0px">{{specimen.accession_number}}</label>
                                <input name="specimen-id" value="{{specimen.id}}" hidden>
                            </div>
                            <div class="col-md-5">
                                <select class="form-control selectpicker custody-type" id="custody-type" name="custody-type">
                                    <option value="0">Please select a custody type</option>
                                    <option value="Benches">Benches</option>
                                    <option value="Cabinets">Cabinets</option>
                                    <option value="Hoods">Hoods</option>
                                    <option value="Person">Person</option>
                                    <option value="Cooled Storage">Cooled Storage</option>
                                    <option value="Evidence Lockers">Evidence Lockers</option>
                                    <option value="Evidence Storage">Evidence Storage</option>
                                    <option value="Rooms">Room</option>
                                </select>
                            </div>
                            <div class="col-md-5">
                                <select class="form-control selectpicker custody" id="custody" name="custody">
                                    <option value="0">No custody type selected</option>
                                </select>
                                <div class="invalid-feedback custody-invalid"></div>
                            </div>
                            {% if admin %}
                                <div class="col-md-4">
                                    <input placeholder="Reason" class="form-control" name="reason" id="reason">
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" type="submit">Submit</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="modal" tabindex="-1" id="edit-specimen" data-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Specimen</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p style="text-align:center;">
                    By proceeding, you will take custody of the selected specimen.
                    You will need to select the next custody location when submitting the form.
                </p>
                <p style="text-align:center;">Do you wish to proceed?</p>

            </div>
            <!--buttons go below-->
            <div class="modal-footer" style="justify-content:center;">
                <a class="btn btn-primary mr-3" style="width: 12rem" href="#" id="proceed">Go to Edit Form</a>
                <a class="btn btn-secondary ml-3" style="width: 10rem" href="#" id="view-only">View Only</a>
                <a class="btn btn-secondary ml-3" style="width: 12rem" data-dismiss="modal">Cancel</a>
            </div>
        </div>
    </div>
</div>

<!--UPDATE ALTERNATE START DATE MODAL-->
{% for discipline in kwargs['disciplines'] %}
  {% set disc_lower = discipline.lower() %}
  <div class="modal fade" tabindex="-1" id="edit-{{ disc_lower }}-modal" role="dialog" aria-labelledby="editModalLabel-{{ disc_lower }}" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
      <div class="modal-content">
        <form method="POST" autocomplete="off">
          {{ kwargs.alternate_start_date_form.hidden_tag() }}
          <input type="hidden" name="item_id" value="{{ item.id }}">
          <input type="hidden" name="column_name" value="{{ disc_lower }}_alternate_start_date">

          <div class="modal-header">
            <h9 class="modal-title" id="editModalLabel-{{ disc_lower }}">Edit {{ discipline }} Start Date</h9>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
         <!-- Date input -->
            {{ kwargs.alternate_start_date_form[disc_lower ~ '_alternate_start_date'](
            class="form-control mb-3",
            id=disc_lower ~ '_calendar_input',
            autocomplete="off",
            placeholder="Select date"
            ) }}

            <!-- Time input -->
            {{ kwargs.alternate_start_date_form[disc_lower ~ '_alternate_start_time'](
            class="form-control mb-3",
            id=disc_lower ~ '_time_input',
            autocomplete="off",
            placeholder="Select time"
            ) }}
            <!-- Submit button -->
            {{ kwargs.alternate_start_date_form.alternate_date_submit(
                class="btn btn-primary w-100"
            ) }}

          </div>
        </form>
      </div>
    </div>
  </div>
{% endfor %}

<!-- UPDATE ALTERNATE START DATE  Flatpickr JS/CSS  -->
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    {% for discipline in kwargs['disciplines'] %}
    // Date Picker
    flatpickr("#{{ discipline.lower() }}_calendar_input", {
        dateFormat: "m/d/Y",   // Sends "07/16/2025"
        allowInput: true
    });

    // Time Picker
    flatpickr("#{{ discipline.lower() }}_time_input", {
        enableTime: true,
        noCalendar: true,
        dateFormat: "H:i",     // Sends "14:30" (24-hour format)
        time_24hr: true,
        allowInput: true
    });
    {% endfor %}
});
</script>    
<!-- Update Priority Modal -->
<div class="modal fade" id="edit-priority-modal" tabindex="-1" role="dialog" aria-labelledby="editSensitivityLabel" aria-hidden="true" data-backdrop="static">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <form method="POST">
        {{ kwargs.update_priority_form.hidden_tag() }}
        <input type="hidden" name="item_id" value="{{ item.id }}">
       
        

        <div class="modal-header">
          <h5 class="modal-title" id="editpriorityLabel">Edit priority</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body">
          {{ kwargs.update_priority_form.priority(
              class="form-control",
              id="priority-select",
              placeholder="Select priority"
          ) }}
        </div>

        <div class="modal-footer">
          {{ kwargs.update_priority_form.priority_submit(
                class="btn btn-primary w-100"
            ) }}


        </div>
      </form>
    </div>
  </div>
</div>

<!-- Update Sensitivity Modal -->
<div class="modal fade" id="edit-sensitivity-modal" tabindex="-1" role="dialog" aria-labelledby="editSensitivityLabel" aria-hidden="true" data-backdrop="static">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <form method="POST">
        {{ kwargs.update_sensitivity_form.hidden_tag() }}
        <input type="hidden" name="item_id" value="{{ item.id }}">
       
        

        <div class="modal-header">
          <h5 class="modal-title" id="editSensitivityLabel">Edit Sensitivity</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body">
          {{ kwargs.update_sensitivity_form.sensitivity(
              class="form-control",
              id="sensitivity-select",
              placeholder="Select sensitivity"
          ) }}
        </div>

        <div class="modal-footer">
          {{ kwargs.update_sensitivity_form.sensitivity_submit(
                class="btn btn-primary w-100"
            ) }}


        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}



{% block scripts %}
<script>
  (function() {
    // Add the blur class to the <html> element so it affects the whole page
    document.documentElement.classList.add('restrict-blur');
    // Block background scroll
    document.body.style.overflow = 'hidden';

    // Keep focus inside the overlay
    const overlay = document.getElementById('restrictOverlay');
    const focusable = overlay.querySelector('.restrict-exit');
    if (focusable) focusable.focus();

    // Prevent closing with ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') e.preventDefault();
    }, true);

    // Eat all clicks on the overlay background so nothing behind it is interactable
    overlay.addEventListener('click', function(e) {
      // Only allow clicks inside the modal box; outside does nothing
      const box = overlay.querySelector('.restrict-modal-box');
      if (!box.contains(e.target)) {
        e.stopPropagation();
        e.preventDefault();
      }
    }, true);
  })();
</script>

<script>
        $(document).ready(function() {
            $('#review').on('click', function() {
                $('#case_review').css('display','none');
            });
        });
</script>

<script>
    // highlights cancelled tests
    document.addEventListener("DOMContentLoaded", function() {
        const table = document.getElementById("test_table")
        if (!table) return

        const rows = table.querySelectorAll("tbody tr.main")
        rows.forEach(row => {
            const cells = row.querySelectorAll("td")
            const statusCell = cells[6]
            
            if (statusCell && statusCell.textContent.trim() === 'Cancelled') {
                row.style.backgroundColor = "#D9DADD"
            }

        })
    })
</script>

<script>
        $('.expand').on('click', function(){
            var isExpanded = $(this).parents().next('.hidden_row').hasClass('show');
            var row = $(this).parents().next('.hidden_row')
            console.log(isExpanded);
            if (isExpanded) {
                console.log('expanded')
                $(this).removeClass('fa-square-minus');
                $(this).addClass('fa-square-plus');
                $(this).parents().next('.hidden_row').removeClass('show');
            } else {
                console.log('collapsed')
                $(this).removeClass('fa-square-plus');
                $(this).addClass('fa-square-minus');
                $(this).parents().next('.hidden_row').addClass('show');
            }
        });
</script>

<script>
    $('#containers-show-all').on('click', function() {
        $.each($('.expand-containers'), function () {
            var isExpanded = $(this).parents().next('.hidden_row').hasClass('show');
            if (isExpanded == false) {
                $(this).removeClass('fa-square-plus');
                $(this).addClass('fa-square-minus');
                $(this).parents().next('.hidden_row').addClass('show');
            }
        });
    });
</script>

<script>
    $('#containers-collapse-all').on('click', function() {
        $.each($('.expand-containers'), function () {
            var isExpanded = $(this).parents().next('.hidden_row').hasClass('show');
            if (isExpanded) {
                $(this).removeClass('fa-square-minus');
                $(this).addClass('fa-square-plus');
                $(this).parents().next('.hidden_row').removeClass('show');
            }
        });
    });
</script>

<script>
    $('#tests-show-all').on('click', function() {
        $.each($('.expand'), function () {
            var isExpanded = $(this).parents().next('.hidden_row').hasClass('show');
            if (isExpanded == false) {
                $(this).removeClass('fa-square-plus');
                $(this).addClass('fa-square-minus');
                $(this).parents().next('.hidden_row').addClass('show');
            }
        });
    });
</script>

<script>
    $('#tests-collapse-all').on('click', function() {
        $.each($('.expand'), function () {
            var isExpanded = $(this).parents().next('.hidden_row').hasClass('show');
            if (isExpanded) {
                $(this).removeClass('fa-square-minus');
                $(this).addClass('fa-square-plus');
                $(this).parents().next('.hidden_row').removeClass('show');
            }
        });
    });
</script>

<script>
    $("#case_accordion").on("hide.bs.collapse show.bs.collapse", e => {
  $(e.target)
    .prev()
    .find("i:last-child");
});
</script>

<script>
    $('.collapse').on('shown.bs.collapse', function () {
       $($.fn.dataTable.tables(true)).DataTable()
          .columns.adjust();
    });
</script>

<script>

$(document).ready(function () {

    //initDataTable($('#container_table'), 100)
    //var results_table = $('#results_table').DataTable()
    //var results_table = initDataTable($('#results_table'), 100)
    //initDataTable($('#report_table'), 100)
    //var record_table = initDataTable($('#record_table'), 100)
    //var bookings_table = initDataTable($('#bookings_table'), 100)
    //initDataTable($('#audit_table'), 100)
});
</script>

<script>
    $(document).ready(function () {
        $('#narratives_table').DataTable({
            pageLength: 100,
            scrollX: true,
            scrollY: '50vh',
            scrollCollapse: true,
            lengthMenu: [[10, 50, 100, -1], [10, 50, 100, 'All']],
            order: [],
        });
    });
</script>
<script>
   $(document).ready( function () {
        $('#container_table').DataTable({
            pageLength: -1,
            scrollX: true,
            scrollY: '50vh',
            scrollCollapse: true,
            lengthMenu: [[10, 50, 100, -1], [10, 50, 100, 'All']],
            order: [],
        });
    });
</script>
<script>
   $(document).ready( function () {
        $('.specimen-table').DataTable({
            dom: 'tr',
            scrollX: true,
            scrollY: '50vh',
            scrollCollapse: true,
            lengthMenu: [[10, 50, 100, -1], [10, 50, 100, 'All']],
            order: [],
        });
    });
</script>

<script>
   $(document).ready( function () {
        $('#components-table').DataTable({
            pageLength: -1,
            scrollX: true,
            scrollY: '50vh',
            scrollCollapse: true,
            lengthMenu: [[10, 50, 100, -1], [10, 50, 100, 'All']],
            order: [],
        });
    });
</script>
<script>
   $(document).ready( function () {
        $('#results_table').DataTable({
            pageLength: -1,
            scrollX: true,
            scrollY: '50vh',
            scrollCollapse: true,
            lengthMenu: [[10, 50, 100, -1], [10, 50, 100, 'All']],
            order: [],
        });
    });
</script>
<script>
    $('#clear-filter').on('click', function() {
         var table = $('#results_table').DataTable()
         table.columns().search("").draw()
         $('#confirmed-only-alert').attr('hidden', true)
    })
</script>
<script>

    function ShowConfirmed() {
        var table = $('#results_table').DataTable()
        var colIdx = table.column($('#result-status')).index()
        table.column(colIdx).search('^Confirmed$', true, false).draw()
        $('#confirmed-only-alert').attr('hidden', false)
    }

    //$(document).ready(ShowConfirmed)
    $('#filter-confirmed').on('click', ShowConfirmed)

</script>
<script>

    $('#filter-confirmed-saturated').on('click', function () {
        var table = $('#results_table').DataTable()
        var colIdx = table.column($('#result-status')).index()
        table.column(colIdx).search('^Confirmed|Saturated|Not Tested$', true, false).draw()
        $('#confirmed-only-alert').attr('hidden', false)

    })

</script>
<script>
        $('#filter-unconfirmed-trace').on('click', function () {
        var table = $('#results_table').DataTable()
        var colIdx = table.column($('#result-status')).index()
        table.column(colIdx).search('^Unconfirmed|Trace|DNR$', true, false).draw()
        $('#unconfirmed-trace-alert').attr('hidden', false)

    })
</script>
<script>
    $('#filter-withdrawn').on('click', function () {
        var table = $('#results_table').DataTable()
        var colIdx = table.column($('#result-status')).index()
        table.column(colIdx).search('Withdrawn|Omit|DNR', true, false).draw()
        $('#withdrawn-alert').attr('hidden', false)

    })
</script>
<script>
   $(document).ready( function () {
        $('#record_table').DataTable({
            pageLength: -1,
            scrollX: true,
            scrollY: '50vh',
            scrollCollapse: true,
            lengthMenu: [[10, 50, 100, -1], [10, 50, 100, 'All']],
            order: [],
        });
    });
</script>
<script>
   $(document).ready( function () {
        $('#audit_table').DataTable({
            pageLength: -1,
            scrollX: true,
            scrollY: '50vh',
            scrollCollapse: true,
            lengthMenu: [[10, 50, 100, -1], [10, 50, 100, 'All']],
            order: [],
        });
    });
</script>
<script>
   $(document).ready( function () {
        $('#bookings_table').DataTable({
            pageLength: -1,
            scrollX: true,
            scrollY: '50vh',
            scrollCollapse: true,
            lengthMenu: [[10, 50, 100, -1], [10, 50, 100, 'All']],
            order: [],
        });
    });
</script>


<script>
    $(document).ready(function () {
  $('#tests_table').DataTable();
});
</script>

<script>
    $(document).ready(function () {
        array = {{kwargs['pending_fields'] | safe}}
        $('.form-item').each(function () {
           name = $(this).attr('name')
           if (array.includes(name)) {
            $(this).addClass('table-warning');
           }
        });
    });
</script>

<script>
    $(function(){
  	$('#review').click(function() {
  	    $(this).data('clicked', true);
        let view = 'review';
      	alert(view);
      });
});
</script>

<script>
$('.accession-number').on('click', function (){
    var accession_number = $(this).attr('name')
    var specimen_id = $(this).attr('value')
    $('#accession-number').html(accession_number);
    $('#edit').attr('href', "../specimens/"+specimen_id+"?view_only=False")
    $('#review').attr('href', "../specimens/"+specimen_id+"?view_only=False")
    $('#view-only').attr('href', "../specimens/"+specimen_id+"?view_only=True")
});
</script>


<script type="text/javascript">

$('.custody-type').on('change', function() {
   let custody_type = $(this).val();
   //let custody = $(this).parent().siblings('.custody').children('.custody');
   // let custody = $(this).parents('.col-md-2').siblings('.col-md-2').children('.custody').children('.custody');
   let custody = $(this).parents('.col-md-5').siblings('.col-md-5').children('.custody').children('.custody');

   console.log(custody);
   $.getJSON('/specimens/get_custody_locations/', {
        custody_type: custody_type,
        }, function(data) {
            var HTML = '';
            for (var choice of data.choices) {
                HTML += '<option value="' + choice.id + '">' + choice.name + '</option>';
            }
            console.log(HTML);
            custody.prop('innerHTML', HTML);
            custody.selectpicker('val', '');
            custody.selectpicker('refresh');
            custody.selectpicker('render');
     });
     return false;
});

</script>
<script>
  $('.form').on('submit', function(event) {
    let errors = 0;
    $(this).find('select.custody').each(function () {
        let custody = $(this).val()
        if (!$(this).siblings('button').hasClass('disabled')) {
            if (!custody || custody == "0") {
                errors += 1
                $(this).parent().addClass("is-invalid");
                $(this).parent().siblings('.invalid-feedback').html('No location selected');
            } else {
              $(this).parent().removeClass("is-invalid");

            }
        }
    });

    if (errors != 0) {
      event.preventDefault();
    }
  });
</script>

<script>
    $('#specimen-select').on('change', function () {
        specimen_ids = $(this).val();
        $('.specimen-row').each( function () {
            specimen_id = $(this).attr('id');
            if (specimen_ids.includes(specimen_id)) {
                $(this).find('div.form-control').each( function () {
                    $(this).children('select').attr('disabled', false);
                    $(this).children('button').removeClass('disabled');
                });
            } else {
                $(this).find('div.form-control').each( function () {
                    $(this).children('button').addClass('disabled');
                });
            }
        });
    });
</script>

<script>
    $('#approve-select-form').on('submit', function () {
        let approve_case = $('#approve-case').val()
        if (approve_case == 0) {
          $('#approve-case').parent().addClass('is-invalid');
          $('#approve-case-invalid').html("Please select an answer.")
          event.preventDefault();
        }
    });

</script>

<script>
    function clearModal() {
        $('#approve-select').modal('hide');
    }
</script>

<script>
    $('.edit-specimen').on('click', function (){
        var accession_number = $(this).attr('name')
        var id = $(this).attr('value')
        $('.accession_number').html(accession_number);
        $('#proceed').attr('href', "/specimens/"+id+"/edit")
        $('#view-only').attr('href', "/specimens/"+id+"?view_only=True")
    });
</script>

<script>
    $('#container-select, #specimen-select').selectpicker({
                    "liveSearch": true,
                    "selectedTextFormat": "count > 10",
                    "actionsBox": true,
                    })

</script>

<script>
    $('#custody-type-all').on('change', function () {
        let custody_type = $(this).val();
        //let custody = $(this).parents('.col-md-5').siblings('.col-md-5').children('.custody').children('.custody');
        let custody = $('#custody-all');
        $('#specimen_audit .specimen-row').each( function () {
            console.log($(this).children('.col-md-5').children('.custody-type').children('.custody-type').attr('class'))
        });
         $.getJSON('/specimens/get_custody_locations/', {
            custody_type: custody_type,
            }, function(data) {
                var HTML = '';
                for (var choice of data.choices) {
                    HTML += '<option value="' + choice.id + '">' + choice.name + '</option>';
                }
                custody.prop('innerHTML', HTML);
                custody.selectpicker('val', " ");
                custody.selectpicker('refresh');
                custody.selectpicker('render');
         });
         return false;
     });
</script>
<!--<script>-->
<!-- document.getElementById('print-all-content').addEventListener('click', function() {-->
<!--        console.log("Button clicked");-->

<!--        // Get the content to print-->
<!--        var content = document.getElementById('pdf-test');-->

<!--        // Check if the element is found-->
<!--        if (!content) {-->
<!--            console.error("Element with id 'pdf-test' not found");-->
<!--            return;-->
<!--        }-->

<!--        // Temporarily show the hidden element-->
<!--        content.style.display = "block";-->
<!--        content.style.padding-->
<!--        console.log("Content made visible");-->

<!--        // Use html2pdf to generate the PDF-->
<!--        var opt = {-->
<!--            margin:       0.5,-->
<!--            filename:     'myfile.pdf',-->
<!--            image:        { type: 'jpeg', quality: 0.98 },-->
<!--            html2canvas:  { scale: 2, useCORS: true },-->
<!--            jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }-->
<!--        };-->

<!--        html2pdf().from(content).set(opt).toPdf().get('pdf').then(function (pdf) {-->
<!--            console.log("PDF generated");-->
<!--            var pdfBlob = pdf.output('blob');-->
<!--            var blobUrl = URL.createObjectURL(pdfBlob);-->
<!--            window.open(blobUrl);-->

<!--            // Revert the display property-->
<!--            content.style.display = "none";-->
<!--            console.log("Content hidden again");-->
<!--        }).catch(function(error) {-->
<!--            console.error('Error generating PDF:', error);-->

<!--            // Ensure the display property is reverted in case of error-->
<!--            content.style.display = "none";-->
<!--        });-->
<!--    });-->
<!--    </script>-->

<script>
        $(document).ready(function() {
        const itemId = "{{ item.id }}"
            $('#lit-packet-generation').click(function() {
                $.ajax({
                    url: `/cases/${itemId}/litigation_packet_print`,
                    method: 'GET',
                    success: function(response) {
                        alert('Litigation Packet Generated')
                        // Show a message when PDF is generated
                    },
                    error: function(xhr, status, error) {
                        console.error("An error occurred:", error);
                    }
                });
                alert('Litigation Packet Generated')
            });
        });
</script>
<!--batches-pdf-generation-->
<script>
        $(document).ready(function() {
        const itemId = "{{ item.id }}"
            $('#batches-pdf-generation').click(function() {
                $.ajax({
                    url: `/cases/${itemId}/batches_pdf_print`,
                    method: 'GET',
                    success: function(response) {
                        alert('Batches PDF Generated')
                        // Show a message when PDF is generated
                    },
                    error: function(xhr, status, error) {
                        console.error("An error occurred:", error);
                    }
                });
                alert('Batches PDF Generated')
            });
        });
</script>
<script type="text/javascript">
    function submitForm(discipline) {
        document.getElementById('selectedDiscipline').value = discipline;
        document.getElementById('filterForm').submit();
    }
</script>

<script>
    $('.show-more').on('click', function() {
        var $wrapper = $(this).closest('div')
        $wrapper.siblings('div').removeAttr('hidden')
        $wrapper.attr('hidden', true)
    });
</script>
<script>
    $('.show-less').on('click', function() {
        $(this).parent().attr('hidden', true);
        $(this).parent().siblings('div').attr('hidden', false);
    });
</script>

<script>
    $('.specimen-btn').on('click', function () {
        var accession_number = $(this).html().split(" | ")[0]
        var table = $('#components-table').DataTable()
        table.columns().search("").draw()
        var colIdx = table.column($('.accession-number')).index()
        table.column(colIdx).search(accession_number, true, false).draw()
    });
</script>

<script>
    $('#specimen-btn-clear').on('click', function() {
         var table = $('#components-table').DataTable()
         table.columns().search("").draw()
    })
</script>

<script>
$(document).ready(function () {
    $("#resultsView").click(function () {
        // Simulate clicking headers in order
        $("th[data-column='batch_date']").click();
        setTimeout(function () { $("th[data-column='component_name']").click(); }, 100);
        setTimeout(function () { $("th[data-column='drug_class']").click(); }, 200);
        setTimeout(function () { $("th[data-column='type']").click(); }, 300);
    });

$('#b1-view').on('click', function () {
  var table = $('#results_table').DataTable();

  // Find the index of the Batch column by header text
  var batchIdx = $('#results_table thead th').filter(function () {
    return $(this).text().trim() === 'Discipline';
  }).index();

  // Apply regex: only include rows where Batch starts with PRIM
  if (batchIdx !== -1) {
    table.column(batchIdx).search('^\\s*Biochemistry.*', true, false, true);
  }

  table.draw();
});

$('#t1-view').on('click', function () {
  var table = $('#results_table').DataTable();

  // Find the index of the Batch column by header text
  var batchIdx = $('#results_table thead th').filter(function () {
    return $(this).text().trim() === 'Discipline';
  }).index();

  // Apply regex: only include rows where Batch starts with PRIM
  if (batchIdx !== -1) {
    table.column(batchIdx).search('^\\s*Toxicology.*', true, false, true);
  }

  table.draw();
});

$('#x1-view').on('click', function () {
  var table = $('#results_table').DataTable();

  // Find the index of the Batch column by header text
  var batchIdx = $('#results_table thead th').filter(function () {
    return $(this).text().trim() === 'Discipline';
  }).index();

  // Apply regex: only include rows where Batch starts with PRIM
  if (batchIdx !== -1) {
    table.column(batchIdx).search('^\\s*External.*', true, false, true);
  }

  table.draw();
});

$('#d1-view').on('click', function () {
  var table = $('#results_table').DataTable();

  // Find the index of the Batch column by header text
  var batchIdx = $('#results_table thead th').filter(function () {
    return $(this).text().trim() === 'Discipline';
  }).index();

  // Apply regex: only include rows where Batch starts with PRIM
  if (batchIdx !== -1) {
    table.column(batchIdx).search('^\\s*Drug.*', true, false, true);
  }

  table.draw();
});



});

</script>
<script>
$(document).ready(function () {
    $("#testAddView").click(function () {
        // Simulate clicking headers in order
        $("th[data-column='batch_date']").click();
        setTimeout(function () { $("th[data-column='component_name']").click(); }, 100);
        setTimeout(function () { $("th[data-column='drug_class']").click(); }, 200);
    });
});

</script>


<!-- AI overview code -->

<script>
    const pathParts = window.location.pathname.split("/");
    window.caseNumber = pathParts[pathParts.length - 1];  // e.g., "2025-0689"
    console.log("Case number:", window.caseNumber);
</script>
<!-- 
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const output = document.getElementById('output');



    const rows = document.querySelectorAll('#narratives_table tbody tr');
    let initialNarrativeCell = null;

    for (const row of rows) {
      const typeCell = row.querySelector('td'); // assuming the first <td> is narrative type
      const narrativeCell = row.querySelector('td[data-narrative]');

      if (typeCell && narrativeCell && typeCell.textContent.trim().toLowerCase() === 'initial') {
        initialNarrativeCell = narrativeCell;
        break; // stop at first match
      }
    }

    if (!initialNarrativeCell) {
      output.textContent = 'No Initial narrative found.';
      output.className = 'bg-warning text-dark rounded p-2 mt-2';
      return;
    }



    const narrative = initialNarrativeCell.getAttribute('data-narrative');

    const postOptions = {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ narrative, caseNumber:window.caseNumber })
    };

    const summaryFetch = fetch(`/get_ai_summary`, postOptions).then(res => res.json());
    const commentsFetch = fetch(`/get_ai_comments`, postOptions).then(res => res.json());

    Promise.all([summaryFetch, commentsFetch])
      .then(([summaryData, commentsData]) => {
        if (summaryData.success && commentsData.success) {
          output.innerHTML = `<strong>AI Overview:</strong><br>${summaryData.summary}<br><br><strong>Comments:</strong> ${commentsData.summary}`;
          output.className = 'bg-info text-white rounded p-2 mt-2';
        } else {
          output.textContent = 'Error fetching summary or comments. Return code 400.';
          output.className = 'bg-danger text-white rounded p-2 mt-2';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        output.textContent = 'Error fetching summary or comments. Something went wrong.';
        output.className = 'bg-danger text-white rounded p-2 mt-2';
      });

  });
</script> -->


<script>
    window.addEventListener('DOMContentLoaded', () => {

    
    // const output = document.getElementById('output-text');
    // const outputText = document.getElementById('output-text');
    const commentsContainer = document.getElementById('ai-comments-container');
    const commentsText = document.getElementById('ai-comments-text');
    const summaryContainer = document.getElementById('summary-narratives');
    const summaryCell = document.getElementById('ai-summary-cell');
    const rows = document.querySelectorAll('#narratives_table tbody tr');
    // let initialNarrativeCell = null;

    // for (const row of rows) {
    //     // const typeCell = row.querySelector('td');
    //     const tds = row.querySelectorAll('td');
    //     const typeCell = tds[0];  // Index 1 = second element (0-based)
    //     const narrativeCell = row.querySelector('td[data-narrative]');
    //     if (typeCell && narrativeCell && typeCell.textContent.trim().toLowerCase() === 'initial') {
    //     initialNarrativeCell = narrativeCell;
    //     break;
    //     }
    // }
    let initialNarrativeCell = null;

    for (const row of rows) {
        const typeCell = row.querySelector('td:nth-child(2)'); // 2nd column is narrative type
        const narrativeCell = row.querySelector('td:nth-child(3)'); // 3rd column is the narrative itself

        if (typeCell && typeCell.textContent.trim().toLowerCase() === 'initial') {
            initialNarrativeCell = narrativeCell;
            break;
        }
    }

    console.log("Initial narrative cell:", initialNarrativeCell);
    if (!initialNarrativeCell) {
        // No narrative  update both UI blocks
        summaryCell.className = '';
        summaryCell.innerHTML = '<em>No Initial Narrative found. </em>';
        commentsContainer.className = '';
        commentsContainer.innerHTML = ' <em> No Initial narrative found. </em>';
        return;
    }

    const narrative = initialNarrativeCell.getAttribute('data-narrative');
    console.log("Initial narrative:", narrative);
    const postOptions = {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ narrative, caseNumber: window.caseNumber })
    };

    console.log("AI overview script loaded, going to fetch AI data...");
    fetch('/get_ai_combined', postOptions)
        .then(res => res.json())
        .then(data =>{

            if(data.success){
                commentsContainer.className = '';
                commentsContainer.innerHTML = `${data.comment}`;

                return fetch('/summary_html/placeholder/placeholder', postOptions)
                    .then(res => res.text())
                    .then(html => {
                        summaryContainer.innerHTML = html;

                        $('.show-more').off('click').on('click', function () {
                            $(this).parent().siblings('div').attr('hidden', false);
                            $(this).parent().attr('hidden', true);
                        });

                        $('.show-less').off('click').on('click', function () {
                            $(this).parent().attr('hidden', true);
                            $(this).parent().siblings('div').attr('hidden', false);
                        });
                    });
            }
            else{
                commentsContainer.className = '';
                // commentsContainer.className = 'bg-danger text-white rounded p-2 mt-2';
                commentsContainer.innerHTML = '<em>NOT PRODUCED</em>';
                // summaryContainer.className = 'bg-danger text-white rounded p-2 mt-2';
                summaryCell.className = '';  // Optional
                summaryCell.innerHTML = '<em>NOT PRODUCED</em>';

            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            commentsContainer.className = '';
            // commentsContainer.className = 'bg-danger text-white rounded p-2 mt-2';
            commentsContainer.innerHTML = '<em>NOT PRODUCED</em>';
            // summaryContainer.className = 'bg-danger text-white rounded p-2 mt-2';
            summaryCell.className = '';  // Optional
            summaryCell.innerHTML = '<em>NOT PRODUCED</em>';
        });
});




//     // FIRST: Fetch comments
//     fetch('/get_ai_comments', postOptions)
//         .then(res => res.json())
//         .then(data => {
//             if (data.success) {
//                 commentsContainer.className = '';
//                 commentsContainer.innerHTML = `${data.summary}`;
//             } else {
//                 commentsContainer.className = 'bg-danger text-white rounded p-2 mt-2';
//                 commentsContainer.textContent = 'Failed to load AI case comments.';
//             }

//             // THEN: Fetch summary
//             return fetch('/get_ai_summary', postOptions);
//         })
//         .then(res => res.json())
//         .then(data => {
//             if (data.success) {
//                 return fetch('/summary_html', postOptions)
//                     .then(res => res.text())
//                     .then(html => {
//                         const summaryContainer = document.getElementById('summary-narratives');
//                         summaryContainer.innerHTML = html;

//                         $('.show-more').off('click').on('click', function () {
//                             $(this).parent().siblings('div').attr('hidden', false);
//                             $(this).parent().attr('hidden', true);
//                         });

//                         $('.show-less').off('click').on('click', function () {
//                             $(this).parent().attr('hidden', true);
//                             $(this).parent().siblings('div').attr('hidden', false);
//                         });
//                     });
//             } else {
//                 output.className = 'bg-danger text-white rounded p-2 mt-2';
//                 output.textContent = 'Failed to load AI case summary.';
//             }
//         })
//         .catch(error => {
//             console.error('Fetch error:', error);
//             output.className = 'bg-danger text-white rounded p-2 mt-2';
//             output.textContent = 'Error fetching AI case summary.';
//             commentsContainer.className = 'bg-danger text-white rounded p-2 mt-2';
//             commentsContainer.textContent = 'Error fetching AI case comments.';
//         });
// });












    // //old code
    // fetch('/get_ai_summary', postOptions)
    //     .then(res => res.json())
    //     .then(data => {
    //         if (data.success) {
    //         // Show summary with a span for copy text
    //         // output.className = 'bg-info text-white rounded p-2 mt-2';
    //         // output.innerHTML = `<strong>AI Overview : </strong> <br><span id="ai-summary-text">${data.summary}</span>`;
            
    //         fetch('/summary_html', postOptions)
    //             .then(res => res.text())
    //             .then(html => {
    //                 const summaryContainer = document.getElementById('summary-narratives');
    //                 summaryContainer.innerHTML = html;

    //                 $('.show-more').off('click').on('click', function () {
    //                     $(this).parent().siblings('div').attr('hidden', false);
    //                     $(this).parent().attr('hidden', true);
    //                 });

    //                 $('.show-less').off('click').on('click', function () {
    //                     $(this).parent().attr('hidden', true);
    //                     $(this).parent().siblings('div').attr('hidden', false);
    //                 });

    //                 // const buttonContainer = document.getElementById('copy-summary-button-container');
    //                 // const copyButton = document.createElement('button');

    //                 // copyButton.className = 'btn btn-sm rounded bg-info text-white mt-1';
    //                 // copyButton.style.width = '36px';
    //                 // copyButton.style.height = '36px';
    //                 // copyButton.style.display = 'flex';
    //                 // copyButton.style.alignItems = 'center';
    //                 // copyButton.style.justifyContent = 'center';
    //                 // copyButton.style.fontSize = '18px';
    //                 // copyButton.innerHTML = '';

    //                 // document.querySelectorAll('[id^="copy-btn-"]').forEach(button => {
    //                 //     button.addEventListener('click', () => {
    //                 //         const id = button.id.replace('copy-btn-', '');
    //                 //         const textElem = document.getElementById(`summary-text-${id}`);
    //                 //         if (!textElem) return;
    //                 //         navigator.clipboard.writeText(textElem.innerText)
    //                 //             .then(() => {
    //                 //                 const container = document.getElementById(`copy-summary-button-container-${id}`);
    //                 //                 const popup = document.createElement('div');
    //                 //                 popup.textContent = 'Copied!';
    //                 //                 popup.className = 'alert alert-success mt-2 p-1 text-center';
    //                 //                 popup.style.fontSize = '0.9rem';
    //                 //                 container.appendChild(popup);
    //                 //                 setTimeout(() => popup.remove(), 1000);
    //                 //             });
    //                 //     });
    //                 // });

    //                 // buttonContainer.innerHTML = ''; // Remove any existing button
    //                 // buttonContainer.appendChild(copyButton);
    //             });



    //         // // Add copy button
    //         // const buttonContainer = document.getElementById('copy-summary-button-container');
    //         // const copyButton = document.createElement('button');

    //         // copyButton.className = 'btn btn-sm rounded bg-info text-white mt-1';
    //         // copyButton.style.width = '36px';
    //         // copyButton.style.height = '36px';
    //         // copyButton.style.display = 'flex';
    //         // copyButton.style.alignItems = 'center';
    //         // copyButton.style.justifyContent = 'center';
    //         // copyButton.style.fontSize = '18px';
    //         // copyButton.innerHTML = '';

    //         // copyButton.addEventListener('click', () => {
    //         //     const summaryText = document.getElementById('ai-summary-text').innerText;
    //         //     navigator.clipboard.writeText(summaryText)
    //         //     .then(() => {
    //         //         // Create a simple popup message
    //         //         const popup = document.createElement('div');
    //         //         popup.textContent = 'Copied successfully!';
    //         //         popup.className = 'alert alert-success mt-2 p-1 text-center';
    //         //         popup.style.fontSize = '0.9rem';

    //         //         buttonContainer.appendChild(popup);

    //         //         setTimeout(() => popup.remove(), 1000);
    //         //     })
    //         //     .catch(err => {
    //         //         console.error('Clipboard error:', err);
    //         //         const popup = document.createElement('div');
    //         //         popup.textContent = 'Failed to copy.';
    //         //         popup.className = 'alert alert-danger mt-2 p-1 text-center';
    //         //         popup.style.fontSize = '0.9rem';

    //         //         buttonContainer.appendChild(popup);

    //         //         setTimeout(() => popup.remove(), 2000);
    //         //     });
    //         // });


    //         // buttonContainer.innerHTML = ''; // clear previous button if any
    //         // buttonContainer.appendChild(copyButton);
    //         } 
    //         else {
    //         output.className = 'bg-danger text-white rounded p-2 mt-2';
    //         output.textContent = 'Failed to load AI case summary.';
    //         }
    //     })
    //     .catch(error => {
    //         console.error('Summary fetch error:', error);
    //         output.className = 'bg-danger text-white rounded p-2 mt-2';
    //         output.textContent = 'Error fetching AI case summary.';
    //     });



    // fetch('/get_ai_comments', postOptions)
    //     .then(res => res.json())
    //     .then(data => {
    //     if (data.success) {
    //         commentsContainer.className = '';
    //         commentsContainer.innerHTML = `${data.summary}`;
    //     } else {
    //         commentsContainer.className = 'bg-danger text-white rounded p-2 mt-2';
    //         commentsContainer.textContent = 'Failed to load AI case comments.';
    //     }
    //     })
    //     .catch(error => {
    //     console.error('Comments fetch error:', error);
    //     commentsContainer.className = 'bg-danger text-white rounded p-2 mt-2';
    //     commentsContainer.textContent = 'Error fetching AI case comments.';
    //     });
    // });
</script>

<script>
(function () {
  // strip a leading "Presumptive" (case-insensitive, optional ':' or '-')
  function stripPresumptivePrefix(text) {
    if (!text) return '';
    return String(text).replace(/^\s*presumptive\s*[:\-]?\s*/i, '');
  }

  function parseThreshold(text) {
    if (!text) return null;
    const t = stripPresumptivePrefix(text).trim();
    const m = t.match(/^((?:>=|<=|>|<||))\s*([+-]?\d{1,3}(?:[,\u00A0\u2007\u202F]\d{3})*(?:\.\d+)?|[+-]?\d+(?:\.\d+)?)/);
    if (!m) return null;

    const rawOp = m[1];
    const op = rawOp === '' ? '>=' : rawOp === '' ? '<=' : rawOp;
    const cleaned = m[2].replace(/[,\u00A0\u2007\u202F]/g, '');
    const val = parseFloat(cleaned);
    return Number.isFinite(val) ? { op, val, displayOp: rawOp } : null;
  }

  function parsePlainNumber(text) {
    if (!text) return null;
    const t = (text + '').trim();
    if (/[<>]/.test(t)) return null; // ignore if looks like a threshold
    const m = t.match(/([+-]?\d{1,3}(?:[,\u00A0\u2007\u202F]\d{3})*(?:\.\d+)?|[+-]?\d+(?:\.\d+)?)/);
    if (!m) return null;
    const cleaned = m[1].replace(/[,\u00A0\u2007\u202F]/g, '');
    const num = parseFloat(cleaned);
    return Number.isFinite(num) ? num : null;
  }

  function flag(cellA, cellB, reason) {
    [cellA, cellB].forEach((td) => {
      td.classList.add('flag-mismatch');
      const prev = td.getAttribute('title');
      td.setAttribute('title', prev ? `${prev} | ${reason}` : reason);
    });
  }

  function runCheck(scope) {
    const table = scope.querySelector('#results_table');
    if (!table) return;

    table.querySelectorAll('tbody tr').forEach((tr) => {
      const tds = tr.querySelectorAll('td');
      if (tds.length < 11) return;

      const resultCell = tds[9];   // "Result"
      const suppCell   = tds[10];  // "Supplementary Result"

      // clear previous flags (in case of redraws)
      [resultCell, suppCell].forEach(td => td && td.classList.remove('flag-mismatch'));

      const primary = parseThreshold(resultCell ? resultCell.textContent : '');
      const suppNum = parsePlainNumber(suppCell ? suppCell.textContent : '');

      if (!primary || suppNum === null) return;

      const { op, val, displayOp } = primary;
      let mismatch = false;
      switch (op) {
        case '>':  mismatch = !(suppNum >  val); break;
        case '<':  mismatch = !(suppNum <  val); break;
        case '>=': mismatch = !(suppNum >= val); break;
        case '<=': mismatch = !(suppNum <= val); break;
      }
      if (mismatch) {
        flag(resultCell, suppCell, `Mismatch: expected supplementary ${displayOp} ${val}, got ${suppNum}`);
      }
    });
  }

  function boot() {
    runCheck(document);
    // Re-run on DataTables redraws (if DataTables is used)
    if (window.jQuery && jQuery.fn && jQuery.fn.dataTable) {
      jQuery(document).on('draw.dt', function (e, settings) {
        if (settings && settings.nTable && settings.nTable.id === 'results_table') {
          runCheck(document);
        }
      });
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', boot);
  } else {
    boot();
  }

  // optional manual hook
  window.recheckResultsFlags = function () { runCheck(document); };
})();
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var communicationsBox = document.getElementById('communications-box');
    if (communicationsBox) {
      communicationsBox.style.display = 'none';
    }
  });
</script>

{% endblock %}
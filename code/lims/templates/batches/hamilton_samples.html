{% extends "base.html" %}
{% block content %}

<style>
    .correct {
        background-color: green
    }

    .incorrect{
        background-color: yellow
    }
</style>


{% set x = [1, 2, 3, 4] %}
{% set y = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24] %}

<div class="container-fluid">
    <hr style="border-width:5px">
    <h1 align="center">
        Transfer Check
    </h1>
    <h3 align="center">
        Do not refresh this page!
    </h3>
    <hr style="border-width:5px">
</div>


<div>
    <form method="POST" id="form" novalidate="novalidate">
        {{form.hidden_tag()}}
        <table>
            <tbody>
                <tr>
                    {% for num1 in x %}
                        <th>
                            <div class="col">
                                {% if num1 == 1 %}
                                    <table class="table-hover table-striped table-bordered nowrap" style="background-color: rgba(71, 92, 108, 0.33)">
                                {% elif num1 == 2 %}
                                    <table class="table-hover table-striped table-bordered nowrap" style="background-color: rgba(247, 239, 210, 0.40)">
                                {% elif num1 == 3 %}
                                    <table class="table-hover table-striped table-bordered nowrap" style="background-color: rgba(138, 133, 131, 0.33)">
                                {% elif num1 == 4 %}
                                    <table class="table-hover table-striped table-bordered nowrap" style="background-color: rgba(238, 215, 161, 0.33)">
                                {% endif %}
                                    <tbody>
                                        <tr>
                                            <th colspan="2">
                                                <h1 style="text-align: center">Rack <br> {{num1}}</h1>
                                            </th>
                                        </tr>
                                        {% for num2 in y %}
                                            <tr height="50px">
                                                <td style="text-align: center">{{num2}}</td>
                                                <td style="text-align: center" id="source{{num1}}-{{num2}}"
                                                {% if num1 == 1 %}
                                                    {% for test in rack_1 %}
                                                        {% if test[0] == num1 ~ '-' ~ num2 %}
                                                            data-value="{{ test[2] }}"
                                                        {% endif %}
                                                    {% endfor %}
                                                {% elif num1 == 2 %}
                                                    {% for test in rack_2 %}
                                                        {% if test[0] == num1 ~ '-' ~ num2 %}
                                                            data-value="{{ test[2] }}"
                                                        {% endif %}
                                                    {% endfor %}
                                                {% elif num1 == 3 %}
                                                    {% for test in rack_3 %}
                                                        {% if test[0] == num1 ~ '-' ~ num2 %}
                                                            data-value="{{ test[2] }}"
                                                        {% endif %}
                                                    {% endfor %}
                                                {% elif num1 == 4 %}
                                                    {% for test in rack_4 %}
                                                        {% if test[0] == num1 ~ '-' ~ num2 %}
                                                            data-value="{{ test[2] }}"
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                            >
                                                {% if num1 == 1 %}
                                                    {% if 'UR' in item.assay.assay_name %}
                                                        {% if num2 not in non_blank_pos and num2 in [1, 2, 3, 4, 5, 6] %}
                                                            <p1>Blank (Matrix)</p1>
                                                        {% endif %}
                                                    {% else %}
                                                        {% if num2 not in non_blank_pos and num2 in [1, 2, 3, 4, 5, 6, 7, 8] %}
                                                            <p1>Blank (Matrix)</p1>
                                                        {% endif%}
                                                    {% endif %}
                                                    {% for test in rack_1 %}
                                                        {% if test[0] == num1 ~ '-' ~ num2 %}
                                                            {{ test[1] }}
                                                        {% endif %}
                                                    {% endfor %}
                                                {% elif num1 == 2 %}
                                                    {% for test in rack_2 %}
                                                        {% if test[0] == num1 ~ '-' ~ num2 %}
                                                            {{ test[1] }}
                                                        {% endif %}
                                                    {% endfor %}
                                                {% elif num1 == 3 %}
                                                    {% for test in rack_3 %}
                                                        {% if test[0] == num1 ~ '-' ~ num2 %}
                                                            {{ test[1] }}
                                                        {% endif %}
                                                    {% endfor %}
                                                {% elif num1 == 4 %}
                                                    {% for test in rack_4 %}
                                                        {% if test[0] == num1 ~ '-' ~ num2 %}
                                                            {{ test[1] }}
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                            </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </th>
                        <th>
                            <div class="col">
                                {% if num1 == 1 %}
                                    <table class="table-hover table-striped table-bordered nowrap" style="background-color: rgba(71, 92, 108, 0.33)">
                                {% elif num1 == 2 %}
                                    <table class="table-hover table-striped table-bordered nowrap" style="background-color: rgba(247, 239, 210, 0.40)">
                                {% elif num1 == 3 %}
                                    <table class="table-hover table-striped table-bordered nowrap" style="background-color: rgba(138, 133, 131, 0.33)">
                                {% elif num1 == 4 %}
                                    <table class="table-hover table-striped table-bordered nowrap" style="background-color: rgba(238, 215, 161, 0.33)">
                                {% endif %}
                                    <tbody>
                                        <tr>
                                            <th colspan="2">
                                                <h1 style="text-align: center">Rack <br> {{num1}}</h1>
                                            </th>
                                        </tr>
                                        {% for num2 in y %}
                                            <tr height="50px">
                                                <td style="text-align: center">{{num2}}</td>
                                                <td style="text-align: center" >
                                                {% for field in form %}
                                                    {% if field.name == num1 ~ '-' ~ num2 %}
                                                        {% if num1 == 1 %}
                                                            {% if 'UR' in item.assay.assay_name %}
                                                                {% if num2 not in non_blank_pos and num2 in [1, 2, 3, 4, 5, 6] %}
                                                                    <p1>Blank (Matrix)</p1>
                                                                {% endif %}
                                                            {% else %}
                                                                {% if num2 not in non_blank_pos and num2 in [1, 2, 3, 4, 5, 6, 7, 8] %}
                                                                    <p1>Blank (Matrix)</p1>
                                                                {% endif %}
                                                            {% endif %}
                                                            {% for check in rack_1_checks %}
                                                                {% if check[1] == num1 ~ '-' ~ num2 and check[2] is not none %}
                                                                    {{field(disabled='true', style='width: 100%')}}
                                                                {% elif check[1] == num1 ~ '-' ~ num2 %}
                                                                    {{field(style='width: 100%')}}
                                                                {% else %}
                                                                {% endif %}
                                                            {% endfor %}
                                                        {% elif num1 == 2 %}
                                                            {% for check in rack_2_checks %}
                                                                {% if check[1] == num1 ~ '-' ~ num2 and check[2] is not none %}
                                                                    {{field(disabled='true')}}
                                                                {% elif check[1] == num1 ~ '-' ~ num2 %}
                                                                    {{field(style='width: 100%')}}
                                                                {% else %}
                                                                {% endif %}
                                                            {% endfor %}
                                                        {% elif num1 == 3 %}
                                                            {% for check in rack_3_checks %}
                                                                {% if check[1] == num1 ~ '-' ~ num2 and check[2] is not none %}
                                                                    {{field(disabled='true', style='width: 100%')}}
                                                                {% elif check[1] == num1 ~ '-' ~ num2 %}
                                                                    {{field(style='width: 100%')}}
                                                                {% else %}
                                                                {% endif %}
                                                            {% endfor %}
                                                        {% elif num1 == 4 %}
                                                            {% for check in rack_4_checks %}
                                                                {% if check[1] == num1 ~ '-' ~ num2 and check[2] is not none %}
                                                                    {{field(disabled='true',style='width: 100%')}}
                                                                {% elif check[1] == num1 ~ '-' ~ num2 %}
                                                                    {{field(style='width: 100%')}}
                                                                {% else %}
                                                                {% endif %}
                                                            {% endfor %}
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </th>
                    {% endfor %}
                </tr>
            </tbody>
        </table>
        {% for field in form %}
            {% if '_date' in field.name %}
                {{field}}
            {% endif %}
        {% endfor %}
        <div class="container-fluid text-center" style="padding-top: 20px">
            <button type="submit" class="btn btn-primary" style="width: 10%">Submit</button>
            <a href="{{url_for('batches.view', item_id=item.id)}}" class="btn btn-secondary ml-1" style="width: 10%">Exit</a>
        </div>
    </form>
</div>



<script>

function getCurrentDateTime() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');

    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}

var x = [1, 2, 3, 4];
var y = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24];

// Source values
const sourceTrueValue = "tests: " + $('#source').data('value');
// Test values
const testInput = $("#testScan")[0];
const testTrueValue = "tests: " + $('#test').data('value');
let scanInputP1 = "";

// Attach change event handler to all input fields
$('input').change(function() {
    console.log('INPUT TRIGGERED')
    // Get the ID of the current input field
    const id = $(this).attr('id');

    // Extract x and y values from the ID (assuming format is p1x-y)
    const match = id.match(/(\d+)-(\d+)$/);
    if (!match) return; // Not a valid input field ID

    const xValue = match[1];
    const yValue = match[2];

    if ($(this).val() !== '' && $(this).val() !== undefined) {
        scanInputP1 = $(this).val().split(": ")[1];
    } else {
        scanInputP1 = "";
    }

    // Construct the ID of the corresponding source input field
    const sourceInputId = "source" + xValue + '-' + yValue;
    console.log('SOURCE ID', sourceInputId);
    let sourceInputP1 = $("#" + sourceInputId).attr('data-value');
    let qrCheck = $(this).val().split(": ")[0];

    if (qrCheck === 'qr_reference') {
        console.log('QR REF');
        $("#" + sourceInputId).removeClass('incorrect');
        $(this).removeClass('incorrect');
        $("#" + sourceInputId).addClass('correct');
        $(this).addClass('correct');

        const dateFieldId = id + '_date';
        const dateField = $("#" + dateFieldId);

        if (dateField.length > 0) {
            dateField.val(getCurrentDateTime());
            console.log('SUCCESS');
            console.log('DATE', dateField.val());
        } else {
            console.log('DATE FIELD NOT FOUND:', dateFieldId);
        }

    } else if (scanInputP1 !== '' && scanInputP1 === sourceInputP1) {
        $("#" + sourceInputId).removeClass('incorrect');
        $(this).removeClass('incorrect');
        $("#" + sourceInputId).addClass('correct');
        $(this).addClass('correct');

        const dateFieldId = id + '_date';
        const dateField = $("#" + dateFieldId);

        if (dateField.length > 0) {
            dateField.val(getCurrentDateTime());
            console.log('SUCCESS');
            console.log('DATE', dateField.val());
        } else {
            console.log('DATE FIELD NOT FOUND:', dateFieldId);
        }
    } else if (scanInputP1 === '') {
        $("#" + sourceInputId).removeClass('incorrect');
        $(this).removeClass('incorrect');
        $("#" + sourceInputId).removeClass('correct');
        $(this).removeClass('correct');
    } else {
        $("#" + sourceInputId).removeClass('correct');
        $(this).removeClass('correct');
        $("#" + sourceInputId).addClass('incorrect');
        $(this).addClass('incorrect');
    }

    console.log('SCAN P1', scanInputP1);
    console.log('SOURCE P1', sourceInputP1);

    // Repeat the same process for other scan and source input fields
});




</script>

<script>

    console.log('TEST', $('#source2-2').data('value'));

</script>

{% endblock %}
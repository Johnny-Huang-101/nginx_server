{% extends "base.html" %}
{% block content %}

<style>
.button {
 padding: 10px 24px
}
</style>

<div class = "container">
    <h1>Create Overview</h1>
    <form class="needs-validation" method="POST" novalidate="novalidate" enctype="multipart/form-data">
        {{form.hidden_tag()}}

        <div class="form-group">
            {{form.constituent_id.label(class='form-group')}}
            {{form.constituent_id(class='form-control'~status)}}
            {% if form.constituent_id.errors %}
                {% for error in form.constituent_id.errors %}
                    {{error}}
                {% endfor %}
            {% endif %}

            <div class="sort" style="font-size:0.9rem">
                <a class='clear' name="{{form.constituent_id.name}}" href="#!">Clear</a>
                    |
                    <a class='select_all' id='select_all' href="#!">Select All</a>
                    |
                    <span id="constituent_count"></span><span id="constituent_limit"></span>
            </div>
            <div class="table display">
                <div class="table-responsive">
                    <table class="display table-hover small nowrap" style="width:100%; border:1px solid #ced4da" id="constituents">
                      <thead>
                        <tr>
                            <th>Index</th>
                            <th>Standard/Solution lot</th>
                            <th>Standard/Solution type</th>
                            <th>Assay</th>
                            <th hidden>Standard/Solution ID</th>
                            <th>Retest Date</th>
                        </tr>
                        </thead>
                         <tbody>
                            {% for y in kwargs['items'] %}
                                {% set assay_list = y.assay.split(', ') %}
                              <tr class="rows">
                                <td class="clicking">{{loop.index - 1}}</td>
                                <th scope="row">
                                    <a href="{{url_for(table_name~'.view', item_id=item.id)}}">
                                        {{y.lot}}
                                    </a>
                                </th>
                                <td class="clicking">{{y.constituent.name}}</td>
                                <td class="clicking">
                                    {% for assay in assay_list %}
                                        {% for k, v in kwargs['assays'].items() %}
                                            {% if assay|int == k %}
                                                <a href="{{url_for('assays.view', item_id=k)}}" style="filter: brightness(1.2)">
                                                    <em>{{v}}</em>
                                                </a>
                                            {% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                </td>
                                <td class="clicking" hidden>{{y.id}}</td>
                                {% if y.retest_date == None %}
                                    <td></td>
                                {% else %}
                                    <td>{{y.retest_date.strftime('%m-%d-%Y')}}</td>
                                {% endif %}
                              </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class = "form-group">
            {{form.submit(class='btn btn-primary')}}
           <button type="button" class="btn btn-secondary" onclick="history.back()">Back</button>
        </div>
    </form>
</div>

<script>
    $(document).ready(function () {
        var table = $('#constituents').DataTable({
            dom: 'lt<i>rp',
            scrollX: true,
            "language": {
            "emptyTable": "Please select an assay to see available tests"
             },
            'pageLength': 100,
        });
    });
</script>

<script type=text/javascript>
    var dataOrder = [];
    var orderArr = []
    $("#constituents").on('click', 'tbody tr', function (e) {
        var table = $('#constituents').DataTable();
        var x = dataOrder.length +1
        var dataArr = [];
        $(this).toggleClass('table-active');
        $.each($("#constituents tr.table-active"),function(){ //get each tr which has selected class
            dataArr.push($(this).find('td').eq(3).text()); //find its first td and push the value
        });

        $('#constituent_id').val(dataArr);

        var rowIndex = $(this).find('td').eq(0).text();
        id = $(this).find('td').eq(1).text()
        });

</script>

<script type=text/javascript>
     $(function() {
        $('.clear').on('click', function() {
             $.each($("#constituents tbody tr"),function(){
                 $(this).removeClass('table-active');
             });
            var name = event.target.name;
            var select = document.getElementById(name);
            $(select).val("")
         });
    });
</script>

<script>
    $('#select_all').click(function() {
         $.each($("#constituents tbody tr"),function(){
             $(this).addClass('table-active');
         });

         var selected = [];
         var x = 1
         $.each($("#constituents tr.table-active"),function(){
            selected.push($(this).find('td').eq(0).text());
         });

        $('#constituent_selection').val(selected);
    });
</script>

{% endblock %}

{% extends "base.html" %}
{% block content %}

<style>

    .rows {

    line-height: 3px;
    min-height: 3px;
    height: 3px;
    }

    .directive-other {

    text-align:center;
    background: #f9ad40;
    width: 10%;
    margin: auto
    }

    .directive-HV {

    text-align:center;
    background: #fdfd96;
    width: 10%;
    margin: auto
    }

    .directive-2 {

    text-align:center;
    background: #ff66ff;
    width: 10%;
    margin: auto
    }

    .directive-5 {

    text-align:center;
    background: #0099ff;
    width: 10%;
    margin: auto
    }

    .correct {
        background-color: green
    }

    .incorrect{
        background-color: yellow
    }

    .selected {
    border: 2px solid blue;
    background-color: #e6f7ff;
}


</style>

<div class="container-fluid">
    <hr style="border-width:5px">
    <h1 align="center">
        Sequence Check
    </h1>
    <h3 align="center">
        Do not refresh this page!
    </h3>
    <hr style="border-width:5px">
</div>

<div>
    <form method="POST" id="form" novalidate="novalidate">
        {{form.hidden_tag()}}
        <table class="table-hover table-striped nowrap" width="100%">
            <thead>
                <tr>
                    <th colspan="14" style="text-align: center"><h1>Reference Tray</h1></th>
                </tr>
                <tr>
                    <th scope="col" colspan="2">Col 1</th>
                    <th scope="col" colspan="2">Col 2</th>
                    <th scope="col" colspan="2">Col 3</th>
                    <th scope="col" colspan="2">Col 4</th>
                    <th scope="col" colspan="2">Col 5</th>
                    <th scope="col" colspan="2">Col 6</th>
                    <th scope="col" colspan="2">Col 7</th>
                </tr>
            </thead>
            <tbody>
                {% for i in range(15) %}
                    <tr>
                        {% for column in columns %}
                            <td>{{locals[column][i]}}</td>
                            {% for x in unique_seq %}
                                {% if x[1] == locals[column][i] %}
                                    {% if x[1] in seq_check %}
                                        <td id="source{{locals[column][i]}}" data-value="{{x[2]}}" style="background-color: #A9A9A9">
                                            {{x[0]}}
                                        </td>
                                    {% elif x[1] in source_check %}
                                        <td id="source{{locals[column][i]}}" data-value="{{x[2]}}" style="background-color: #DCDCDC">
                                            {{x[0]}}
                                        </td>
                                    {% else %}
                                        <td id="source{{locals[column][i]}}" data-value="{{x[2]}}">
                                            {{x[0]}}
                                        </td>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            {% if locals[column][i] in empty_positions %}
                                <td></td>
                            {% endif %}
                        {% endfor %}
                        <td style="background-color: white"></td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <table class="table-hover table-striped nowrap" width="100%">
            <thead>
                <tr>
                    <th colspan="14" style="text-align: center"><h1>Scan Tray</h1></th>
                </tr>
                <tr>
                    <th scope="col">Col 1</th>
                    <th></th>
                    <th scope="col">Col 2</th>
                    <th></th>
                    <th scope="col">Col 3</th>
                    <th></th>
                    <th scope="col">Col 4</th>
                    <th></th>
                    <th scope="col">Col 5</th>
                    <th></th>
                    <th scope="col">Col 6</th>
                    <th></th>
                    <th scope="col">Col 7</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for i in range(15) %}
                    <tr>
                        {% set row_index = i %}
                        {% for column in columns %}
                            {% set col_index = loop.index0 %}
                            <td id="scan{{locals[column][i]}}">{{locals[column][i]}}</td>
                            {% for field in form %}
                                {% if 'samq' not in field.name %}
                                    {% if field.name[-2:] != 'te' %}
                                        {% if field.name | int == locals[column][i] %}
                                            {% if field.name | int in seq_check %}
                                                <td>{{field(disabled='true', style='background-color: #A9A9A9', tabindex=(col_index * 15 + (15 - row_index)))}}</td>
                                            {% elif field.name | int in source_check %}
                                                <td>{{field(disabled='true', style='background-color: #DCDCDC; border-color: #DCDCDC', tabindex=(col_index * 15 + (15 - row_index)))}}</td>
                                            {% else %}
                                                <td>{{field(tabindex=(col_index * 15 + (15 - row_index)))}}</td>
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if 'SAMQ' in item.assay.assay_name %}
            <div class="row">
                <div class="col">
                    <table class="table-hover table-striped nowrap" width="100%">
                        <thead>
                            <tr>
                                <th colspan="2" style="text-align: center"><h1>Control Rack Reference</h1></th>
                            </tr>
                            <tr>
                                <th scope="col">Col 1</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for i in range(0, 10) %}
                                {% set found = False %}
                                <tr>
                                    <td>{{20010 - i}}</td>
                                    {% for x in unique_seq %}
                                        {% if x[1] == locals['samq_column'][i] and x[1] in seq_check %}
                                            <td id="source{{20010-i}}" data-value="{{x[2]}}" style="background-color: #A9A9A9">
                                                {{x[0]}}
                                            </td>
                                            {% set found = True %}
                                        {% elif x[1] == locals['samq_column'][i] and x[1] in source_check %}
                                            <td id="source{{20010-i}}" style="background-color: #DCDCDC">{{x[0]}}</td>
                                        {% elif x[1] == locals['samq_column'][i] %}
                                            <td id="source{{20010-i}}" data-value="{{x[2]}}">
                                                {{x[0]}}
                                            </td>
                                        {% endif %}
                                    {% endfor %}
                                    {% if not found %}
                                        <td></td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="col">
                    <table class="table-hover table-striped nowrap" width="100%">
                        <thead>
                            <tr>
                                <th colspan="2" style="text-align: center"><h1>Control Rack Scan</h1></th>
                            </tr>
                            <tr>
                                <th scope="col">Col 1</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for i in range(1, 11) %}
                                <tr>
                                    <td>{{20011 - i}}</td>
                                    <td>
                                        {% for field in form %}
                                            {% if 'samq' in field.name %}
                                                {% if field.name[-2:] != 'te' %}
                                                    {% if 'samq_'~i == field.name %}
                                                        {% if 20011 - i in seq_check %}
                                                            {{field(disabled='true', style='background-color: #A9A9A9')}}
                                                        {% elif 20011 - i in source_check %}
                                                            {{field(disabled='true', style='background-color: #DCDCDC')}}
                                                        {% else %}
                                                            {{field(id=20011 - i)}}
                                                        {% endif %}
                                                    {% endif %}
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% for field in form %}
                {% if '_date' in field.name and 'samq' in field.name %}
                    {{field(id=((20011 - field.name.split('_')[1] | int) | string)~'_date')}}
                {% endif %}
            {% endfor %}
        {% endif %}
        {% for field in form %}
            {% if '_date' in field.name and 'samq' not in field.name %}
                {{field}}
            {% endif %}
        {% endfor %}
        <div class="container-fluid text-center" style="padding-top: 20px">
            {{form.submit(class='btn btn-primary ml-1')}}
            <a href="" class="btn btn-secondary ml-1" data-toggle="modal" data-target="#confirm_exit">Exit</a>
        </div>
    </form>
    <table id="refTable" class="table-hover table-striped nowrap" style="width: 100%; margin-top: 1%">
        <tbody>
            <tr data-specimen-check="Skipped">
                <th>Vial Position</th>
                <th>Test Name</th>
                <th>Comment</th>
            </tr>
            {% for entry in ref_table %}
                <tr>
                    <td>{{entry[0]}}</td>
                    <td>{{entry[1]}}</td>
                    <td>{{entry[2]}}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!--Confirm exit modal-->
<div class="modal" tabindex="-1" role="dialog" id="confirm_exit">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Exit Sequence Check</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>
                    Confirm you would like to Exit sequence check
                </p>
            </div>
            <div class="modal-footer">
                <a href="{{url_for('batches.view', item_id=item.id)}}" class="btn btn-primary">Confirm</a>
            </div>
        </div>
    </div>
</div>


<script>

function getCurrentDateTime() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');

    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}

// Test values
let scanInputP1 = "";

// Detect change in all input fields
$('input').change(function() {
    console.log('INPUT TRIGGERED');

    // Get the ID of the current input field
    const id = $(this).attr('id');
    console.log('Input field ID:', id);

    // Check if the id is undefined or null
    if (!id) {
        console.error('The ID of the input field is not defined');
        return;
    }

    // Extract numerical ID (assuming format is a number between 1 and 105)
    const match = id.match(/^(\d+)$/);
    if (!match) {
        console.error('The ID does not match the expected format:', id);
        return;
    }

    const numId = match[1];

    // Check if the input value is not empty or undefined
    if ($(this).val() !== '' && $(this).val() !== undefined) {
        scanInputP1 = $(this).val().split(": ")[1];
        qrCheck = $(this).val().split(": ")[0];
    } else {
        scanInputP1 = "";
    }

    // Construct the ID of the corresponding source input field in the Control Rack Reference table
    const sourceInputId = "source" + numId;
    console.log('SOURCE ID:', sourceInputId);
    let sourceInputP1 = $("#" + sourceInputId).attr('data-value');

    // If the QR code matches the expected reference
    if (qrCheck === 'qr_reference') {
        console.log('QR REF');
        $("#" + sourceInputId).removeClass('incorrect').addClass('correct');
        $(this).removeClass('incorrect').addClass('correct');

        // If there is a date field associated with the input field, update the date
        const dateFieldId = id + '_date';
        const dateField = $("#" + dateFieldId);
    } else if (scanInputP1 !== '' && scanInputP1 === sourceInputP1) {
        // If the scanned input matches the reference, mark as correct
        $("#" + sourceInputId).removeClass('incorrect').addClass('correct');
        $(this).removeClass('incorrect').addClass('correct');

        const dateFieldId = id + '_date';
        const dateField = $("#" + dateFieldId);

        if (dateField.length > 0) {
            dateField.val(getCurrentDateTime());
            console.log('SUCCESS');
            console.log('DATE:', dateField.val());
        } else {
            console.log('DATE FIELD NOT FOUND:', dateFieldId);
        }
    } else if (scanInputP1 === '') {
        // If the input is empty, reset the fields
        $("#" + sourceInputId).removeClass('incorrect correct');
        $(this).removeClass('incorrect correct');
    } else {
        // If the scanned input does not match, mark as incorrect
        $("#" + sourceInputId).removeClass('correct').addClass('incorrect');
        $(this).removeClass('correct').addClass('incorrect');
    }

    console.log('SCAN P1:', scanInputP1);
    console.log('SOURCE P1:', sourceInputP1);
});


$('input').focus(function() {
    const id = $(this).attr('id');
    const match = id.match(/^(\d+)$/);
    if (match) {
        const numId = match[1];
        const sourceInputId = "source" + numId;
        $("#" + sourceInputId).addClass('selected');
    }
}).blur(function() {
    const id = $(this).attr('id');
    const match = id.match(/^(\d+)$/);
    if (match) {
        const numId = match[1];
        const sourceInputId = "source" + numId;
        $("#" + sourceInputId).removeClass('selected');
    }
});



</script>

{% endblock %}

{% extends "base.html" %}
{% block content %}

{% set no_checks = tests | selectattr('transfer_check', 'equalto', None) | list%}
<style>

    .rows {

    line-height: 3px;
    min-height: 3px;
    height: 3px;
    }

    .directive-other {

    text-align:center;
    background: #f9ad40;
    width: 10%;
    margin: auto
    }

    .directive-HV {

    text-align:center;
    background: #fdfd96;
    width: 10%;
    margin: auto
    }

    .directive-2 {

    text-align:center;
    background: #ff66ff;
    width: 10%;
    margin: auto
    }

    .directive-5 {

    text-align:center;
    background: #0099ff;
    width: 10%;
    margin: auto
    }


</style>

<div class="container-fluid">
    <hr style="border-width:5px">
    <h1 align="center">
        Transfer Check
    </h1>
    <h3 align="center">
        Do not refresh this page!
    </h3>
    <hr style="border-width:5px">
</div>

<div>
    <form id="form" method="POST" novalidate="novalidate">
        {{form.hidden_tag()}}
        <table class="table-hover table-striped nowrap" style="width: 100%">
            <tbody id="table">
                <tr>
                    <th>Vial Position</th>
                    <th>Dilution</th>
                    <th>Directives</th>
                    <th>Extraction Vessel</th>
                    <th>Extraction Vessel Scan</th>
                </tr>

                <tr>
                    <td id="source_vial_position"></td>
                    <td id="type" data-value="transfer"></td>
                    <td></td>
                    <td id="source_name"></td>
                    <td id="sourceTest">{{form.source_specimen(id="sourceScan")}}</td>
                </tr>
                <tr>
                    <th>Vial Position</th>
                    <th>Dilution</th>
                    <th>Directives</th>
                    <th>Autosampler Vial</th>
                    <th>Autosampler Vial Scan</th>
                </tr>
            </tbody>
        </table>
        <div class="container-fluid text-center" style="padding-top: 20px">
            {% if no_checks | length > 0 %}
                <a class="btn btn-secondary ml-1" data-toggle="modal" data-target="#incomplete_check"
                style="width: 10%">Exit</a>
            {% else %}
                <a href="{{url_for('batches.view', item_id=batch.id)}}" class="btn btn-secondary ml-1" style="width: 10%">Exit</a>
            {% endif %}
        </div>
    </form>
</div>
<hr>
<div>
    <div>
        <button id="showAll">Show all</button>
        <button id="hideCompleted">Hide completed</button>
    </div>
    <table id="testsTable" class="table-hover table-striped nowrap" style="width: 100%">
        <tbody>
            <tr data-specimen-check="Skipped">
                <th>ID</th>
                <th>Vial Position</th>
                <th>Test Name</th>
                <th colspan="2" style="text-align: center">Source Check</th>
            </tr>
            {% for test in tests %}
                <tr id="testRow{{test.id}}" data-specimen-check="{{test.transfer_check}}">
                    <td>{{test.id}}</td>
                    <td>{{test.vial_position}}</td>
                    {% if test.__tablename__ == 'batch_constituents' %}
                        {% if test.constituent_id is not none %}
                            <td>{{test.constituent.constituent.name}} / {{test.constituent.lot}}</td>
                        {% elif test.reagent_id is not none %}
                            <td>{{test.reagent.name}} / {{test.reagent.lot}}</td>
                        {% else %}
                            <td></td>
                        {% endif %}
                    {% else %}
                        <td>{{test.test_name}}</td>
                    {% endif %}
                    {% if test.__tablename__ == 'batch_constituents' %}
                        <td style="text-align: right">
                            <a class="trigger-modal"
                               href="{{url_for(table_name~'.single_check', item_id=test.id, ref_table='batch_constituents', check_name='transfer')}}">
                                {{test.transfer_check}}
                            </a>
                        </td>
                    {% else %}
                        <td style="text-align: right">
                            <a class="trigger-modal"
                               href="{{url_for(table_name~'.single_check', item_id=test.id, ref_table='tests', check_name='transfer')}}">
                                {{test.transfer_check}}
                            </a>
                        </td>
                    {% endif %}
                    <td style="text-align: left">
                        <a class="trigger-modal"
                           href="{{url_for(table_name~'.single_check', item_id=test.id, ref_table='tests', check_name='transfer')}}">
                            {{test.transfer_checker.initials}}
                            {% if test.__tablename__ == 'batch_constituents' %}
                                {% if test.transfer_check_date is not none %}
                                    - {{test.transfer_check_date.strftime('%Y-%m-%d')}}
                                {% else %}
                                     / None
                                {% endif %}
                            {% else %}
                                {% if test.transfer_check_date is not none %}
                                     - {{test.transfer_check_date.strftime('%Y-%m-%d')}}
                                {% else %}
                                     / None
                                {% endif %}
                            {% endif %}
                        </a>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!--Items still needing check warning modal-->
<div class="modal" tabindex="-1" role="dialog" id="incomplete_check">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Incomplete Source Check</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" style="text-align: center">
          <p>There are still {{no_checks|length}} batch items requiring a transfer check</p>
          <p>Are you sure you would like to exit?</p>
          <a class="btn btn-secondary ml-1" href="{{url_for('batches.view', item_id=batch.id)}}">Confirm</a>
      </div>
    </div>
  </div>
</div>
<!--Checks will be cleared warning modal-->
<div class="modal" id="confirmModal" role="dialog" tabindex="-1">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Checks Will Be Cleared</h5>
                <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="text-align: center">
                <p>The relevant checks will be cleared and you will be redirected to the relevant check form</p>
                <p>Are you sure you would like to continue?</p>
            </div>
            <div class="modal-footer d-flex justify-content-center">
                <button class="btn btn-primary" id="confirmButton" type="button">Yes</button>
                <button class="btn btn-secondary" data-dismiss="modal" type="button">No</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function(){
    var targetUrl = '';

    // When any anchor tag with class 'trigger-modal' is clicked
    $('a.trigger-modal').on('click', function(e){
        e.preventDefault(); // Prevent the default action (following the link)

        // Get the href attribute of the clicked anchor tag
        targetUrl = $(this).attr('href');

        // Show the modal
        $('#confirmModal').modal('show');
    });

    // When the confirm button in the modal is clicked
    $('#confirmButton').on('click', function(){
        // Redirect to the URL stored in targetUrl
        window.location.href = targetUrl;
    });
});

</script>

<script>
    $(document).ready(function () {
        const sourceInput = $('#sourceScan');
        sourceInput.focus()
        sourceInput.on('input', function () {
            const value = $(this).val().toLowerCase().trim();
    
            if (value.startsWith('tests:')) {
                console.log('Detected "tests:" - waiting 600ms to begin...');
    
                // Wait 500ms before triggering blur + focus logic
                setTimeout(() => {
                    // Step 1: blur the field
                    sourceInput.blur();
                    console.log('Blurred sourceScan');
    
                    // Step 2: try focusing testScan1
                    waitAndFocus();
                }, 600);
            }
        });
    
        function waitAndFocus(retries = 5) {
            const testInput = $('#testScan1');
    
            if (testInput.length && testInput.is(':visible') && !testInput.prop('disabled')) {
                testInput.focus();
                console.log('Focused testScan1');
            } else if (retries > 0) {
                console.log('testScan1 not ready, retrying...');
                setTimeout(() => waitAndFocus(retries - 1), 200);
            } else {
                console.log('testScan1 still not available after retries');
            }
        }
    });
    </script>

<script src="/static/js/batches.js"></script>

{% endblock %}

{% extends "base.html" %}
{% block content %}

<style>

    .rows {

    line-height: 3px;
    min-height: 3px;
    height: 3px;
    }

    .directive-other {

    text-align:center;
    background: #f9ad40;
    width: 10%;
    margin: auto
    }

    .directive-HV {

    text-align:center;
    background: #fdfd96;
    width: 10%;
    margin: auto
    }

    .directive-2 {

    text-align:center;
    background: #ff66ff;
    width: 10%;
    margin: auto
    }

    .directive-5 {

    text-align:center;
    background: #0099ff;
    width: 10%;
    margin: auto
    }

</style>

<div class="container-fluid">
    <hr style="border-width:5px">
    <h1 align="center">
        Specimen Check
    </h1>
    <h3 align="center">
        Do not refresh this page!
    </h3>
    <hr style="border-width:5px">
</div>

<div>
    <form method="POST" id="form" novalidate="novalidate">
        {{form.hidden_tag()}}
        <table class="table-hover table-striped nowrap" style="width: 100%">
            <tbody>
                <tr>
                    <th>Test Number</th>
                    <th>Source Specimen</th>
                    <th>Source Specimen Scan</th>
                </tr>
                <tr>
                    <td>
                        {% if item.test_name[-2] == '0' %}
                            {{item.test_name[-1]}}
                        {% else %}
                            {{item.test_name[-2:]}}
                        {% endif %}
                    </td>
                    <td id="source" data-value="{{item.specimen.id}}">{{item.case.case_number}} {{ item.specimen.accession_number }} [{{item.specimen.type.code}}] <h10 style="color: #cccccc">{{item.specimen.id}}</h10></td>
                    <td id="sourceTest">{{form.source_specimen(id="sourceScan")}}</td>
                </tr>
                <tr>
                    <th>Test Number</th>
                    {% if 'REF' in assay %}
                        <th>Sendout Specimen</th>
                        <th>Sendout Scan</th>
                    {% else %}
                        <th>Test Specimen</th>
                        <th>Test Specimen Scan</th>
                    {% endif %}
                </tr>
                <tr>
                    <td>
                        {% if item.test_name[-2] == '0' %}
                            {{item.test_name[-1]}}
                        {% else %}
                            {{item.test_name[-2:]}}
                        {% endif %}
                    </td>
                    {% if 'REF' in assay %}
                        <td id="test1" data-value="{{item.gcet_specimen_check}}">{{item.test_name}}  <h10 style="color: #cccccc">{{item.gcet_specimen_check}}</h10></td>
                    {% else %}
                        <td id="test1" data-value="{{item.id}}">{{item.test_name}}  <h10 style="color: #cccccc">{{item.id}}</h10></td>
                    {% endif %}
                    <td id="testTest1">{{form.test_specimen(id="testScan1")}}</td>
                </tr>
            {% if 'GCET' in assay %}
                <tr>
                    <th>Test Number</th>
                    <th>Test Specimen</th>
                    <th>Test Specimen Scan</th>
                </tr>
                <tr>
                    <td>
                        {% if item.test_name[-2] == '0' %}
                            {{item.test_name[-1]}}
                        {% else %}
                            {{item.test_name[-2:]}}
                        {% endif %}
                    </td>
                    <td id="test2" data-value="{{item.id}}">{{item.test_name}}  <h10 style="color: #cccccc">{{item.id}}</h10></td>
                    <td id="testTest2">{{form.test_specimen_2(id="testScan2")}}</td>
                </tr>
            {% endif %}
            </tbody>
        </table>
        <div class="container-fluid text-center" style="padding-top: 20px">
            <a href="{{url_for('batches.view', item_id=item.batch_id)}}" class="btn btn-secondary ml-1" style="width: 10%">Exit</a>
        </div>
    </form>
</div>

<script>
$(document).ready(function () {
    // Source values
    const sourceInput = $("#sourceScan").get(0);
    const sourceTrueValue = "specimens: " + $('#source').data('value');

    // Test values
    let testTrueValue1 = $('#test1').data('value'); // Default value

    function checkTestScanValue() {
        const testScan1Value = $('#testScan1').val();
        if (testScan1Value.includes(':')) {
            testTrueValue1 = "tests: " + $('#test1').data('value'); // Update with prefixed value if it includes ':'
            console.log('COLON INCL.');
        } else {
            testTrueValue1 = $('#test1').data('value'); // Reset to default value
            console.log('NO COLON');
        }
    }

    // Attach the change event handler to all input elements
    $('input').change(function() {
        console.log('CHANGE');
        checkTestScanValue();
    });

    // Add an event listener for the source input if it exists
    if (sourceInput) {
        $(sourceInput).on('input', function() {
            const inputValue = sourceInput.value;
            if (inputValue !== sourceTrueValue) {
                $('#sourceScan').removeClass('table-success').addClass('table-danger');
            } else {
                $('#sourceScan').removeClass('table-danger').addClass('table-success');
            }
            console.log("Source Input Change - TRUE VALUE:", sourceTrueValue);
            console.log("Source Input Change - Current Value:", inputValue);
            checkAndSubmitForm(); // Check and submit the form after each input
        });
    } else {
        console.log("sourceInput does not exist.");
    }

    // Add an event listener for test input1 if it exists
    const testInput1 = $("#testScan1").get(0);
    if (testInput1) {
        $(testInput1).on('input', function() {
            const inputValue = testInput1.value;
            const expectedValue = inputValue.includes(':') ? "tests: " + $('#test1').data('value') : $('#test1').data('value');
            if (inputValue !== expectedValue.toString()) {
                $('#testScan1').removeClass('table-success').addClass('table-danger');
            } else {
                $('#testScan1').removeClass('table-danger').addClass('table-success');
            }
            console.log("Test Input1 Change - TRUE VALUE:", expectedValue);
            console.log("Test Input1 Change - Current Value:", inputValue);
            checkAndSubmitForm(); // Check and submit the form after each input
        });
    } else {
        console.log("testInput1 does not exist.");
    }

    // Add an event listener for test input2 if it exists
    const testInput2 = $("#testScan2").get(0); // This element might not exist
    if (testInput2) {
        const testTrueValue2 = "tests: " + $('#test2').data('value');
        $(testInput2).on('input', function() {
            const inputValue = testInput2.value;
            if (inputValue !== testTrueValue2) {
                $('#testScan2').removeClass('table-success').addClass('table-danger');
            } else {
                $('#testScan2').removeClass('table-danger').addClass('table-success');
            }
            console.log("Test Input2 Change - TRUE VALUE:", testTrueValue2);
            console.log("Test Input2 Change - Current Value:", inputValue);
            checkAndSubmitForm(); // Check and submit the form after each input
        });
    } else {
        console.log("testInput2 does not exist.");
    }

    // Function to check inputs and submit the form if conditions are met
    function checkAndSubmitForm() {
        const testValue1 = testInput1 ? testInput1.value : null;
        const qrReferenceRegex = /^qr_reference: \d+$/;
        const sourceValue = sourceInput ? sourceInput.value : null;
        console.log("Checking form submission conditions...");
        console.log("sourceValue:", sourceValue, "sourceTrueValue:", sourceTrueValue);
        console.log("testValue1:", testValue1, "testTrueValue1:", testTrueValue1);

        if ((sourceValue === sourceTrueValue && testValue1 === testTrueValue1.toString()) ||
            qrReferenceRegex.test(sourceValue) || qrReferenceRegex.test(testValue1)) {
            console.log("Conditions met. Submitting the form...");
            $('#form').submit();
        }
    }
});
</script>

{% endblock %}

{% extends "base.html" %}
{% block content %}

{% set no_checks = tests | selectattr('specimen_check', 'equalto', None) | list%}
<style>

    .rows {

    line-height: 3px;
    min-height: 3px;
    height: 3px;
    }

    .directive-other {

    text-align:center;
    background: yellow;
    width: 10%;
    margin: auto
    }

    .directive-2 {

    text-align:center;
    background: #ff66ff;
    width: 10%;
    margin: auto
    }

    .directive-5 {

    text-align:center;
    background: #0099ff;
    width: 10%;
    margin: auto
    }


</style>

<div class="container-fluid">
    <hr style="border-width:5px">
    <h1 align="center">
        Source Check
    </h1>
    <h3 align="center">
        Do not refresh this page!
    </h3>
    <hr style="border-width:5px">
</div>

<div>
    <form id="form" method="POST" novalidate="novalidate">
        {{form.hidden_tag()}}
        <table class="table-hover table-striped nowrap" style="width: 100%">
            <tbody id="table">
                <tr>
                    <th>Vial Position</th>
                    <th>Dilution</th>
                    <th>Source Specimen</th>
                    <th>Source Specimen Scan</th>
                </tr>

                <tr>
                    <td id="source_vial_position"></td>
                    <td></td>
                    <td id="source_name"></td>
                    <td id="sourceTest">{{form.source_specimen(id="sourceScan")}}</td>
                </tr>

                <tr>
                    <th>Vial Position</th>
                    <th>Dilution</th>
                    <th>Extraction Vessel</th>
                    <th>Extraction Vessel Scan</th>
                </tr>
            </tbody>
        </table>
        <div class="container-fluid text-center" style="padding-top: 20px">
            <button class="btn btn-secondary mr-1" style="width: 10%" type="submit">Skip</button>
            <a class="btn btn-secondary ml-1" data-toggle="modal" data-target="#incomplete_check"
               style="width: 10%">Exit</a>
        </div>
    </form>
</div>
<hr>
<div>
    <div>
        <button id="showAll">Show all</button>
        <button id="hideCompleted">Hide completed</button>
    </div>
    <table id="testsTable" class="table-hover table-striped nowrap" style="width: 100%">
        <tbody>
            <tr data-specimen-check="Skipped">
                <th>ID</th>
                <th>Vial Position</th>
                <th>Test Name</th>
                <th colspan="2" style="text-align: center">Source Check</th>
            </tr>
            {% for test in tests %}
                <tr id="testRow{{test.id}}" data-specimen-check="{{test.specimen_check}}">
                    <td>{{test.id}}</td>
                    <td>{{test.vial_position}}</td>
                    {% if test.__tablename__ == 'batch_constituents' %}
                        {% if test.constituent_id is not none %}
                            <td>{{test.constituent.constituent.name}} / {{test.constituent.lot}}</td>
                        {% elif test.reagent_id is not none %}
                            <td>{{test.reagent.name}} / {{test.reagent.lot}}</td>
                        {% else %}
                            <td></td>
                        {% endif %}
                    {% else %}
                        <td>{{test.test_name}}</td>
                    {% endif %}
                    <td style="text-align: right">
                        <a class="trigger-modal"
                           href="{{url_for(table_name~'.single_check', item_id=test.id, ref_table='tests', check_name='source')}}">
                            {{test.specimen_check}}
                        </a>
                    </td>
                    <td style="text-align: left">
                        <a class="trigger-modal"
                           href="{{url_for(table_name~'.single_check', item_id=test.id, ref_table='tests', check_name='source')}}">
                            {{test.specimen_checker.initials}}
                            {% if test.__tablename__ == 'batch_constituents' %}
                                {% if test.specimen_check_date is not none %}
                                    - {{test.specimen_check_date.strftime('%Y-%m-%d')}}
                                {% else %}
                                     / None
                                {% endif %}
                            {% else %}
                                {% if test.checked_date is not none %}
                                     - {{test.checked_date.strftime('%Y-%m-%d')}}
                                {% else %}
                                     / None
                                {% endif %}
                            {% endif %}
                        </a>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!--Items still needing check warning modal-->
<div class="modal" tabindex="-1" role="dialog" id="incomplete_check">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Incomplete Source Check</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" style="text-align: center">
          <p>There are still {{no_checks|length}} batch items requiring a source check</p>
          <p>Are you sure you would like to exit?</p>
          <a class="btn btn-secondary ml-1" href="{{url_for('batches.view', item_id=item.id)}}">Confirm</a>
      </div>
    </div>
  </div>
</div>
<!--Checks will be cleared warning modal-->
<div class="modal" id="confirmModal" role="dialog" tabindex="-1">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Checks Will Be Cleared</h5>
                <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="text-align: center">
                <p>The relevant checks will be cleared and you will be redirected to the relevant check form</p>
                <p>Are you sure you would like to continue?</p>
            </div>
            <div class="modal-footer d-flex justify-content-center">
                <button class="btn btn-primary" id="confirmButton" type="button">Yes</button>
                <button class="btn btn-secondary" data-dismiss="modal" type="button">No</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function(){
    var targetUrl = '';

    // When any anchor tag with class 'trigger-modal' is clicked
    $('a.trigger-modal').on('click', function(e){
        e.preventDefault(); // Prevent the default action (following the link)

        // Get the href attribute of the clicked anchor tag
        targetUrl = $(this).attr('href');

        // Show the modal
        $('#confirmModal').modal('show');
    });

    // When the confirm button in the modal is clicked
    $('#confirmButton').on('click', function(){
        // Redirect to the URL stored in targetUrl
        window.location.href = targetUrl;
    });
});

</script>



<script src="/static/js/batches.js"></script>

{% endblock %}
